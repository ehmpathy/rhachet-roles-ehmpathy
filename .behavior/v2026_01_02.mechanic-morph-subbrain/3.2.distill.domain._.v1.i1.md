# distillation: declastruct domain for morph mcp integration

## usecases

### usecase.1 = mechanic boots with morph mcp configured

```
given('mechanic role init runs')
  when('[t0] init.claude.sh executes during session start')
    then('morph mcp server is configured in settings.json')
      sothat('claude code can use edit_file tool for fast applies')
    then('MORPH_API_KEY env var is checked')
      sothat('user knows if they need to configure their api key')
  when('[t1] MORPH_API_KEY is not set')
    then('warning is emitted to stderr')
      sothat('user is aware morph features wont work until key is configured')
    then('init continues without blocking')
      sothat('other mechanic features still work')
  when('[t2] MORPH_API_KEY is set')
    then('mcp server config includes the key reference')
      sothat('morph can authenticate api calls')
```

### usecase.2 = morph mcp server is idempotently findserted

```
given('settings.json already has morph mcp configured')
  when('[t0] init.claude.mcp.sh runs again')
    then('no duplicate mcp server entry is created')
      sothat('settings.json remains clean')
    then('existing config is preserved')
      sothat('manual customizations are not lost')
```

### usecase.3 = mechanic-managed mcp servers can be safely removed

```
given('settings.json has mcp servers from multiple sources')
  when('[t0] init.claude.mcp.cleanup.sh runs')
    then('only mcp servers with author="repo=ehmpathy/role=mechanic" are considered')
      sothat('user-added mcp servers are never touched')
    then('stale mechanic mcp servers are removed')
      sothat('deprecated integrations dont linger')
  when('[t1] user wants to uninstall mechanic mcp servers')
    then('all servers with mechanic author can be identified and removed')
      sothat('clean uninstall is possible')
```

---

## envisioned contract

### `init.claude.mcp.sh`

```bash
#!/usr/bin/env bash
######################################################################
# .what = configure morph mcp server in claude settings
#
# .why  = morph fast-apply enables 12x faster code edits at 98% accuracy
#         with 50% fewer tokens vs claude's native search-replace.
#
#         this script:
#           ‚Ä¢ checks if MORPH_API_KEY env var is set
#           ‚Ä¢ warns if not (non-blocking)
#           ‚Ä¢ findserts morph mcp server config into settings.json
#
# guarantee:
#   ‚úî creates .claude/settings.json if missing
#   ‚úî creates .mcpServers if missing
#   ‚úî idempotent: no-op if morph already configured
#   ‚úî non-blocking on missing api key (just warns)
#   ‚úî fail-fast on errors
######################################################################

# input: none (reads from env and settings.json)
# output: modified settings.json with mcpServers.filesystem-with-morph
# side-effects:
#   - warns to stderr if MORPH_API_KEY not set
#   - modifies .claude/settings.json
```

### invocation from `init.claude.sh`

```bash
# initialize mcp servers (morph fast-apply)
"$SCRIPT_DIR/init.claude.mcp.sh"
echo ""
```

---

## domain.objects

### `ClaudeSettings` (existing, extended)

```ts
/**
 * .what = claude code settings configuration file
 * .why = centralized config for hooks, permissions, and mcp servers
 */
interface ClaudeSettings {
  hooks?: {
    SessionStart?: HookMatcherGroup[];
    PreToolUse?: HookMatcherGroup[];
    PostToolUse?: HookMatcherGroup[];
    // ... other hook types
  };
  permissions?: {
    allow?: string[];
    deny?: string[];
    ask?: string[];
  };
  mcpServers?: Record<string, McpServerConfig>;  // ‚Üê NEW
}
```

### `McpServerConfig` (NEW)

```ts
/**
 * .what = configuration for an mcp server in claude settings
 * .why = enables external tools to integrate with claude code via mcp protocol
 */
interface McpServerConfig {
  /**
   * command to launch the mcp server
   */
  command: string;

  /**
   * environment variables to pass to the server
   */
  env?: Record<string, string>;

  /**
   * command line arguments
   */
  args?: string[];

  /**
   * author identifier for tracking who added this server
   * enables safe cleanup of mechanic-managed servers without touching user-added ones
   * follows same pattern as hooks: "repo=ehmpathy/role=mechanic"
   */
  author?: string;
}
```

### `MorphMcpServerConfig` (NEW - literal, specialized shape)

```ts
/**
 * .what = morph-specific mcp server configuration
 * .why = morph fast-apply enables 12x faster code edits with 98% accuracy
 */
interface MorphMcpServerConfig extends McpServerConfig {
  command: 'npx -y @morphllm/morphmcp';
  env: {
    /**
     * morph api key for authentication
     * note: references env var, not literal value
     */
    MORPH_API_KEY: string;

    /**
     * which tools to enable
     * - "edit_file" = fast-apply only (recommended)
     * - "edit_file,warpgrep_codebase_search" = fast-apply + semantic search
     */
    ENABLED_TOOLS?: 'edit_file' | 'edit_file,warpgrep_codebase_search';
  };
  args: [];
  author: 'repo=ehmpathy/role=mechanic';
}
```

---

## domain.operations

### `init.claude.mcp.sh` (NEW)

| attribute | value |
|-----------|-------|
| **type** | setCreate/setUpdate (findsert) |
| **input** | env:`MORPH_API_KEY` |
| **output** | modified `settings.json` |
| **idempotent** | ‚úî yes |
| **blocking** | ‚úò no (warns on missing key) |

**algorithm:**
```
1. check if MORPH_API_KEY env var is set
   - if not: emit warning, continue
2. read existing settings.json (or create {})
3. check if mcpServers.filesystem-with-morph exists
   - if yes: no-op, exit success
4. findsert morph mcp config into mcpServers
5. write settings.json atomically
```

### `init.claude.mcp.findsert.sh` (NEW, optional)

could be generalized like `init.claude.hooks.findsert.sh` for mcp servers:

| attribute | value |
|-----------|-------|
| **type** | setCreate (findsert) |
| **input** | `--name`, `--command`, `--env`, `--args` |
| **output** | modified `settings.json.mcpServers` |
| **idempotent** | ‚úî yes |

**decision:** for mvp, inline the logic in `init.claude.mcp.sh`. extract to findsert utility if more mcp servers are added later.

### `init.claude.mcp.cleanup.sh` (NEW)

| attribute | value |
|-----------|-------|
| **type** | setDelete (selective) |
| **input** | settings.json |
| **output** | modified `settings.json` with stale servers removed |
| **idempotent** | ‚úî yes |

**algorithm:**
```
1. read existing settings.json
2. enumerate mcpServers with author="repo=ehmpathy/role=mechanic"
3. for each mechanic-authored server:
   - check if it's still in the "desired" list (hardcoded in script)
   - if not in desired list: remove it
4. write settings.json atomically (if changes made)
```

**purpose:** enables clean removal of deprecated mcp integrations without touching user-added servers.

---

## access.daos

### `daoClaudeSettings` (conceptual, shell-based)

since this is a shell-script domain, the "dao" is implemented as jq operations:

```bash
# getOne: read settings.json
settings=$(cat "$SETTINGS_FILE" 2>/dev/null || echo '{}')

# set: write settings.json (atomic)
echo "$updated_settings" > "$SETTINGS_FILE.tmp"
mv "$SETTINGS_FILE.tmp" "$SETTINGS_FILE"

# findsert mcp server: add if not exists
jq --argjson server "$MCP_CONFIG" '
  .mcpServers //= {} |
  .mcpServers["filesystem-with-morph"] //= $server
' "$SETTINGS_FILE"
```

---

## target output structure

after `init.claude.mcp.sh` runs, `settings.json` should contain:

```json
{
  "hooks": { ... },
  "permissions": { ... },
  "mcpServers": {
    "filesystem-with-morph": {
      "command": "npx -y @morphllm/morphmcp",
      "env": {
        "MORPH_API_KEY": "${MORPH_API_KEY}"
      },
      "args": [],
      "author": "repo=ehmpathy/role=mechanic"
    }
  }
}
```

**note:** the `author` field enables:
- identifying which mcp servers were added by mechanic
- safe cleanup of deprecated servers without touching user-added ones
- consistent pattern with hooks (which also have `author` field)

---

## dependency tree (updated)

```
init.claude.sh
‚îú‚îÄ‚îÄ init.claude.hooks.sh
‚îÇ   ‚îú‚îÄ‚îÄ init.claude.hooks.cleanup.sh
‚îÇ   ‚îî‚îÄ‚îÄ init.claude.hooks.findsert.sh (√óN hooks)
‚îú‚îÄ‚îÄ init.claude.permissions.sh
‚îî‚îÄ‚îÄ init.claude.mcp.sh                    ‚Üê NEW
    ‚îú‚îÄ‚îÄ init.claude.mcp.cleanup.sh        ‚Üê NEW (removes stale mechanic servers)
    ‚îú‚îÄ‚îÄ checkMorphApiKeyEnv               ‚Üê inline check
    ‚îî‚îÄ‚îÄ findsertMcpServer                 ‚Üê inline jq operation (with author field)
```

---

## implementation notes

### env var reference vs literal value

the config should use `${MORPH_API_KEY}` as a reference to the environment variable, not the literal value. this:
- avoids storing secrets in settings.json
- allows users to manage key via their shell profile
- matches the pattern used by `claude mcp add` command

### non-blocking warning pattern

```bash
if [[ -z "${MORPH_API_KEY:-}" ]]; then
  echo "‚ö†Ô∏è  MORPH_API_KEY not set - morph fast-apply will not work" >&2
  echo "   get your key at: https://morphllm.com" >&2
  echo "   then: export MORPH_API_KEY=your-key-here" >&2
  echo ""
fi
```

### idempotency check

```bash
# check if morph already configured
if jq -e '.mcpServers["filesystem-with-morph"]' "$SETTINGS_FILE" >/dev/null 2>&1; then
  echo "üëå morph mcp already configured"
  exit 0
fi
```

### author tracking pattern

follows the same pattern as hooks for consistency:

```bash
AUTHOR="repo=ehmpathy/role=mechanic"

# findsert with author field
jq --arg author "$AUTHOR" '
  .mcpServers //= {} |
  .mcpServers["filesystem-with-morph"] //= {
    "command": "npx -y @morphllm/morphmcp",
    "env": { "MORPH_API_KEY": "${MORPH_API_KEY}" },
    "args": [],
    "author": $author
  }
' "$SETTINGS_FILE"
```

### cleanup by author

```bash
# remove all mechanic-authored mcp servers not in desired list
DESIRED_SERVERS='["filesystem-with-morph"]'
AUTHOR="repo=ehmpathy/role=mechanic"

jq --arg author "$AUTHOR" --argjson desired "$DESIRED_SERVERS" '
  .mcpServers //= {} |
  .mcpServers |= with_entries(
    select(
      .value.author != $author or        # keep non-mechanic servers
      (.key | IN($desired[]))             # keep desired mechanic servers
    )
  )
' "$SETTINGS_FILE"
```

---

## benefits recap

| metric | without morph | with morph | improvement |
|--------|---------------|------------|-------------|
| edit time | 20-50s | 0.25s | **12x faster** |
| accuracy | 86% | 98% | **+12%** |
| tokens/edit | 1,200-3,000 | 600 | **50% fewer** |
| monthly cost (1k edits) | $48-72 | $39 | **45% cheaper** |
