# roadmap: morph mcp integration

## execution checklist

---

### step.1: create `init.claude.mcp.cleanup.sh`

**depends on:** nothing (foundational)

**file:** `src/domain.roles/mechanic/inits/init.claude.mcp.cleanup.sh`

#### acceptance criteria

```
given('settings.json does not exist')
  when('[t0] init.claude.mcp.cleanup.sh runs')
    then('script exits silently with code 0')

given('settings.json exists but has no mcpServers')
  when('[t0] init.claude.mcp.cleanup.sh runs')
    then('script exits silently with code 0')
    then('settings.json is unchanged')

given('settings.json has user-added mcp server (no author field)')
  when('[t0] init.claude.mcp.cleanup.sh runs')
    then('user server is preserved')
    then('settings.json is unchanged')

given('settings.json has stale mechanic-authored server')
  when('[t0] init.claude.mcp.cleanup.sh runs')
    then('stale server is removed')
    then('output shows "ðŸ§¹ remove stale mcp servers"')

given('settings.json has current mechanic server "filesystem-with-morph"')
  when('[t0] init.claude.mcp.cleanup.sh runs')
    then('server is preserved (in desired list)')
    then('settings.json is unchanged')
```

#### verification commands

```bash
# setup test fixtures
cd /tmp && mkdir -p test-mcp && cd test-mcp
mkdir -p .claude
SCRIPT="path/to/init.claude.mcp.cleanup.sh"

# test.1: no settings file
rm -f .claude/settings.json
bash "$SCRIPT"
echo "exit code: $?"  # expect: 0

# test.2: no mcpServers
echo '{"hooks":{}}' > .claude/settings.json
bash "$SCRIPT"
jq . .claude/settings.json  # expect: unchanged

# test.3: user-added server preserved
echo '{"mcpServers":{"my-server":{"command":"foo"}}}' > .claude/settings.json
bash "$SCRIPT"
jq '.mcpServers["my-server"]' .claude/settings.json  # expect: exists

# test.4: stale mechanic server removed
echo '{"mcpServers":{"old-server":{"command":"foo","author":"repo=ehmpathy/role=mechanic"}}}' > .claude/settings.json
bash "$SCRIPT"  # expect: "ðŸ§¹ remove stale mcp servers"
jq '.mcpServers["old-server"]' .claude/settings.json  # expect: null

# test.5: current mechanic server preserved
echo '{"mcpServers":{"filesystem-with-morph":{"command":"npx","author":"repo=ehmpathy/role=mechanic"}}}' > .claude/settings.json
bash "$SCRIPT"
jq '.mcpServers["filesystem-with-morph"]' .claude/settings.json  # expect: exists
```

- [ ] **done:** script created
- [ ] **done:** test.1 passes (no settings file)
- [ ] **done:** test.2 passes (no mcpServers)
- [ ] **done:** test.3 passes (user server preserved)
- [ ] **done:** test.4 passes (stale server removed)
- [ ] **done:** test.5 passes (current server preserved)

---

### step.2: create `init.claude.mcp.sh`

**depends on:** step.1 (calls cleanup script)

**file:** `src/domain.roles/mechanic/inits/init.claude.mcp.sh`

#### acceptance criteria

```
given('settings.json does not exist')
  when('[t0] init.claude.mcp.sh runs')
    then('settings.json is created')
    then('mcpServers.filesystem-with-morph exists')
    then('author field is "repo=ehmpathy/role=mechanic"')

given('settings.json exists but no mcpServers')
  when('[t0] init.claude.mcp.sh runs')
    then('mcpServers is created')
    then('filesystem-with-morph is added')

given('filesystem-with-morph already exists')
  when('[t0] init.claude.mcp.sh runs')
    then('output shows "ðŸ‘Œ mcp servers already bound"')
    then('settings.json is unchanged')

given('MORPH_API_KEY env var is not set')
  when('[t0] init.claude.mcp.sh runs')
    then('warning is emitted: "MORPH_API_KEY not set"')
    then('config is still added (non-blocking)')
    then('script exits with code 0')

given('MORPH_API_KEY env var is set')
  when('[t0] init.claude.mcp.sh runs')
    then('no warning is emitted')
    then('output shows "ðŸ”— bind mcp servers"')
```

#### verification commands

```bash
# setup
cd /tmp && mkdir -p test-mcp && cd test-mcp
mkdir -p .claude
SCRIPT="path/to/init.claude.mcp.sh"

# test.1: creates from scratch
rm -f .claude/settings.json
unset MORPH_API_KEY
bash "$SCRIPT"
jq '.mcpServers["filesystem-with-morph"].author' .claude/settings.json
# expect: "repo=ehmpathy/role=mechanic"

# test.2: idempotent (second run)
bash "$SCRIPT" 2>&1 | grep -q "already bound"
echo "idempotent: $?"  # expect: 0

# test.3: warning when no api key
rm -f .claude/settings.json
unset MORPH_API_KEY
bash "$SCRIPT" 2>&1 | grep -q "MORPH_API_KEY not set"
echo "warns: $?"  # expect: 0

# test.4: no warning when api key set
rm -f .claude/settings.json
export MORPH_API_KEY="test-key"
bash "$SCRIPT" 2>&1 | grep -q "MORPH_API_KEY not set"
echo "no warn: $?"  # expect: 1 (grep fails = no warning)

# test.5: verify full structure
jq '.mcpServers["filesystem-with-morph"]' .claude/settings.json
# expect:
# {
#   "command": "npx -y @morphllm/morphmcp",
#   "env": { "MORPH_API_KEY": "${MORPH_API_KEY}" },
#   "args": [],
#   "author": "repo=ehmpathy/role=mechanic"
# }
```

- [ ] **done:** script created
- [ ] **done:** test.1 passes (creates from scratch)
- [ ] **done:** test.2 passes (idempotent)
- [ ] **done:** test.3 passes (warns when no key)
- [ ] **done:** test.4 passes (no warn when key set)
- [ ] **done:** test.5 passes (full structure correct)

---

### step.3: modify `init.claude.sh`

**depends on:** step.2 (script must exist to call)

**file:** `src/domain.roles/mechanic/inits/init.claude.sh`

#### acceptance criteria

```
given('init.claude.sh is executed')
  when('[t0] full initialization runs')
    then('init.claude.hooks.sh is called')
    then('init.claude.permissions.sh is called')
    then('init.claude.mcp.sh is called')
    then('output ends with "ðŸ‘Œ claude config ready"')

given('all sub-scripts succeed')
  when('[t0] init.claude.sh completes')
    then('settings.json has hooks configured')
    then('settings.json has permissions configured')
    then('settings.json has mcpServers configured')
```

#### verification commands

```bash
# run full init in test repo
cd path/to/test-repo
rm -f .claude/settings.json

# run init
./node_modules/.bin/rhachet roles init --repo ehmpathy --role mechanic --command init.claude

# verify all sections present
jq 'keys' .claude/settings.json
# expect: ["hooks", "mcpServers", "permissions"]

# verify mcp specifically
jq '.mcpServers["filesystem-with-morph"].command' .claude/settings.json
# expect: "npx -y @morphllm/morphmcp"
```

- [ ] **done:** init.claude.sh modified
- [ ] **done:** mcp init is called after permissions
- [ ] **done:** full init produces valid settings.json

---

### step.4: modify `init.claude.permissions.jsonc`

**depends on:** nothing (independent change)

**file:** `src/domain.roles/mechanic/inits/init.claude.permissions.jsonc`

#### acceptance criteria

```
given('permissions.jsonc is updated')
  when('[t0] permissions are applied')
    then('WebFetch(domain:docs.morphllm.com) is in allow list')
    then('WebFetch(domain:www.morphllm.com) is in allow list')
```

#### verification commands

```bash
# verify jsonc is valid (strip comments, parse)
grep -v '^\s*//' init.claude.permissions.jsonc | sed 's|//.*||' | jq .

# verify morph domains present
grep -v '^\s*//' init.claude.permissions.jsonc | sed 's|//.*||' | jq '.permissions.allow[]' | grep morphllm
# expect: two lines with morphllm domains
```

- [ ] **done:** permissions.jsonc modified
- [ ] **done:** docs.morphllm.com in allow list
- [ ] **done:** www.morphllm.com in allow list

---

### step.5: build and deploy

**depends on:** steps 1-4 (all files ready)

#### acceptance criteria

```
given('all source files are updated')
  when('[t0] npm run build executes')
    then('build succeeds with exit code 0')
    then('dist/domain.roles/mechanic/inits/ contains new scripts')

given('build is complete')
  when('[t0] new claude session starts')
    then('morph mcp server is configured in settings.json')
    then('session start output shows mcp binding')
```

#### verification commands

```bash
# build
npm run build
echo "build: $?"  # expect: 0

# verify dist files
ls -la dist/domain.roles/mechanic/inits/init.claude.mcp*.sh
# expect: two files (mcp.sh, mcp.cleanup.sh)

# start fresh session and check
rm -f .claude/settings.json
# (start new claude session, observe output)

# verify settings after session
jq '.mcpServers' .claude/settings.json
# expect: filesystem-with-morph configured
```

- [ ] **done:** npm run build succeeds
- [ ] **done:** dist files present
- [ ] **done:** new session configures mcp

---

### step.6: end-to-end verification

**depends on:** step.5 (deployment complete)

#### acceptance criteria

```
given('morph mcp is configured and MORPH_API_KEY is set')
  when('[t0] /mcp command is run in claude code')
    then('filesystem-with-morph server is listed')

given('morph mcp is active')
  when('[t0] /tools command is run')
    then('edit_file tool is available')

given('edit_file tool is available')
  when('[t0] claude uses edit_file for code changes')
    then('edits are applied via morph fast-apply')
    then('edits complete faster than native str_replace')
```

#### verification commands

```bash
# in claude code session:
/mcp
# expect: filesystem-with-morph listed

/tools
# expect: edit_file from morph listed

# manual test: ask claude to make a small edit
# observe: should use edit_file tool if morph is working
```

- [ ] **done:** /mcp shows morph server
- [ ] **done:** /tools shows edit_file
- [ ] **done:** claude uses edit_file for edits

---

## dependency graph

```
step.1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
(cleanup.sh)                â”‚
                            â–¼
step.4 â”€â”€â”€â”€â”€â”€â”€â–º step.2 â”€â”€â”€â–º step.3 â”€â”€â”€â–º step.5 â”€â”€â”€â–º step.6
(permissions)   (mcp.sh)    (init.sh)   (build)     (e2e)
```

---

## rollback checkpoints

| after step | rollback action |
|------------|-----------------|
| step.1 | delete `init.claude.mcp.cleanup.sh` |
| step.2 | delete `init.claude.mcp.sh` and cleanup.sh |
| step.3 | revert init.claude.sh changes |
| step.4 | revert permissions.jsonc changes |
| step.5 | `jq 'del(.mcpServers)' .claude/settings.json > tmp && mv tmp .claude/settings.json` |

---

## success criteria summary

| criteria | verification |
|----------|--------------|
| morph mcp configured on session start | `jq '.mcpServers["filesystem-with-morph"]' .claude/settings.json` returns config |
| api key warning when not set | session output contains "MORPH_API_KEY not set" |
| api key warning absent when set | session output does not contain warning |
| idempotent initialization | second run shows "already bound" |
| author tracking for cleanup | config has `"author": "repo=ehmpathy/role=mechanic"` |
| user servers preserved | manually-added servers remain after init |
