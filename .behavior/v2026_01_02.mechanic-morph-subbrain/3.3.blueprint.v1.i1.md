# blueprint: morph mcp integration for mechanic role

## overview

integrate morph fast-apply mcp server into the mechanic role's claude initialization, following the existing patterns for hooks and permissions.

**benefit:** 12x faster code edits, 98% accuracy, 50% fewer tokens

---

## files to create

### 1. `src/domain.roles/mechanic/inits/init.claude.mcp.sh`

main script to configure morph mcp server in settings.json

```bash
#!/usr/bin/env bash
######################################################################
# .what = configure mcp servers in claude settings
#
# .why  = mcp servers extend claude code with external tool integrations.
#         the mechanic role configures:
#           â€¢ morph fast-apply: 12x faster code edits at 98% accuracy
#
#         this script:
#           â€¢ runs cleanup to remove stale mechanic-managed servers
#           â€¢ checks if MORPH_API_KEY env var is set (warns if not)
#           â€¢ findserts morph mcp server config into settings.json
#
# .how  = uses jq to merge mcp server configs into .claude/settings.json
#
# guarantee:
#   âœ” creates .claude/settings.json if missing
#   âœ” creates .mcpServers if missing
#   âœ” idempotent: no-op if already configured
#   âœ” non-blocking on missing api key (just warns)
#   âœ” tracks author for safe cleanup
#   âœ” fail-fast on errors
######################################################################

set -euo pipefail

trap 'echo "âŒ init.claude.mcp.sh failed at line $LINENO" >&2' ERR

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$PWD"
SETTINGS_FILE="$PROJECT_ROOT/.claude/settings.json"
AUTHOR="repo=ehmpathy/role=mechanic"

# collect results for tree output
MCP_BOUND=()
MCP_EXISTING=()
MCP_WARNED=()

# first, cleanup any stale mcp servers
"$SCRIPT_DIR/init.claude.mcp.cleanup.sh"

# ensure .claude directory and settings file exist
mkdir -p "$(dirname "$SETTINGS_FILE")"
if [[ ! -f "$SETTINGS_FILE" ]]; then
  echo "{}" > "$SETTINGS_FILE"
fi

#----------------------------------------------------------------------
# morph fast-apply mcp server
#----------------------------------------------------------------------

# check if morph already configured
if jq -e '.mcpServers["filesystem-with-morph"]' "$SETTINGS_FILE" >/dev/null 2>&1; then
  MCP_EXISTING+=("filesystem-with-morph")
else
  # check for api key (non-blocking warning)
  if [[ -z "${MORPH_API_KEY:-}" ]]; then
    MCP_WARNED+=("MORPH_API_KEY not set - morph fast-apply disabled")
    MCP_WARNED+=("  get key: https://morphllm.com")
    MCP_WARNED+=("  then: export MORPH_API_KEY=your-key")
  fi

  # findsert morph mcp server (even without key - user can add later)
  jq --arg author "$AUTHOR" '
    .mcpServers //= {} |
    .mcpServers["filesystem-with-morph"] = {
      "command": "npx -y @morphllm/morphmcp",
      "env": {
        "MORPH_API_KEY": "${MORPH_API_KEY}"
      },
      "args": [],
      "author": $author
    }
  ' "$SETTINGS_FILE" > "$SETTINGS_FILE.tmp"

  mv "$SETTINGS_FILE.tmp" "$SETTINGS_FILE"
  MCP_BOUND+=("filesystem-with-morph")
fi

#----------------------------------------------------------------------
# output results
#----------------------------------------------------------------------

# print warnings first
if [[ ${#MCP_WARNED[@]} -gt 0 ]]; then
  echo "âš ï¸  warnings"
  for warn in "${MCP_WARNED[@]}"; do
    echo "   $warn"
  done
  echo ""
fi

# print newly bound servers
if [[ ${#MCP_BOUND[@]} -gt 0 ]]; then
  echo "ðŸ”— bind mcp servers"
  for i in "${!MCP_BOUND[@]}"; do
    if [[ $((i + 1)) -eq ${#MCP_BOUND[@]} ]]; then
      echo "   â””â”€â”€ ${MCP_BOUND[$i]}"
    else
      echo "   â”œâ”€â”€ ${MCP_BOUND[$i]}"
    fi
  done
  echo ""
fi

# print existing servers
if [[ ${#MCP_EXISTING[@]} -gt 0 ]]; then
  echo "ðŸ‘Œ mcp servers already bound"
  for i in "${!MCP_EXISTING[@]}"; do
    if [[ $((i + 1)) -eq ${#MCP_EXISTING[@]} ]]; then
      echo "   â””â”€â”€ ${MCP_EXISTING[$i]}"
    else
      echo "   â”œâ”€â”€ ${MCP_EXISTING[$i]}"
    fi
  done
  echo ""
fi
```

### 2. `src/domain.roles/mechanic/inits/init.claude.mcp.cleanup.sh`

cleanup script to remove stale mechanic-managed mcp servers

```bash
#!/usr/bin/env bash
######################################################################
# .what = cleanup stale mcp servers from claude settings
#
# .why  = when mcp server integrations are deprecated, the corresponding
#         entries in .claude/settings.json should be cleaned up.
#         only removes servers with author="repo=ehmpathy/role=mechanic".
#
# .how  = reads settings.json, finds mcp servers authored by mechanic,
#         removes any not in the current desired list.
#
# usage:
#   init.claude.mcp.cleanup.sh
#
# guarantee:
#   âœ” only removes mechanic-authored servers
#   âœ” preserves user-added mcp servers
#   âœ” idempotent: safe to rerun
#   âœ” no-op if no stale servers found
######################################################################

set -euo pipefail

trap 'echo "âŒ init.claude.mcp.cleanup.sh failed at line $LINENO" >&2' ERR

PROJECT_ROOT="$PWD"
SETTINGS_FILE="$PROJECT_ROOT/.claude/settings.json"
AUTHOR="repo=ehmpathy/role=mechanic"

# current desired mcp servers managed by mechanic
DESIRED_SERVERS='["filesystem-with-morph"]'

# exit if no settings file
if [[ ! -f "$SETTINGS_FILE" ]]; then
  exit 0
fi

# exit if no mcpServers section
if ! jq -e '.mcpServers' "$SETTINGS_FILE" >/dev/null 2>&1; then
  exit 0
fi

# find stale mechanic-authored servers
STALE_SERVERS=$(jq -r --arg author "$AUTHOR" --argjson desired "$DESIRED_SERVERS" '
  .mcpServers // {} | to_entries[]
  | select(.value.author == $author)
  | select(.key | IN($desired[]) | not)
  | .key
' "$SETTINGS_FILE")

# exit if no stale servers
if [[ -z "$STALE_SERVERS" ]]; then
  exit 0
fi

# remove stale servers
jq --arg author "$AUTHOR" --argjson desired "$DESIRED_SERVERS" '
  .mcpServers |= with_entries(
    select(
      .value.author != $author or
      (.key | IN($desired[]))
    )
  )
' "$SETTINGS_FILE" > "$SETTINGS_FILE.tmp"

# check if changes were made
if diff -q "$SETTINGS_FILE" "$SETTINGS_FILE.tmp" >/dev/null 2>&1; then
  rm "$SETTINGS_FILE.tmp"
  exit 0
fi

# report removals
echo "ðŸ§¹ remove stale mcp servers"
STALE_ARRAY=()
while IFS= read -r server; do
  [[ -n "$server" ]] && STALE_ARRAY+=("$server")
done <<< "$STALE_SERVERS"

TOTAL=${#STALE_ARRAY[@]}
for i in "${!STALE_ARRAY[@]}"; do
  if [[ $((i + 1)) -eq $TOTAL ]]; then
    echo "   â””â”€â”€ ${STALE_ARRAY[$i]}"
  else
    echo "   â”œâ”€â”€ ${STALE_ARRAY[$i]}"
  fi
done
echo ""

# atomic replace
mv "$SETTINGS_FILE.tmp" "$SETTINGS_FILE"
```

---

## files to modify

### 3. `src/domain.roles/mechanic/inits/init.claude.sh`

add mcp initialization to the main orchestrator

```diff
 # initialize permissions
 "$SCRIPT_DIR/init.claude.permissions.sh"
 echo ""

+# initialize mcp servers
+"$SCRIPT_DIR/init.claude.mcp.sh"
+echo ""
+
 echo "ðŸ‘Œ claude config ready"
```

### 4. `src/domain.roles/mechanic/inits/init.claude.permissions.jsonc`

add permission for morph mcp tools (optional - claude may auto-allow mcp tools)

```diff
       // apikey sources
-      "Bash(source .agent/repo=.this/role=any/skills/use.apikeys.sh)"
+      "Bash(source .agent/repo=.this/role=any/skills/use.apikeys.sh)",
+
+      // morph mcp domains (for documentation fetching)
+      "WebFetch(domain:docs.morphllm.com)",
+      "WebFetch(domain:www.morphllm.com)"
     ]
```

---

## implementation order

```
step.1: create init.claude.mcp.cleanup.sh
        â”œâ”€â”€ test: empty settings.json â†’ no-op
        â”œâ”€â”€ test: no mcpServers â†’ no-op
        â”œâ”€â”€ test: user-added server â†’ preserved
        â””â”€â”€ test: stale mechanic server â†’ removed

step.2: create init.claude.mcp.sh
        â”œâ”€â”€ test: empty settings.json â†’ creates mcpServers
        â”œâ”€â”€ test: existing morph â†’ no-op
        â”œâ”€â”€ test: no MORPH_API_KEY â†’ warns, still adds config
        â””â”€â”€ test: MORPH_API_KEY set â†’ adds config silently

step.3: modify init.claude.sh
        â””â”€â”€ add call to init.claude.mcp.sh

step.4: modify init.claude.permissions.jsonc
        â””â”€â”€ add morph documentation domains to allow list

step.5: rebuild and test
        â”œâ”€â”€ npm run build
        â””â”€â”€ verify settings.json has mcpServers after session start
```

---

## expected output after implementation

### settings.json structure

```json
{
  "hooks": {
    "SessionStart": [...],
    "PreToolUse": [...]
  },
  "permissions": {
    "allow": [...],
    "deny": [...],
    "ask": [...]
  },
  "mcpServers": {
    "filesystem-with-morph": {
      "command": "npx -y @morphllm/morphmcp",
      "env": {
        "MORPH_API_KEY": "${MORPH_API_KEY}"
      },
      "args": [],
      "author": "repo=ehmpathy/role=mechanic"
    }
  }
}
```

### session start output (with api key)

```
ðŸ”§ init claude config for mechanic role...

ðŸ“¦ backed up settings to: .claude/settings.2026-01-02T12-00-00Z.bak.json

ðŸ‘Œ hooks already bound
   â”œâ”€â”€ sessionstart.notify-permissions
   â”œâ”€â”€ sessionstart.boot.this
   â”œâ”€â”€ sessionstart.boot.mechanic
   â”œâ”€â”€ pretooluse.forbid-stderr-redirect
   â””â”€â”€ pretooluse.check-permissions

ðŸ‘Œ mechanic permissions already configured
   .claude/settings.json

ðŸ”— bind mcp servers
   â””â”€â”€ filesystem-with-morph

ðŸ‘Œ claude config ready
```

### session start output (without api key)

```
ðŸ”§ init claude config for mechanic role...

...

âš ï¸  warnings
   MORPH_API_KEY not set - morph fast-apply disabled
     get key: https://morphllm.com
     then: export MORPH_API_KEY=your-key

ðŸ”— bind mcp servers
   â””â”€â”€ filesystem-with-morph

ðŸ‘Œ claude config ready
```

---

## testing checklist

### unit tests (manual verification)

- [ ] `init.claude.mcp.cleanup.sh` preserves user-added mcp servers
- [ ] `init.claude.mcp.cleanup.sh` removes stale mechanic servers
- [ ] `init.claude.mcp.sh` creates mcpServers on empty settings
- [ ] `init.claude.mcp.sh` is idempotent (no-op on second run)
- [ ] `init.claude.mcp.sh` warns when MORPH_API_KEY not set
- [ ] `init.claude.mcp.sh` includes author field for tracking

### integration tests

- [ ] full init.claude.sh produces valid settings.json
- [ ] claude code session starts with morph mcp available
- [ ] `/mcp` command shows filesystem-with-morph server
- [ ] `/tools` command shows edit_file tool (when key is set)

---

## rollback plan

if issues arise:

1. remove mcp call from `init.claude.sh`
2. delete `init.claude.mcp.sh` and `init.claude.mcp.cleanup.sh`
3. manually remove `mcpServers` from settings.json:
   ```bash
   jq 'del(.mcpServers)' .claude/settings.json > tmp && mv tmp .claude/settings.json
   ```

---

## future enhancements

- [ ] add `init.claude.mcp.findsert.sh` utility (if more mcp servers needed)
- [ ] add warpgrep tool enablement option
- [ ] add CLAUDE.md instruction for preferring edit_file over str_replace
