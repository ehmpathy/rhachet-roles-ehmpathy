# domain research: mechanic role + morph fast codediff integration

## wish summary

> mechanic role hooks booted claude/code w/ morph-fast codediff support
> to maximize the speed and minimize the cost of code-diffs w/ claude-code
> as part of the install of the settings.json operation, it should verify that the api key for morph is set and warns if it is not

---

## domain objects

### entities

#### `ClaudeSettings`
- **primary**: file path (`~/.claude/settings.json` or `.claude/settings.json`)
- **unique**: n/a (singleton per scope)
- **attributes**:
  - `hooks`: object containing hook configurations by event type
  - `permissions`: object with `allow`, `deny`, `ask` arrays
  - `mcpServers`: object containing MCP server configurations [1]
- **relationships**: decorated by `MorphMcpServer`

#### `MorphMcpServer`
- **primary**: server name key (e.g., `"filesystem-with-morph"`)
- **unique**: name within mcpServers object
- **attributes**:
  - `command`: `"npx -y @morphllm/morphmcp"` [2]
  - `env.MORPH_API_KEY`: required api key credential
  - `env.ENABLED_TOOLS`: `"edit_file"` or `"edit_file,warpgrep_codebase_search"` [2]
  - `env.ALL_TOOLS`: `"true"` or `"false"` [2]
  - `args`: optional command arguments array
- **relationships**: child of `ClaudeSettings.mcpServers`

#### `MorphApiKey`
- **primary**: the key string itself
- **unique**: per morph account
- **attributes**:
  - `value`: string credential
  - `source`: environment variable `MORPH_API_KEY`
- **relationships**: referenced by `MorphMcpServer.env`

### literals

#### `HookConfig`
- **attributes**:
  - `type`: `"command"`
  - `command`: shell command string
  - `timeout`: number (seconds)
  - `author`: string identifier (e.g., `"repo=ehmpathy/role=mechanic"`)

#### `McpToolConfig`
- **attributes**:
  - `name`: tool identifier (e.g., `"edit_file"`, `"warpgrep_codebase_search"`)
  - `enabled`: boolean

### events

#### `SessionStart`
- **when**: claude code session begins
- **triggers**: hook execution for role bootup
- **current behavior**: boots `.this` role, then `ehmpathy/mechanic` role

#### `PreToolUse`
- **when**: before any tool execution
- **triggers**: permission checks, stderr redirect validation

---

## domain operations

### existing operations (in `src/domain.roles/mechanic/inits/`)

| operation | type | description |
|-----------|------|-------------|
| `init.claude.sh` | setCreate/setUpdate | orchestrates hooks + permissions init |
| `init.claude.hooks.sh` | setCreate/setUpdate | binds all mechanic hooks to settings |
| `init.claude.hooks.findsert.sh` | setCreate | idempotent hook insertion |
| `init.claude.hooks.cleanup.sh` | setDelete | removes stale hooks |
| `init.claude.permissions.sh` | setCreate/setUpdate | configures permission rules |

### new operations needed

| operation | type | description |
|-----------|------|-------------|
| `init.claude.mcp.sh` | setCreate/setUpdate | configure morph mcp server in settings |
| `checkMorphApiKey` | getOne | verify MORPH_API_KEY env var is set |
| `warnMorphApiKeyMissing` | n/a | emit warning if api key not configured |

---

## domain relationships

### treestruct of decoration

```
ClaudeSettings
├── hooks
│   ├── SessionStart[]
│   │   └── HookConfig
│   └── PreToolUse[]
│       └── HookConfig
├── permissions
│   ├── allow[]
│   ├── deny[]
│   └── ask[]
└── mcpServers                    ← NEW
    └── filesystem-with-morph     ← NEW
        └── MorphMcpServer        ← NEW
```

### dependencies

```
init.claude.sh
├── init.claude.hooks.sh
│   ├── init.claude.hooks.cleanup.sh
│   └── init.claude.hooks.findsert.sh (×N hooks)
├── init.claude.permissions.sh
└── init.claude.mcp.sh            ← NEW
    └── checkMorphApiKey          ← NEW
```

---

## how domain objects compose to support wish

### configuration flow

1. **SessionStart hook** triggers `init.claude.sh`
2. `init.claude.sh` calls sub-initializers:
   - `init.claude.hooks.sh` → binds role bootup hooks
   - `init.claude.permissions.sh` → sets permission rules
   - `init.claude.mcp.sh` → **NEW**: configures morph mcp server
3. `init.claude.mcp.sh` performs:
   - check if `MORPH_API_KEY` environment variable is set
   - if not set: emit warning message, continue (non-blocking)
   - if set: findsert morph mcp server config into `settings.json.mcpServers`

### settings.json target structure

```json
{
  "hooks": { ... },
  "permissions": { ... },
  "mcpServers": {
    "filesystem-with-morph": {
      "env": {
        "MORPH_API_KEY": "${MORPH_API_KEY}"
      },
      "command": "npx -y @morphllm/morphmcp",
      "args": []
    }
  }
}
```

---

## speed and cost benefits

### speed comparison [3][4]

| approach | time per edit | first-pass accuracy |
|----------|---------------|---------------------|
| morph fast apply | **0.25 seconds** | **98%** |
| claude search-replace (pass 1) | 20 seconds | 86% |
| claude search-replace (pass 2) | 50+ seconds total | 92% |

> "morph fast apply completes edits in 0.25 seconds with 98% first-pass accuracy, while search-replace takes 20+ seconds for first pass (86% accuracy) and often requires a second pass taking 50+ seconds total." [3]

**speed advantage**: ~12x faster for reliable merges

### token efficiency [3][4]

| approach | tokens per edit |
|----------|-----------------|
| morph | ~600 tokens (single pass) |
| claude search-replace | ~1,200 tokens (pass 1) + ~1,800 tokens (pass 2) |

> "morph uses direct semantic merging with ~50% fewer tokens. most teams see immediate improvements in first-pass accuracy (98% vs 86%) and reduced token costs (~50% savings)." [4]

**token advantage**: ~50% fewer tokens

### cost analysis (per 1000 edits) [3]

| approach | output tokens | cost per edit | monthly cost | success rate |
|----------|---------------|---------------|--------------|--------------|
| morph + claude | 600 | $0.039 | **$39** | 98% |
| search-replace (1 pass) | 1,200 | $0.048 | $48 | 84% |
| search-replace (2-3 passes) | 1,800 | $0.072 | $72 | 89% |

**cost advantage**: ~45% cost reduction vs single-pass search-replace, ~85% reduction when accounting for retry loops

### morph api pricing [5]

| model | input cost | output cost |
|-------|------------|-------------|
| morph-v3-fast | $0.80/M tokens | $1.20/M tokens |
| morph-v3-large | $0.90/M tokens | $1.90/M tokens |

> "morph v3 hits 10,500+ tokens per second. that's faster than their previous model and results in ~35% faster end-to-end task completion compared to search-and-replace approaches." [6]

### processing speed [6][7]

- **morph v3**: 10,500+ tokens/second
- **response latency**: ~50ms
- **standard llm tools**: 50-100 tokens/second

> "morph's fast apply model api provides intelligent code merging at 4500+ tokens/second with 99.2% accuracy." [7]

---

## citations

1. [MCP Integration - Morph Documentation](https://docs.morphllm.com/mcpquickstart) - "morph provides model context protocol (mcp) integration enabling fast file editing through claude code"

2. [Claude Code - Morph Documentation](https://docs.morphllm.com/guides/claude-code) - "install the morph mcp using this command: `claude mcp add filesystem-with-morph -e MORPH_API_KEY={user.morphApiKey} -- npx -y @morphllm/morphmcp`"

3. [Morph Fast Apply vs Search-Replace: 2025 First-Pass Accuracy Comparison](https://www.morphllm.com/comparisons/morph-vs-claude-search-replace) - "morph fast apply completes edits in 0.25 seconds with 98% first-pass accuracy"

4. [Morph - Tools That Improve Coding Agents](https://www.morphllm.com/) - "morph uses direct semantic merging with ~50% fewer tokens"

5. [Morph Morph-V3-Fast Pricing](https://pricepertoken.com/pricing-page/model/morph-morph-v3-fast) - "morph-v3-fast costs $0.000800 per 1,000 input tokens and $0.001200 per 1,000 output tokens"

6. [Morph Gets Faster: 10,500+ Tokens Per Second](https://www.morphllm.com/blog/morph-gets-faster) - "morph v3 hits 10,500+ tokens per second"

7. [Fast Apply Models: AI Code Editing in 2025](https://www.morphllm.com/fast-apply-model) - "morph's fast apply model api provides intelligent code merging at 4500+ tokens/second with 99.2% accuracy"

8. [A developer's guide to settings.json in Claude Code (2025)](https://www.eesel.ai/blog/settings-json-claude-code) - "hooks can be configured in `~/.claude/settings.json`"

9. [Claude Code Model Configuration](https://support.claude.com/en/articles/11940350-claude-code-model-configuration) - "CLAUDE_CODE_SUBAGENT_MODEL specifies model for subagents"
