# roadmap: brief.compress with bhrain/sitrep

## phase 0: extract shared module + rename llmlingua engine

**depends on:** none

**read before:**
- `.behavior/v2026_02_10.brief-compressor-sitrep/3.3.blueprint.v1.i1.md` (blueprint)
- `.behavior/v2026_02_10.brief-compressor-sitrep/3.1.research.patterns._.code.prod.v1.i1.md` (prod patterns)

**checklist:**
- [ ] create `compress.shared.ts` — extract `countTokens` from `compress.ts`
- [ ] rename `compress.ts` → `compress.via.llmlingua.ts`
- [ ] update `compress.via.llmlingua.ts` to import `countTokens` from `compress.shared.ts`
- [ ] update `compress.via.llmlingua.ts` parseArgs to accept `--from` and `--via`
- [ ] update `brief.compress.sh` to invoke `compress.via.llmlingua.js` instead of `compress.js`
- [ ] npm run build

**acceptance criteria:**
- [ ] `compress.shared.ts` exports `countTokens` and compiles
- [ ] `compress.via.llmlingua.ts` imports from shared, compiles, and produces identical json output
- [ ] `brief.compress.sh` invokes the renamed engine and produces same output as before

**verify:**
```sh
npm run build
npx rhachet run --skill brief.compress --from src/domain.roles/mechanic/briefs/practices/code.prod/evolvable.procedures/rule.require.dependency-injection.md.pt1.md --via llmlingua/v2@tinybert --mode plan
```

---

## phase 1: update shell orchestrator

**depends on:** phase 0

**read before:**
- `.behavior/v2026_02_10.brief-compressor-sitrep/3.3.blueprint.v1.i1.md` (blueprint — shell codepaths)
- `.behavior/v2026_02_10.brief-compressor-sitrep/2.2.criteria.blackbox.matrix.md` (matrix.1, matrix.2)

**checklist:**
- [ ] add `--via` flag with `$press@$brain` parse logic
  - [ ] split on `@` → left = press, right = brain
  - [ ] if no `@` and contains `/` → treat as press, apply default brain per press
  - [ ] if starts with `@` → failfast: "expected format $press@$brain"
  - [ ] if no `@` and no `/` → failfast: "expected format $press@$brain"
- [ ] add `--from` flag for input path/glob
- [ ] add `--into` flag for explicit output path
  - [ ] failfast if `--into` with glob `--from`
- [ ] route by press family prefix:
  - [ ] `llmlingua/*` → invoke `compress.via.llmlingua.js`
  - [ ] `bhrain/*` → invoke `compress.via.bhrain.js`
- [ ] update engine invocation to pass `--from` and `--via` to ts engines
- [ ] update stats display to show full `$press@$brain`
- [ ] support `--into` write path (write to `$output` instead of `$path.min`)

**acceptance criteria:**
- [ ] `--via llmlingua/v2@tinybert --from $path` invokes llmlingua engine and works end to end
- [ ] `--via bhrain/sitrep --from $path` would invoke bhrain engine (engine not built yet — ok to fail at engine invocation)
- [ ] `--via @xai/grok/code-fast-1` failfasts with clear message
- [ ] `--via tinybert` (bare) failfasts with clear message
- [ ] `--into $output --from "$glob"` failfasts with clear message

**verify:**
```sh
npm run build
# llmlingua via new flags
npx rhachet run --skill brief.compress --from src/domain.roles/mechanic/briefs/practices/code.prod/evolvable.procedures/rule.require.dependency-injection.md.pt1.md --via llmlingua/v2@tinybert --mode plan
# error paths
npx rhachet run --skill brief.compress --from test.md --via @xai/grok/code-fast-1
npx rhachet run --skill brief.compress --from test.md --via tinybert
```

---

## phase 2: create bhrain engine

**depends on:** phase 0 (shared module)

**read before:**
- `.behavior/v2026_02_10.brief-compressor-sitrep/3.3.blueprint.v1.i1.md` (blueprint — bhrain codepaths, contracts)
- `.behavior/v2026_02_10.brief-compressor-sitrep/3.1.research.patterns._.code.prod.v1.i1.md` (prod patterns — brain.ask, resilience wrappers)
- `.behavior/v2026_02_10.brief-compressor-sitrep/3.1.research.domain.terms.v1.i1.md` (domain terms — sitrep, press, brain)

**checklist:**
- [ ] create `compress.via.bhrain.ts`
- [ ] define sitrep template constant
  - [ ] instruct brain to distill via sitrep methodology
  - [ ] instruct to preserve: rule statements, positive examples, enforcement levels, code blocks
  - [ ] instruct to output valid markdown
  - [ ] instruct: no filler, no repetition, decision-critical only
- [ ] implement `compressViaBhrain` procedure
  - [ ] `genContextBrain({ choice: { atom: brainSlug } })`
  - [ ] read source brief content
  - [ ] count tokens before via `countTokens` from shared
  - [ ] `brain.atom.ask` with sitrep template + source content, schema: `z.string()`
  - [ ] wrap with `withRetry` (3 attempts) + `withTimeout` (60 seconds)
  - [ ] count tokens after
  - [ ] compute ratio
  - [ ] return `{ compressed, tokensBefore, tokensAfter, ratio }`
- [ ] implement `parseArgs` — `--from`, `--via`, `--json`
- [ ] implement `main` — same json output contract as llmlingua
- [ ] catch `BrainChoiceNotFoundError` and failfast with clear message
- [ ] npm run build

**acceptance criteria:**
- [ ] `compress.via.bhrain.ts` compiles
- [ ] json output matches contract: `{ compressed, tokensBefore, tokensAfter, ratio }`
- [ ] `tokensAfter < tokensBefore` for a non-trivial brief
- [ ] compressed output is valid markdown
- [ ] compressed output preserves rule statements and code blocks from source

**verify:**
```sh
npm run build
# direct engine invocation (requires XAI_API_KEY)
node dist/domain.roles/mechanic/skills/brief.compress/compress.via.bhrain.js \
  --from src/domain.roles/mechanic/briefs/practices/code.prod/evolvable.procedures/rule.require.dependency-injection.md.pt1.md \
  --via xai/grok/code-fast-1 \
  --json
```

---

## phase 3: end-to-end integration

**depends on:** phase 1 + phase 2

**read before:**
- `.behavior/v2026_02_10.brief-compressor-sitrep/2.1.criteria.blackbox.md` (blackbox criteria — all usecases)
- `.behavior/v2026_02_10.brief-compressor-sitrep/2.2.criteria.blackbox.matrix.md` (coverage matrix)

**checklist:**
- [ ] verify full flow: `--from $path --via bhrain/sitrep@xai/grok/code-fast-1 --mode plan`
- [ ] verify full flow: `--from $path --via bhrain/sitrep@xai/grok/code-fast-1 --mode apply`
- [ ] verify `--into $output` writes to explicit path
- [ ] verify `--from "$glob" --mode apply` produces collocated `.min` per file
- [ ] verify default brain: `--via bhrain/sitrep` (no `@`) defaults to `xai/grok/code-fast-1`
- [ ] verify both presses produce `.min` at same path with same metrics shape
- [ ] verify error paths: no api key, no files matched, `--into` with glob

**acceptance criteria:**
- [ ] all usecases from blackbox criteria (2.1) pass manually
- [ ] all matrix rows from coverage matrix (2.2) covered

**verify:**
```sh
npm run build
# bhrain plan
npx rhachet run --skill brief.compress --from src/domain.roles/mechanic/briefs/practices/code.prod/evolvable.procedures/rule.require.dependency-injection.md.pt1.md --via bhrain/sitrep --mode plan
# bhrain apply
npx rhachet run --skill brief.compress --from src/domain.roles/mechanic/briefs/practices/code.prod/evolvable.procedures/rule.require.dependency-injection.md.pt1.md --via bhrain/sitrep --mode apply
# bhrain with --into
npx rhachet run --skill brief.compress --from src/domain.roles/mechanic/briefs/practices/code.prod/evolvable.procedures/rule.require.dependency-injection.md.pt1.md --via bhrain/sitrep --into /tmp/test-output.md --mode apply
# llmlingua via new flags
npx rhachet run --skill brief.compress --from src/domain.roles/mechanic/briefs/practices/code.prod/evolvable.procedures/rule.require.dependency-injection.md.pt1.md --via llmlingua/v2@tinybert --mode plan
```

---

## phase 4: integration tests

**depends on:** phase 3

**read before:**
- `.behavior/v2026_02_10.brief-compressor-sitrep/3.1.research.patterns._.code.test.v1.i1.md` (test patterns)
- `.behavior/v2026_02_10.brief-compressor-sitrep/2.1.criteria.blackbox.md` (blackbox criteria)
- `.behavior/v2026_02_10.brief-compressor-sitrep/2.2.criteria.blackbox.matrix.md` (coverage matrix)

**checklist:**
- [ ] create `compress.via.bhrain.integration.test.ts`
  - [ ] sitrep template includes preserve-code-blocks instruction
  - [ ] sitrep template includes preserve-rule-statement instruction
  - [ ] genContextBrain resolves xai brain slug
  - [ ] genContextBrain resolves anthropic brain slug
  - [ ] compressViaBhrain returns valid result shape
  - [ ] compressViaBhrain compressed output preserves code blocks
- [ ] create `compress.via.llmlingua.integration.test.ts`
  - [ ] computeCompression still works after rename
  - [ ] countTokens import from shared module works
- [ ] create `brief.compress.integration.test.ts`
  - [ ] `--via bhrain/sitrep` plan mode shows preview without `.min` write
  - [ ] `--via bhrain/sitrep` apply mode writes `.min` file
  - [ ] `--via bhrain/sitrep --into $output` writes to `$output`
  - [ ] `--via bhrain/sitrep` preserves rule statement in output
  - [ ] `--via bhrain/sitrep` preserves code blocks in output
  - [ ] `--via bhrain/sitrep@xai/grok/code-fast-1` parses correctly
  - [ ] `--via bhrain/sitrep` (no `@brain`) defaults to grok code-fast-1
  - [ ] `--via tinybert` (bare, no `@` or `/`) failfasts
  - [ ] `--via @xai/grok/code-fast-1` (no press) failfasts
  - [ ] `--into` with glob `--from` failfasts
  - [ ] no api key failfasts with clear message
  - [ ] empty brief emits empty `.min`
  - [ ] `--from` no-match failfasts
  - [ ] `--via llmlingua/v2@tinybert` works
  - [ ] output reports `tokens.before`, `tokens.after`, `ratio.actual`
  - [ ] both presses produce `.min` at same path

**acceptance criteria:**
- [ ] all integration tests pass
- [ ] all blackbox criteria usecases covered by at least one test

**verify:**
```sh
npm run build
npm run test:integration -- compress.via.bhrain
npm run test:integration -- compress.via.llmlingua
npm run test:integration -- brief.compress.integration
```

---

## phase 5: cleanup + final verification

**depends on:** phase 4

**read before:**
- `.behavior/v2026_02_10.brief-compressor-sitrep/3.3.blueprint.v1.i1.md` (full blueprint for diff review)

**checklist:**
- [ ] delete `compress.ts` (original, now renamed)
- [ ] delete `compress.js` + `compress.js.map` + `compress.d.ts` (build artifacts of old name)
- [ ] npm run build — confirm no build errors
- [ ] npm run test:types — confirm no type errors
- [ ] npm run test:lint — confirm no lint errors
- [ ] review all filediffs against blueprint treestruct
- [ ] verify `brief.compress.sh` header comment is updated to reflect `--via`, `--from`, `--into`

**acceptance criteria:**
- [ ] no references to old `compress.ts` / `compress.js` remain
- [ ] build passes clean
- [ ] all tests pass
- [ ] skill header doc matches new interface

**verify:**
```sh
npm run build
npm run test:types
npm run test:lint
npm run test:integration -- compress
```
