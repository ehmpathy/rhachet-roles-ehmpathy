# exhaustive pipeline matrix

## objective

test all reasonable combinations of:
- supply modes (none, soft kernelize)
- methodologies (6 base)
- prompt modifiers (`req-kernels` position)
- chain patterns (1-3 passes)
- post-process modes (none, verify, restore)

constraint: kern.Δ > -1 (less than 1 kernel lost on average)

---

## key insight: `req-kernels` as prompt modifier

instead of a separate "strict supply mode", `req-kernels` is a prompt modifier that can be placed at any position in any pass:

| pattern | behavior |
|---------|----------|
| `[[req-kernels, sitrep]]` | kernel constraint before compression |
| `[[sitrep, req-kernels]]` | kernel constraint after compression |
| `[[req-kernels, sitrep, req-kernels]]` | wrap: constraint before + after |

this enables fine-grained control at each compression stage.

---

## base methodologies

| id | methodology | compression style | expected retention |
|----|-------------|-------------------|-------------------|
| S | sitrep | gentle situational | high |
| SA | sitrep-aggressive | aggressive cut | low |
| ST | sitrep-taskaware | agent-optimized | high |
| SI | sitrep-iterative | two-pass refine | medium |
| SAA | sitrep-aggro-aware | aggressive + aware | medium |
| T | telegraphic | structural compress | high |

## prompt modifiers

| id | modifier | behavior |
|----|----------|----------|
| RK | req-kernels | add hard constraint: "MUST preserve these kernels" |

---

## supply modes

| mode | behavior |
|------|----------|
| none | no kernel context supplied |
| `sup:kernelize` | soft context: "use to inform compression" |

note: with `req-kernels` modifier, we don't need a separate `kernelize-strict` supply mode. the strictness comes from the prompt modifier position.

---

## post-process modes

| mode | behavior |
|------|----------|
| none | no post-process |
| `verify` | check retention, retry if lost |
| `restore` | append lost kernels to output |

---

## pipeline matrix

### tier 1: proven high-retention (baseline)

```
[[sitrep, telegraphic]]                      # kern.Δ = -0.2
[[telegraphic, sitrep]]                      # kern.Δ = -0.4
sup:kernelize, [sitrep-taskaware]            # kern.Δ = -0.9
```

### tier 2: req-kernels positions (single pass)

test where the kernel constraint has most effect:

```
# req-kernels BEFORE methodology
[[req-kernels, sitrep]]
[[req-kernels, sitrep-taskaware]]
[[req-kernels, sitrep-aggressive]]
[[req-kernels, telegraphic]]

# req-kernels AFTER methodology
[[sitrep, req-kernels]]
[[sitrep-taskaware, req-kernels]]
[[sitrep-aggressive, req-kernels]]
[[telegraphic, req-kernels]]

# req-kernels WRAP (before + after)
[[req-kernels, sitrep, req-kernels]]
[[req-kernels, sitrep-taskaware, req-kernels]]
[[req-kernels, sitrep-aggressive, req-kernels]]
[[req-kernels, telegraphic, req-kernels]]
```

### tier 3: req-kernels + supply (single pass)

combine soft supply with hard constraint:

```
sup:kernelize, [req-kernels, sitrep]
sup:kernelize, [req-kernels, sitrep-taskaware]
sup:kernelize, [req-kernels, sitrep-aggressive]
sup:kernelize, [req-kernels, sitrep, req-kernels]
sup:kernelize, [req-kernels, sitrep-taskaware, req-kernels]
sup:kernelize, [req-kernels, sitrep-aggressive, req-kernels]
```

### tier 4: double-pass with req-kernels at each stage

```
# req-kernels before each methodology
[[req-kernels, sitrep], [req-kernels, telegraphic]]
[[req-kernels, sitrep-taskaware], [req-kernels, telegraphic]]
[[req-kernels, sitrep-aggressive], [req-kernels, telegraphic]]

# req-kernels wrap at each stage
[[req-kernels, sitrep, req-kernels], [req-kernels, telegraphic, req-kernels]]
[[req-kernels, sitrep-taskaware, req-kernels], [req-kernels, telegraphic, req-kernels]]

# req-kernels only at first stage
[[req-kernels, sitrep-aggressive], [telegraphic]]
[[req-kernels, sitrep-aggressive], [sitrep-taskaware]]

# req-kernels only at last stage
[[sitrep-aggressive], [req-kernels, telegraphic]]
[[sitrep-aggressive], [req-kernels, sitrep-taskaware]]
```

### tier 5: double-pass with supply + req-kernels

```
sup:kernelize, [req-kernels, sitrep], [req-kernels, telegraphic]
sup:kernelize, [req-kernels, sitrep-taskaware], [req-kernels, telegraphic]
sup:kernelize, [req-kernels, sitrep, req-kernels], [req-kernels, telegraphic, req-kernels]
sup:kernelize, [req-kernels, sitrep-aggressive], [req-kernels, sitrep-taskaware]
```

### tier 6: triple-pass with req-kernels

```
[[req-kernels, sitrep-aggressive], [req-kernels, sitrep-taskaware], [req-kernels, telegraphic]]
[[req-kernels, sitrep-aggressive, req-kernels], [req-kernels, sitrep-taskaware, req-kernels], [telegraphic]]
sup:kernelize, [req-kernels, sitrep-aggressive], [req-kernels, sitrep-taskaware], [telegraphic]
```

### tier 7: gentle double-pass (no req-kernels, for comparison)

```
[[sitrep], [sitrep]]
[[sitrep], [sitrep-taskaware]]
[[sitrep-taskaware], [sitrep-taskaware]]
[[sitrep-taskaware], [telegraphic]]
[[telegraphic], [telegraphic]]
```

### tier 8: verification loop variants

```
sup:kernelize, [sitrep], verify
sup:kernelize, [sitrep-taskaware], verify
sup:kernelize, [req-kernels, sitrep], verify
sup:kernelize, [req-kernels, sitrep-taskaware], verify
sup:kernelize, [req-kernels, sitrep, req-kernels], verify
[[req-kernels, sitrep-aggressive]], verify
[[req-kernels, sitrep-aggressive], [telegraphic]], verify
```

### tier 9: restoration variants

```
sup:kernelize, [sitrep-aggressive], restore
sup:kernelize, [req-kernels, sitrep-aggressive], restore
[[sitrep-aggressive], [telegraphic]], restore
[[req-kernels, sitrep-aggressive], [telegraphic]], restore
```

---

## summary counts

| tier | description | pipelines |
|------|-------------|-----------|
| 1 | proven baseline | 3 |
| 2 | req-kernels positions | 12 |
| 3 | req-kernels + supply | 6 |
| 4 | double-pass + req-kernels | 9 |
| 5 | double-pass + supply + req-kernels | 4 |
| 6 | triple-pass + req-kernels | 3 |
| 7 | gentle double-pass (comparison) | 5 |
| 8 | verification loop | 7 |
| 9 | restoration | 4 |
| **total** | | **53** |

with 8 briefs × 3 runs = **1,272 compressions**

---

## req-kernels prompt content

when `req-kernels` appears in a pass, inject this into the prompt:

**before methodology** (`[req-kernels, sitrep]`):
```
CRITICAL CONSTRAINT — KERNEL PRESERVATION:
The concepts listed below are REQUIRED in your output.
Any absent concept is a compression failure.
Preserve the semantic sense even if you rephrase.

REQUIRED KERNELS:
- [rule] all procedures use (input, context) pattern
- [principle] dependency injection via context
...

Now compress via sitrep methodology:
```

**after methodology** (`[sitrep, req-kernels]`):
```
<compressed output from sitrep>

VERIFICATION — confirm these kernels are present:
- [rule] all procedures use (input, context) pattern
- [principle] dependency injection via context
...

If any kernel is absent, restore it now.
```

**wrap** (`[req-kernels, sitrep, req-kernels]`):
both prompts applied — constraint before, verification after.

---

## typescript config

```ts
type SupplyMode = null | 'kernelize';
type PostProcess = null | 'verify' | 'restore';
type PromptModifier = 'req-kernels';
type BaseMechanism = 'sitrep' | 'sitrep-aggressive' | 'sitrep-taskaware'
  | 'sitrep-iterative' | 'sitrep-aggro-aware' | 'telegraphic';
type MechanismOrModifier = BaseMechanism | PromptModifier;

interface PipelineConfig {
  supply: SupplyMode;
  press: MechanismOrModifier[][];  // each inner array = one pass
  post: PostProcess;
}

const EXHAUSTIVE_PIPELINES: PipelineConfig[] = [
  // tier 1: proven baseline
  { supply: null, press: [['sitrep', 'telegraphic']], post: null },
  { supply: null, press: [['telegraphic', 'sitrep']], post: null },
  { supply: 'kernelize', press: [['sitrep-taskaware']], post: null },

  // tier 2: req-kernels positions (single pass)
  { supply: null, press: [['req-kernels', 'sitrep']], post: null },
  { supply: null, press: [['req-kernels', 'sitrep-taskaware']], post: null },
  { supply: null, press: [['req-kernels', 'sitrep-aggressive']], post: null },
  { supply: null, press: [['req-kernels', 'telegraphic']], post: null },
  { supply: null, press: [['sitrep', 'req-kernels']], post: null },
  { supply: null, press: [['sitrep-taskaware', 'req-kernels']], post: null },
  { supply: null, press: [['sitrep-aggressive', 'req-kernels']], post: null },
  { supply: null, press: [['telegraphic', 'req-kernels']], post: null },
  { supply: null, press: [['req-kernels', 'sitrep', 'req-kernels']], post: null },
  { supply: null, press: [['req-kernels', 'sitrep-taskaware', 'req-kernels']], post: null },
  { supply: null, press: [['req-kernels', 'sitrep-aggressive', 'req-kernels']], post: null },
  { supply: null, press: [['req-kernels', 'telegraphic', 'req-kernels']], post: null },

  // tier 3: req-kernels + supply
  { supply: 'kernelize', press: [['req-kernels', 'sitrep']], post: null },
  { supply: 'kernelize', press: [['req-kernels', 'sitrep-taskaware']], post: null },
  { supply: 'kernelize', press: [['req-kernels', 'sitrep-aggressive']], post: null },
  { supply: 'kernelize', press: [['req-kernels', 'sitrep', 'req-kernels']], post: null },
  { supply: 'kernelize', press: [['req-kernels', 'sitrep-taskaware', 'req-kernels']], post: null },
  { supply: 'kernelize', press: [['req-kernels', 'sitrep-aggressive', 'req-kernels']], post: null },

  // tier 4: double-pass + req-kernels
  { supply: null, press: [['req-kernels', 'sitrep'], ['req-kernels', 'telegraphic']], post: null },
  { supply: null, press: [['req-kernels', 'sitrep-taskaware'], ['req-kernels', 'telegraphic']], post: null },
  { supply: null, press: [['req-kernels', 'sitrep-aggressive'], ['req-kernels', 'telegraphic']], post: null },
  { supply: null, press: [['req-kernels', 'sitrep', 'req-kernels'], ['req-kernels', 'telegraphic', 'req-kernels']], post: null },
  { supply: null, press: [['req-kernels', 'sitrep-taskaware', 'req-kernels'], ['req-kernels', 'telegraphic', 'req-kernels']], post: null },
  { supply: null, press: [['req-kernels', 'sitrep-aggressive'], ['telegraphic']], post: null },
  { supply: null, press: [['req-kernels', 'sitrep-aggressive'], ['sitrep-taskaware']], post: null },
  { supply: null, press: [['sitrep-aggressive'], ['req-kernels', 'telegraphic']], post: null },
  { supply: null, press: [['sitrep-aggressive'], ['req-kernels', 'sitrep-taskaware']], post: null },

  // tier 5: double-pass + supply + req-kernels
  { supply: 'kernelize', press: [['req-kernels', 'sitrep'], ['req-kernels', 'telegraphic']], post: null },
  { supply: 'kernelize', press: [['req-kernels', 'sitrep-taskaware'], ['req-kernels', 'telegraphic']], post: null },
  { supply: 'kernelize', press: [['req-kernels', 'sitrep', 'req-kernels'], ['req-kernels', 'telegraphic', 'req-kernels']], post: null },
  { supply: 'kernelize', press: [['req-kernels', 'sitrep-aggressive'], ['req-kernels', 'sitrep-taskaware']], post: null },

  // tier 6: triple-pass + req-kernels
  { supply: null, press: [['req-kernels', 'sitrep-aggressive'], ['req-kernels', 'sitrep-taskaware'], ['req-kernels', 'telegraphic']], post: null },
  { supply: null, press: [['req-kernels', 'sitrep-aggressive', 'req-kernels'], ['req-kernels', 'sitrep-taskaware', 'req-kernels'], ['telegraphic']], post: null },
  { supply: 'kernelize', press: [['req-kernels', 'sitrep-aggressive'], ['req-kernels', 'sitrep-taskaware'], ['telegraphic']], post: null },

  // tier 7: gentle double-pass (comparison)
  { supply: null, press: [['sitrep'], ['sitrep']], post: null },
  { supply: null, press: [['sitrep'], ['sitrep-taskaware']], post: null },
  { supply: null, press: [['sitrep-taskaware'], ['sitrep-taskaware']], post: null },
  { supply: null, press: [['sitrep-taskaware'], ['telegraphic']], post: null },
  { supply: null, press: [['telegraphic'], ['telegraphic']], post: null },

  // tier 8: verification loop
  { supply: 'kernelize', press: [['sitrep']], post: 'verify' },
  { supply: 'kernelize', press: [['sitrep-taskaware']], post: 'verify' },
  { supply: 'kernelize', press: [['req-kernels', 'sitrep']], post: 'verify' },
  { supply: 'kernelize', press: [['req-kernels', 'sitrep-taskaware']], post: 'verify' },
  { supply: 'kernelize', press: [['req-kernels', 'sitrep', 'req-kernels']], post: 'verify' },
  { supply: null, press: [['req-kernels', 'sitrep-aggressive']], post: 'verify' },
  { supply: null, press: [['req-kernels', 'sitrep-aggressive'], ['telegraphic']], post: 'verify' },

  // tier 9: restoration
  { supply: 'kernelize', press: [['sitrep-aggressive']], post: 'restore' },
  { supply: 'kernelize', press: [['req-kernels', 'sitrep-aggressive']], post: 'restore' },
  { supply: null, press: [['sitrep-aggressive'], ['telegraphic']], post: 'restore' },
  { supply: null, press: [['req-kernels', 'sitrep-aggressive'], ['telegraphic']], post: 'restore' },
];
```

---

## execution plan

1. implement `req-kernels` as a prompt modifier in `genCompressionPrompt`
2. implement `verify` post-process mode
3. implement `restore` post-process mode
4. add `EXHAUSTIVE_PIPELINES` to perfeval test
5. run perfeval with all 53 pipelines × 8 briefs × 3 runs
6. filter results to kern.Δ > -1
7. rank by dens.Δ within retention constraint
8. document optimal pipeline

---

## hypothesis

the wrap pattern `[[req-kernels, sitrep-aggressive, req-kernels]]` should achieve:
- high compression (from aggressive methodology)
- high retention (from double kernel constraint)

combined with supply: `sup:kernelize, [req-kernels, sitrep-aggressive, req-kernels]` should be optimal.
