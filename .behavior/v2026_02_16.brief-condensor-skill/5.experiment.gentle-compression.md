# experiment: gentle compression pipelines

## goal

find a pipeline that achieves:
- **dens.Δ = 2-3x** (gentler than current 7-10x)
- **kern.Δ = 0** (zero kernel loss)
- **stable variance** (σ < 3.0)

## baseline (current)

pipeline: `[[req-kernels, sitrep-aggressive], [telegraphic]]`

| brief | tokens | dens.Δ | kern.Δ |
|-------|--------|--------|--------|
| seaturtle-software | 1033 → 97 | +8.8 | 0 |
| domain-objects-ref | 4605 → 178 | +9.5 | 0 |
| bdd-testing | 2104 → 210 | +9.0 | 0 |
| idempotency | 559 → 164 | +7.1 | 0 |

**problem**: too aggressive — loses readability for marginal token savings

## pipelines to test

### pipeline A: telegraphic only

```
[[req-kernels, telegraphic]]
```

- single step, syntax compress only
- expected: mildest compression
- output: `{brief}.min.telegraphic`

### pipeline B: sitrep + telegraphic

```
[[req-kernels, sitrep], [telegraphic]]
```

- baseline sitrep (not aggressive) + telegraphic
- expected: medium compression
- output: `{brief}.min.sitrep-tele`

### pipeline C: sitrep only

```
[[req-kernels, sitrep]]
```

- single step baseline sitrep
- expected: mild-medium compression
- output: `{brief}.min.sitrep`

## test matrix

| brief | pipeline A | pipeline B | pipeline C |
|-------|------------|------------|------------|
| idempotency | .min.telegraphic | .min.sitrep-tele | .min.sitrep |
| bdd-testing | .min.telegraphic | .min.sitrep-tele | .min.sitrep |
| seaturtle-software | .min.telegraphic | .min.sitrep-tele | .min.sitrep |
| domain-objects-ref | .min.telegraphic | .min.sitrep-tele | .min.sitrep |

**total runs**: 4 briefs × 3 pipelines = 12 runs

## success criteria

the target pipeline should:
1. achieve dens.Δ in 2-3x range consistently
2. maintain kern.Δ = 0 (zero kernel loss)
3. produce stable results (σ < 3.0)
4. preserve readability better than aggressive pipeline

## results

### pipeline A: telegraphic only

| brief | tokens | dens.Δ | dens.σ | kern.Δ |
|-------|--------|--------|--------|--------|
| seaturtle-software | 1033 → 619 | **+3.9** | 0.29 | 0 |
| domain-objects-ref | 4605 → 381 | +9.0 | 1.66 | 0 |
| bdd-testing | 2104 → 470 | +7.7 | 0.91 | 0 |
| idempotency | 559 → 207 | +6.2 | 0.46 | 0 |

**average dens.Δ**: +6.7x

### pipeline B: sitrep + telegraphic

| brief | tokens | dens.Δ | dens.σ | kern.Δ |
|-------|--------|--------|--------|--------|
| seaturtle-software | 1033 → 168 | +8.2 | 1.27 | 0 |
| domain-objects-ref | 4605 → 371 | +9.1 | 2.23 | 0 |
| bdd-testing | 2104 → 239 | +8.8 | 1.49 | 0 |
| idempotency | 559 → 184 | +6.6 | 0.39 | 0 |

**average dens.Δ**: +8.2x

**note**: idempotency brief was initially marked FAILED due to JSON format issues (see investigation below) — now resolved

### pipeline C: sitrep only

| brief | tokens | dens.Δ | dens.σ | kern.Δ |
|-------|--------|--------|--------|--------|
| seaturtle-software | 1033 → 272 | +7.0 | 0.51 | 0 |
| domain-objects-ref | 4605 → 253 | +9.3 | 2.96 | 0 |
| bdd-testing | 2104 → 371 | +8.1 | 1.2 | 0 |
| idempotency | 559 → 253 | +4.8 | 0.05 | 0 |

**note**: sitrep-only is a single-step pipeline and works correctly

---

## analysis

### against success criteria

| criterion | result | assessment |
|-----------|--------|------------|
| dens.Δ = 2-3x | closest: seaturtle+telegraphic at 3.9x | ❌ none met target |
| kern.Δ = 0 | all successful runs | ✓ met |
| σ < 3.0 | all successful runs | ✓ met |

### key observations

1. **telegraphic-only is gentlest** but still averages 6.7x (target was 2-3x)
2. **seaturtle+telegraphic at 3.9x** is the closest to the 2-3x target
3. **brief content matters**: seaturtle compresses less than domain-objects
4. **sitrep-only works**: at +4.8x for idempotency, close to target

### conclusion

**none of the tested pipelines achieve the 2-3x compression target consistently**.

the gentlest option (telegraphic-only) still produces 6-9x compression for most briefs. however:

1. **seaturtle+telegraphic at 3.9x** is the closest to target (brief-dependent)
2. **idempotency+sitrep at 4.8x** is also close to target

---

## investigation: multi-step pipeline "failure"

### symptom

pipeline B (sitrep + telegraphic) failed on idempotency brief with error:
```
BadRequestError: invalid onPress spec: malformed JSON
```

### root cause

**JSON spec format issue, not a code bug**. the shell strips inner quotes from the `--onPress` argument.

incorrect (quotes stripped by shell):
```sh
--onPress '[["req-kernels", "sitrep"], ["telegraphic"]]'
```

correct (escaped quotes survive shell):
```sh
--onPress '[[\"req-kernels\", \"sitrep\"], [\"telegraphic\"]]'
```

### fix applied

1. **defensive code added** to `extractKernels.ts` line 270: `(result.kernels ?? [])` guards against undefined
2. **proper JSON escaping** documented - use backslash-escaped double quotes inside single quotes

### verification

multi-step pipeline now runs past JSON parse error with proper escaping. the original "forEach error" reported was actually this JSON parse error.

---

## next steps

1. ~~investigate the multi-step pipeline failure~~ **done** - was JSON format issue
2. ~~re-run pipeline B on idempotency with proper escaping to collect results~~ **done** - results: 559→184, dens.Δ=+6.6, σ=0.39, kern.Δ=0
3. consider 4-6x as the "gentle" tier for most briefs
4. use telegraphic-only for briefs that need lighter compression
5. accept that 2-3x may not be achievable with current methodologies
