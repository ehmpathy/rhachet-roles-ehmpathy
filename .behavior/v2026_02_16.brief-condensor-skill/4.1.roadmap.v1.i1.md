# roadmap: condense skill implementation

## overview

checklist-style roadmap for the condense skill implementation.

**dependencies flow:**
```
phase 0 (setup)
    ↓
phase 1 (supply) → phase 2 (press) → phase 3 (verify)
    ↓                   ↓                  ↓
              phase 4 (orchestrator)
                        ↓
              phase 5 (tests)
```

---

## phase 0: project setup

**prereq briefs:** none

### checklist

- [ ] **0.1** create skill directory structure
  ```
  src/domain.roles/mechanic/skills/condense/
  ├── domain.operations/
  │   ├── supply/
  │   ├── press/
  │   └── verify/
  ├── briefs/
  └── .test/fixtures/briefs/
  ```

- [ ] **0.2** create test fixtures
  - `stable-rule.md` — brief with stable kernel extraction
  - `unstable-ambiguous.md` — brief that fails stability threshold

### acceptance criteria

```
given('phase 0 complete')
  then('directory structure exists')
  then('test fixtures exist and are readable')
```

### verification

```sh
ls -la src/domain.roles/mechanic/skills/condense/
ls -la src/domain.roles/mechanic/skills/condense/domain.operations/
ls -la src/domain.roles/mechanic/skills/condense/.test/fixtures/briefs/
```

---

## phase 1: supply operations

**prereq briefs:**
- `3.1.research.patterns._.code.prod.v1.i1.md` — production codepaths, reuse patterns
- `3.1.research.domain.terms.v1.i1.md` — domain terminology (kernels, stability, consensus)
- `3.3.blueprint.v1.i1.md` — implementation spec

**depends on:** phase 0

### checklist

- [ ] **1.1** implement `assertStability.ts`
  - location: `skills/condense/domain.operations/supply/`
  - input: `{ stability: ConsensusStability }`
  - behavior: throw if `meanJaccard < 0.7`
  - reuses: `ConsensusStability` type from `skills/kernelize/`

- [ ] **1.2** unit test `assertStability.test.ts`
  - test: passes when meanJaccard ≥ 0.7
  - test: throws when meanJaccard < 0.7
  - test: error message includes actual meanJaccard value

### acceptance criteria

```
given('a ConsensusStability with meanJaccard = 0.8')
  when('assertStability is called')
    then('it does not throw')

given('a ConsensusStability with meanJaccard = 0.5')
  when('assertStability is called')
    then('it throws with message that includes "unstable"')
    then('it throws with message that includes "0.5"')
```

### verification

```sh
npm run test:unit -- assertStability.test.ts
```

---

## phase 2: press operations

**prereq briefs:**
- `3.1.research.patterns._.code.prod.v1.i1.md` — compressViaBhrain reuse
- `3.3.blueprint.v1.i1.md` — pressViaPipeline spec

**depends on:** phase 0

### checklist

- [ ] **2.1** implement `pressViaPipeline.ts`
  - location: `skills/condense/domain.operations/press/`
  - input: `{ content: string; pipeline: PressBrief[][]; kernels?: ConceptKernel[] }`
  - behavior: iterate steps, call `compressViaBhrain` per step
  - reuses: `compressViaBhrain` from `skills/brief.compress/`

- [ ] **2.2** integration test `pressViaPipeline.integration.test.ts`
  - test: single-step pipeline compresses content
  - test: multi-step pipeline applies steps in order
  - test: kernels are injected when `req-kernels` is in step

### acceptance criteria

```
given('content and a 2-step pipeline [[sitrep-aggressive], [telegraphic]]')
  when('pressViaPipeline is called')
    then('step 1 compresses with sitrep-aggressive')
    then('step 2 compresses step 1 output with telegraphic')
    then('tokens.after < tokens.before')

given('content, kernels, and pipeline [[req-kernels, sitrep-aggressive]]')
  when('pressViaPipeline is called')
    then('kernels are included in compression prompt')
```

### verification

```sh
npm run test:integration -- pressViaPipeline.integration.test.ts
```

---

## phase 3: verify operations

**prereq briefs:**
- `3.1.research.patterns._.code.prod.v1.i1.md` — checkKernelRetention reuse
- `3.3.blueprint.v1.i1.md` — checkRetention, restoreKernels specs

**depends on:** phase 0

### checklist

- [ ] **3.1** implement `checkRetention.ts`
  - location: `skills/condense/domain.operations/verify/`
  - input: `{ kernels: ConceptKernel[]; content: string }`
  - output: `{ retained: ConceptKernel[]; lost: ConceptKernel[]; retentionRate: number }`
  - reuses: `checkKernelRetention` from `skills/kernelize/`

- [ ] **3.2** implement `restoreKernels.ts`
  - location: `skills/condense/domain.operations/verify/`
  - input: `{ content: string; lostKernels: ConceptKernel[] }`
  - output: `{ content: string; restored: ConceptKernel[] }`
  - behavior: recompress with lost kernels as required supplements (never mechanical append)
  - reuses: `compressViaBhrain` from `skills/brief.compress/`

- [ ] **3.3** integration test `checkRetention.integration.test.ts`
  - test: identifies retained kernels correctly
  - test: identifies lost kernels correctly
  - test: retentionRate = retained.length / total

- [ ] **3.4** integration test `restoreKernels.integration.test.ts`
  - test: recompresses content with lost kernels as supplements
  - test: output contains previously lost concepts
  - test: does NOT mechanically append (no `## core concepts` section)

### acceptance criteria

```
given('kernels and compressed content where some kernels are absent')
  when('checkRetention is called')
    then('lost array contains the absent kernels')
    then('retained array contains the present kernels')
    then('retentionRate = retained.length / kernels.length')

given('compressed content and lost kernels')
  when('restoreKernels is called')
    then('output is recompressed via brain with lost kernels as supplements')
    then('output does NOT contain "## core concepts" section')
    then('lost concepts are woven into the prose')
```

### verification

```sh
npm run test:integration -- checkRetention.integration.test.ts
npm run test:integration -- restoreKernels.integration.test.ts
```

---

## phase 4: main orchestrator

**prereq briefs:**
- `3.1.research.patterns._.code.prod.v1.i1.md` — rhachet arg handle pattern, turtle vibes output
- `3.3.blueprint.v1.i1.md` — condense orchestration spec

**depends on:** phase 1, phase 2, phase 3

### checklist

- [ ] **4.1** implement `condense.ts`
  - location: `skills/condense/`
  - orchestrates: supply → press → verify
  - handles: N attempts, variance computation
  - output: inline type per blueprint

- [ ] **4.2** implement `condense.sh`
  - location: `skills/condense/`
  - parses: `--from`, `--into`, `--onSupply`, `--onPress`, `--onVerify`, `--attempts`, `--mode`, `--brain`
  - validates: args per contract
  - invokes: `condense.ts`

- [ ] **4.3** implement `output.sh`
  - location: `skills/condense/`
  - reuses: turtle vibes helpers from `skills/brief.compress/output.sh`

- [ ] **4.4** create `briefs/recommended-pipelines.md`
  - location: `skills/condense/briefs/`
  - content: top 5 pipelines for `--help`

### acceptance criteria

```
given('a valid brief and default args')
  when('condense.ts is called')
    then('kernels are extracted via extractKernelsWithConsensus')
    then('stability is asserted via assertStability')
    then('compression runs via pressViaPipeline')
    then('retention is verified via checkRetention')
    then('output includes dens.Δ, kern.Δ metrics')

given('--attempts 3')
  when('condense.ts is called')
    then('compression runs 3 times')
    then('output includes dens.σ, kern.σ variance metrics')

given('--onVerify restore and kernel loss')
  when('condense.ts is called')
    then('restoreKernels is invoked')
    then('kern.Δ after restore is 0 or positive')
```

### verification

```sh
npm run build
npx rhachet run --skill condense --from test-brief.md --mode plan
```

---

## phase 5: tests

**prereq briefs:**
- `3.1.research.patterns._.code.test.v1.i1.md` — test patterns (given/when/then, useThen, sanitizeOutput)
- `2.1.criteria.blackbox.md` — blackbox acceptance criteria

**depends on:** phase 4

### checklist

- [ ] **5.1** integration tests `condense.integration.test.ts`
  - case 1: valid brief with default pipeline
  - case 2: unstable brief (exit code 2)
  - case 3: kernel loss with/without restore
  - case 4: empty brief (exit code 1)
  - case 5: invalid pipeline spec (exit code 1)
  - case 6: batch glob

- [ ] **5.2** perfeval tests `condense.perfeval.integration.test.ts`
  - variance measurement across N attempts
  - cache for repeated runs
  - progress log to jsonl

- [ ] **5.3** acceptance tests `condense.acceptance.test.ts`
  - blackbox cli behavior per `2.1.criteria.blackbox.md`
  - exit codes per contract
  - output format validation

### acceptance criteria

from `2.1.criteria.blackbox.md`:

```
given('[case1] valid markdown brief')
  when('[t0] condense with default pipeline')
    then('output shows pipeline used')
    then('output shows dens.Δ metric')
    then('output shows kern.Δ metric')
    then('exit code is 0')

given('[case2] unstable brief')
  when('[t0] condense is invoked')
    then('output shows kernelization unstable error')
    then('output shows stability.meanJaccard < 0.7')
    then('exit code is 2')
```

### verification

```sh
npm run test:integration -- condense.integration.test.ts
npm run test:acceptance -- condense.acceptance.test.ts
```

---

## phase 6: finalize

**prereq briefs:** none

**depends on:** phase 5

### checklist

- [ ] **6.1** update permissions
  - add `condense` skill to `init.claude.permissions.jsonc`

- [ ] **6.2** link and verify
  ```sh
  npm run build
  npx rhachet roles link --role mechanic
  npx rhachet roles init --role mechanic
  ```

- [ ] **6.3** end-to-end validation
  ```sh
  npx rhachet run --skill condense --from src/domain.roles/mechanic/briefs/practices/code.prod/evolvable.procedures/rule.require.input-context-pattern.md.pt1.md --mode plan
  ```

- [ ] **6.4** update behavior artifacts
  - mark wish as complete
  - document any deviations from blueprint

### acceptance criteria

```
given('all phases complete')
  when('condense skill is invoked on a real brief')
    then('compression succeeds with quality metrics')
    then('no permission prompts (pre-approved)')
```

### verification

```sh
npx rhachet run --skill condense --from briefs/any-brief.md --mode apply
```

---

## summary

| phase | deliverables | depends on |
|-------|-------------|------------|
| 0 | directory structure, fixtures | — |
| 1 | `assertStability.ts` + unit test | 0 |
| 2 | `pressViaPipeline.ts` + integration test | 0 |
| 3 | `checkRetention.ts`, `restoreKernels.ts` + tests | 0 |
| 4 | `condense.ts`, `condense.sh`, `output.sh`, `recommended-pipelines.md` | 1, 2, 3 |
| 5 | integration, perfeval, acceptance tests | 4 |
| 6 | permissions, link, e2e validation | 5 |

**critical path:** 0 → 1 → 4 → 5 → 6 (supply is on critical path due to fail-fast)

**parallelizable:** phases 1, 2, 3 can run in parallel after phase 0
