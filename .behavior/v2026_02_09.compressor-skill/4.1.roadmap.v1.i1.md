# roadmap: brief.compress skill

**date**: 2026-02-09
**scope**: ordered execution plan for the brief.compress skill

---

## overview

this roadmap breaks down the blueprint into executable steps with:
- ordered dependencies (each step depends on prior steps)
- behavioral acceptance criteria (what must be true when done)
- verification commands (how to prove acceptance)

---

## phase.0: scaffold

### prereqs

read before this phase:
- `.behavior/v2026_02_09.compressor-skill/3.3.blueprint.v1.i1.md` ‚Äî blueprint structure
- `.behavior/v2026_02_09.compressor-skill/3.1.research.patterns._.code.prod.v1.i1.md` ‚Äî shell skill patterns

### steps

- [ ] **0.1** create skill directory
  - create `src/domain.roles/librarian/skills/brief.compress/`
  - **acceptance**: directory exists
  - **verify**: `ls src/domain.roles/librarian/skills/brief.compress/`

- [ ] **0.2** copy output.sh helper
  - copy `src/domain.roles/mechanic/skills/git.commit/output.sh` to `brief.compress/output.sh`
  - **acceptance**: output.sh exists with turtle helpers
  - **verify**: `grep "print_turtle_header" src/domain.roles/librarian/skills/brief.compress/output.sh`

- [ ] **0.3** create brief.compress.sh skeleton
  - create shell skill with header block (`.what`, `.why`, `usage`, `guarantee`)
  - include `set -euo pipefail`
  - source output.sh
  - **acceptance**: file exists with header and fail-fast mode
  - **verify**: `head -50 src/domain.roles/librarian/skills/brief.compress/brief.compress.sh`

- [ ] **0.4** create compress.ts skeleton
  - create typescript file with cli arg parse stub
  - export main function
  - **acceptance**: typescript file exists and parses args
  - **verify**: `bun src/domain.roles/librarian/skills/brief.compress/compress.ts --help`

- [ ] **0.5** add npm dependency
  - add `@atjsh/llmlingua-2` to package.json dependencies
  - run `npm install`
  - **acceptance**: package installed and importable
  - **verify**: `npm list @atjsh/llmlingua-2`

---

## phase.1: core compression

### prereqs

read before this phase:
- `.behavior/v2026_02_09.compressor-skill/3.1.research.access._.v1.i1.md` ‚Äî llmlingua-2 api
- `.behavior/v2026_02_09.compressor-skill/3.1.research.patterns._.oss.levers.v1.i1.md` ‚Äî compression library usage

### steps

- [ ] **1.1** implement compress.ts core
  - load LLMLingua2 compressor with model selection
  - implement compression with force_tokens
  - count tokens before/after via tiktoken
  - emit json stats to stdout
  - **acceptance**: compress.ts compresses markdown and outputs json stats
  - **verify**: `echo "# test brief\n\nthis is a test" | bun compress.ts --model tinybert --rate 0.5`

- [ ] **1.2** implement brief.compress.sh arg parse
  - parse: path (positional), --glob, --mode, --mech, --ratio, --force, --validate, --help
  - handle rhachet passthrough args (--repo, --role, --skill, --)
  - validate required args
  - **acceptance**: args parsed correctly, unknown args rejected
  - **verify**: `bash brief.compress.sh --help`

- [ ] **1.3** implement single file compression flow
  - read source file
  - invoke bun compress.ts
  - capture json output
  - write .md.min file (if apply mode)
  - **acceptance**: single file compression works end-to-end
  - **verify**: `bash brief.compress.sh test.md --mode apply && cat test.md.min`

- [ ] **1.4** implement turtle output format
  - use output.sh helpers
  - show tree with mode, mech, input, ratio, result
  - show plan mode message
  - **acceptance**: output follows turtle tree format
  - **verify**: `bash brief.compress.sh test.md --mode plan | grep "üê¢"`

### tests for phase.1

read before tests:
- `.behavior/v2026_02_09.compressor-skill/3.1.research.patterns._.code.test.v1.i1.md` ‚Äî test patterns
- `.behavior/v2026_02_09.compressor-skill/2.1.criteria.blackbox.md` ‚Äî blackbox criteria

- [ ] **1.5** test: single file plan mode
  - given: markdown brief in temp git repo
  - when: run with --mode plan
  - then: shows preview, no .md.min created, exit 0
  - **verify**: `npm run test:integration -- brief.compress --testNamePattern="plan"`

- [ ] **1.6** test: single file apply mode
  - given: markdown brief in temp git repo
  - when: run with --mode apply
  - then: .md.min created, compressed smaller, source unchanged
  - **verify**: `npm run test:integration -- brief.compress --testNamePattern="apply"`

---

## phase.2: batch and staleness

### prereqs

read before this phase:
- `.behavior/v2026_02_09.compressor-skill/3.3.blueprint.v1.i1.md` ‚Äî file enumeration codepath

### steps

- [ ] **2.1** implement glob pattern expansion
  - use find with glob pattern
  - filter to .md files
  - enumerate matched files
  - **acceptance**: --glob matches expected files
  - **verify**: `bash brief.compress.sh --glob "src/**/*.md" --mode plan | grep "files matched"`

- [ ] **2.2** implement no matches handler
  - detect when glob matches no files
  - exit 0 with informative message
  - **acceptance**: empty glob does not error
  - **verify**: `bash brief.compress.sh --glob "nonexistent/**/*.md" --mode plan`

- [ ] **2.3** implement mtime staleness check
  - compare source.md mtime vs source.md.min mtime
  - skip if .md.min is newer
  - recompress if source is newer
  - **acceptance**: fresh .md.min files skipped
  - **verify**: manual test with touch commands

- [ ] **2.4** implement --force flag
  - bypass mtime check when --force provided
  - always recompress
  - **acceptance**: --force recompresses even when fresh
  - **verify**: `bash brief.compress.sh test.md --force --mode apply`

### tests for phase.2

- [ ] **2.5** test: glob batch compression
  - given: multiple .md files in temp git repo
  - when: run with --glob pattern
  - then: all matched files compressed
  - **verify**: `npm run test:integration -- brief.compress --testNamePattern="glob"`

- [ ] **2.6** test: staleness skip
  - given: .md.min newer than source
  - when: run without --force
  - then: skipped with up-to-date message
  - **verify**: `npm run test:integration -- brief.compress --testNamePattern="staleness"`

- [ ] **2.7** test: force recompress
  - given: .md.min newer than source
  - when: run with --force
  - then: recompressed anyway
  - **verify**: `npm run test:integration -- brief.compress --testNamePattern="force"`

---

## phase.3: polish

### prereqs

read before this phase:
- `.behavior/v2026_02_09.compressor-skill/3.1.research.patterns._.code.prod.v1.i1.md` ‚Äî error and help patterns

### steps

- [ ] **3.1** implement --help flag
  - show usage with all flags
  - show model options and tradeoffs
  - exit 0
  - **acceptance**: --help shows comprehensive usage
  - **verify**: `bash brief.compress.sh --help`

- [ ] **3.2** implement error output
  - file not found ‚Üí stderr + exit 1
  - not a markdown file ‚Üí stderr + exit 1
  - model not available ‚Üí stderr + exit 1 + install instructions
  - **acceptance**: errors are descriptive with remediation
  - **verify**: `bash brief.compress.sh nonexistent.md 2>&1 | grep "not found"`

- [ ] **3.3** implement model availability check
  - compress.ts --check verifies model can load
  - shell skill checks before compression loop
  - **acceptance**: absent model detected early with install help
  - **verify**: `bun compress.ts --check --model mobilebert`

### tests for phase.3

- [ ] **3.4** test: error conditions
  - file not found ‚Üí exit non-zero
  - not markdown ‚Üí exit non-zero
  - model absent ‚Üí exit non-zero with instructions
  - **verify**: `npm run test:integration -- brief.compress --testNamePattern="error"`

- [ ] **3.5** test: help output
  - --help shows usage
  - exit 0
  - **verify**: `npm run test:integration -- brief.compress --testNamePattern="help"`

- [ ] **3.6** test: output format snapshot
  - sanitize variable data (tokens, paths)
  - snapshot turtle tree format
  - **verify**: `npm run test:integration -- brief.compress --testNamePattern="snapshot"`

---

## phase.4: integration

### prereqs

read before this phase:
- `.behavior/v2026_02_09.compressor-skill/3.3.blueprint.v1.i1.md` ‚Äî rhachet integration

### steps

- [ ] **4.1** add rhachet permissions
  - add to `src/domain.roles/mechanic/inits/init.claude.permissions.jsonc`
  - pattern: `Bash(npx rhachet run --skill brief.compress:*)`
  - **acceptance**: skill can be invoked via rhachet without permission prompt
  - **verify**: `npx rhachet run --skill brief.compress --help`

- [ ] **4.2** test rhachet passthrough
  - given: invoked via rhachet with extra args
  - when: --repo, --role, --skill args passed
  - then: args ignored, skill executes normally
  - **verify**: `npm run test:integration -- brief.compress --testNamePattern="rhachet"`

- [ ] **4.3** build and link
  - run `npm run build`
  - run `npx rhachet roles link --role mechanic`
  - **acceptance**: skill available via symlink
  - **verify**: `ls -la .agent/repo=ehmpathy/role=mechanic/skills/ | grep brief.compress`

---

## phase.5: validation (future)

### prereqs

read before this phase:
- `.behavior/v2026_02_09.compressor-skill/2.1.criteria.blackbox.md` ‚Äî validation criteria

### steps

- [ ] **5.1** implement --validate flag
  - run behavioral equivalence check after compression
  - compare LLM behavior on compressed vs original
  - **acceptance**: validation detects quality degradation

- [ ] **5.2** implement validation pass/fail logic
  - pass ‚Üí emit .md.min
  - fail ‚Üí no emit, report degradations
  - **acceptance**: bad compression blocked from emit

- [ ] **5.3** test: validation pass
  - given: well-compressible brief
  - when: --validate with conservative ratio
  - then: validation pass, file emitted

- [ ] **5.4** test: validation fail
  - given: constraint-heavy brief
  - when: --validate with aggressive ratio
  - then: validation fail, file not emitted

---

## dependency graph

```
phase.0: scaffold
    ‚îÇ
    ‚ñº
phase.1: core compression
    ‚îÇ
    ‚ñº
phase.2: batch and staleness
    ‚îÇ
    ‚ñº
phase.3: polish
    ‚îÇ
    ‚ñº
phase.4: integration
    ‚îÇ
    ‚ñº
phase.5: validation (future)
```

each phase must complete before the next begins. within each phase, steps are ordered by dependency.

---

## verification summary

| phase | verification command |
|-------|---------------------|
| 0 | `ls src/domain.roles/librarian/skills/brief.compress/` |
| 1 | `npm run test:integration -- brief.compress` |
| 2 | `npm run test:integration -- brief.compress` |
| 3 | `npm run test:integration -- brief.compress` |
| 4 | `npx rhachet run --skill brief.compress --help` |
| 5 | `npm run test:integration -- brief.compress --testNamePattern="validate"` |

---

## done criteria

the skill is complete when:

1. [ ] all phase 0-4 steps checked
2. [ ] all integration tests pass: `npm run test:integration -- brief.compress`
3. [ ] skill invocable via rhachet: `npx rhachet run --skill brief.compress path/to/brief.md`
4. [ ] compression achieves 2-4x token reduction on typical briefs
5. [ ] output follows turtle tree format

---

üê¢ roadmap complete ‚Äî ready to execute phase.0 üåä
