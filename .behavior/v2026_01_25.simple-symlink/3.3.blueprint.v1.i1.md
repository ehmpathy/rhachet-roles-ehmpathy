# blueprint: symlink skill

## blackbox criteria satisfied

- usecase.1 = create relative symlink ✓
- usecase.2 = create absolute symlink ✓
- usecase.3 = mode is required ✓
- usecase.4 = clear named args over positional ✓
- usecase.5 = default: fail fast if --at already exists ✓
- usecase.5a = idempotent findsert ✓
- usecase.5b = idempotent upsert ✓
- usecase.5c = --idem with non-symlink file ✓
- usecase.6 = handle --to doesn't exist ✓
- usecase.7 = create parent directories for --at ✓
- usecase.8 = safety within git repo ✓
- usecase.9 = help and usage ✓

## artifact location

```
src/domain.roles/mechanic/skills/claude.tools/symlink.sh
```

follows existing pattern alongside `cpsafe.sh`, `mvsafe.sh`, `rmsafe.sh`, `sedreplace.sh`

## contract

```
symlink.sh --at <path> --to <target> --mode <relative|absolute> [--idem <findsert|upsert>]
```

### required args

| arg | description |
|-----|-------------|
| `--at` | where to create the symlink |
| `--to` | what the symlink points to |
| `--mode` | `relative` or `absolute` |

### optional args

| arg | description |
|-----|-------------|
| `--idem findsert` | succeed if symlink exists and points to same target; fail if different |
| `--idem upsert` | overwrite existing symlink to match desired state |
| `--help` | show usage |

### exit codes

| code | meaning |
|------|---------|
| 0 | success |
| 1 | error (invalid args, path outside repo, etc.) |

## implementation structure

```bash
#!/usr/bin/env bash
set -euo pipefail

# 1. parse named arguments
#    - --at, --to, --mode (required)
#    - --idem (optional: findsert | upsert)
#    - --help
#    - ignore rhachet passthrough args (--repo, --role, --skill)

# 2. validate required args
#    - error if --at missing
#    - error if --to missing
#    - error if --mode missing or invalid

# 3. validate git repo context
#    - error if not in git repo
#    - error if --at resolves outside repo root

# 4. resolve paths
#    - resolve --at to absolute path
#    - resolve --to based on --mode:
#      - absolute: resolve to absolute path
#      - relative: compute relative path from --at's parent dir to --to

# 5. handle existing path at --at
#    - if nothing exists: proceed to create
#    - if regular file exists: always error (never delete files)
#    - if symlink exists:
#      - no --idem: error with hint about --idem options
#      - --idem findsert: compare targets, succeed if same, error if different
#      - --idem upsert: remove existing symlink, proceed to create

# 6. create parent directories for --at
#    - mkdir -p $(dirname "$AT_PATH")

# 7. check if --to target exists
#    - if not: emit warning but continue

# 8. create the symlink
#    - ln -s "$TARGET_PATH" "$AT_PATH"

# 9. emit success message
#    - show created symlink path
#    - show what it points to
#    - show mode used
```

## key implementation details

### relative path computation

for `--mode relative`, compute path from symlink's parent dir to target:

```bash
# resolve both paths to absolute
AT_ABS=$(realpath -m "$AT")
TO_ABS=$(realpath -m "$TO")

# get the directory where symlink will live
AT_DIR=$(dirname "$AT_ABS")

# compute relative path from symlink's dir to target
# use realpath --relative-to for this
TARGET_PATH=$(realpath --relative-to="$AT_DIR" "$TO_ABS")
```

### absolute path

for `--mode absolute`, just resolve to absolute:

```bash
TARGET_PATH=$(realpath -m "$TO")
```

### symlink comparison for --idem findsert

```bash
EXISTING_TARGET=$(readlink "$AT_ABS")

# normalize both for comparison
# handle relative vs absolute in existing symlink
if [[ "$EXISTING_TARGET" == /* ]]; then
  EXISTING_RESOLVED="$EXISTING_TARGET"
else
  EXISTING_RESOLVED=$(realpath -m "$AT_DIR/$EXISTING_TARGET")
fi

TARGET_RESOLVED=$(realpath -m "$TARGET_PATH")

if [[ "$EXISTING_RESOLVED" == "$TARGET_RESOLVED" ]]; then
  echo "symlink already exists with correct target"
  exit 0
else
  echo "error: symlink exists but points to different target"
  echo "  existing: $EXISTING_TARGET"
  echo "  requested: $TARGET_PATH"
  exit 1
fi
```

### error message with --idem hint

```bash
echo "error: symlink already exists at $AT"
echo "  points to: $(readlink "$AT_ABS")"
echo ""
echo "hint: use --idem findsert to succeed if target matches"
echo "hint: use --idem upsert to overwrite regardless"
exit 1
```

## test coverage

### integration test file

```
src/domain.roles/mechanic/skills/claude.tools/symlink.integration.test.ts
```

follows pattern from `sedreplace.integration.test.ts`

### test cases

```ts
given('[case1] create relative symlink')
  when('[t0] --mode relative is specified')
    then('symlink is created')
    then('readlink shows relative path')
    then('symlink resolves to correct target')

given('[case2] create absolute symlink')
  when('[t0] --mode absolute is specified')
    then('symlink is created')
    then('readlink shows absolute path')

given('[case3] mode is required')
  when('[t0] --mode is omitted')
    then('exits with error')
    then('error mentions --mode is required')

given('[case4] --at already exists')
  when('[t0] symlink exists, no --idem')
    then('exits with error')
    then('error mentions --idem options')
  when('[t1] symlink exists, --idem findsert, same target')
    then('succeeds silently')
  when('[t2] symlink exists, --idem findsert, different target')
    then('exits with error')
    then('shows existing vs requested target')
  when('[t3] symlink exists, --idem upsert')
    then('symlink is replaced')
    then('readlink shows new target')
  when('[t4] regular file exists, --idem upsert')
    then('exits with error')
    then('error mentions non-symlink file')

given('[case5] --to target doesn\'t exist')
  when('[t0] target path doesn\'t exist')
    then('symlink is still created')
    then('warning is emitted')

given('[case6] parent directory creation')
  when('[t0] parent of --at doesn\'t exist')
    then('parent directories are created')
    then('symlink is created')

given('[case7] safety boundary')
  when('[t0] --at would be outside git repo')
    then('exits with error')

given('[case8] help')
  when('[t0] --help is provided')
    then('shows usage')
    then('documents all args')
```

## permissions

add to `src/domain.roles/mechanic/inits/init.claude.permissions.jsonc`:

```jsonc
// symlink - create symlinks within repo
"Bash(npx rhachet run --skill symlink:*)"
```
