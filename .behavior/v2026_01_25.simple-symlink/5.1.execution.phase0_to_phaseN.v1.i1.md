# execution: symlink skill

## phase 0: scaffold + tests

- [x] create `src/domain.roles/mechanic/skills/claude.tools/symlink.sh` with header
- [x] create `src/domain.roles/mechanic/skills/claude.tools/symlink.integration.test.ts`
- [x] implement `runInTempGitRepo` test helper using `genTempDir`
- [x] add `set -euo pipefail` and arg parsing skeleton
- [x] implement --help
- [x] **test [case8]:** --help shows usage and documents all args

**status:** complete ✓

---

## phase 1: validation + tests

- [x] error if --at missing
- [x] error if --to missing
- [x] error if --mode missing
- [x] error if --mode not in (relative, absolute)
- [x] error if not in git repo
- [x] resolve --at to absolute path
- [x] error if --at resolves outside repo root
- [x] **test [case3]:** --mode omitted exits with error
- [x] **test [case7]:** --at outside repo exits with error

**status:** complete ✓

---

## phase 2: core symlink creation + tests

- [x] resolve --to based on --mode
- [x] create parent directories for --at
- [x] create symlink via `ln -s`
- [x] emit success message
- [x] **test [case1]:** relative symlink
- [x] **test [case2]:** absolute symlink
- [x] **test [case6]:** parent directory creation

**status:** complete ✓

---

## phase 3: existing path handling + tests

- [x] check if path exists at --at
- [x] if regular file: error
- [x] if symlink exists (no --idem): error with hints
- [x] **test [case4.t0]:** symlink exists, no --idem

**status:** complete ✓

---

## phase 4: idempotency + tests

- [x] --idem findsert implementation
- [x] --idem upsert implementation
- [x] both modes error on regular files
- [x] **test [case4.t1]:** findsert same target
- [x] **test [case4.t2]:** findsert different target
- [x] **test [case4.t3]:** upsert overwrites
- [x] **test [case4.t4]:** upsert refuses regular file

**status:** complete ✓

---

## phase 5: target warning + tests

- [x] check if --to target exists
- [x] emit warning if not
- [x] **test [case5]:** warning emitted, symlink created

**status:** complete ✓

---

## phase 6: permissions

- [x] add permission entry

**status:** complete ✓

---

## phase 7: build and verify

- [x] npm run build
- [x] npm run test:types
- [x] npm run test:integration:non-cicd -- symlink

**status:** complete ✓

---

## notes

- fixed bug: `realpath -m` follows symlinks; changed to `realpath -m -s` to preserve symlink paths
- fixed test helper: `execSync` doesn't capture stderr on success; switched to `spawnSync`
- added: `--to` must also be within git repo (not just `--at`); test [case7.t1] added
