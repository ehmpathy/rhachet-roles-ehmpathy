# roadmap: symlink skill

## phase 0: scaffold + tests
> create skill file and integration test file together (TDD)

- [ ] create `src/domain.roles/mechanic/skills/claude.tools/symlink.sh` with header
- [ ] create `src/domain.roles/mechanic/skills/claude.tools/symlink.integration.test.ts`
- [ ] implement `runInTempGitRepo` test helper using `genTempDir` from test-fns:
  ```ts
  import { genTempDir } from 'test-fns';

  const runInTempGitRepo = (args: { files?: Record<string, string>; symlinkArgs: string }) => {
    const tempDir = genTempDir({ slug: 'symlink-test' });
    execSync('git init', { cwd: tempDir });
    // ... setup files, run command, return result
  };
  ```
- [ ] add `set -euo pipefail` and arg parsing skeleton
- [ ] implement --help
- [ ] **test [case8]:** --help shows usage and documents all args

**verify:** `npm run test:integration -- symlink.integration.test.ts` passes for [case8]

---

## phase 1: validation + tests
> validate required args and git repo context

- [ ] error if --at missing
- [ ] error if --to missing
- [ ] error if --mode missing
- [ ] error if --mode not in (relative, absolute)
- [ ] error if not in git repo
- [ ] resolve --at to absolute path
- [ ] error if --at resolves outside repo root
- [ ] **test [case3]:** --mode omitted exits with error, mentions --mode required
- [ ] **test [case7]:** --at outside repo exits with error

**verify:** `npm run test:integration -- symlink.integration.test.ts` passes for [case3], [case7]

---

## phase 2: core symlink creation + tests
> implement basic symlink creation for both modes

- [ ] resolve --to based on --mode:
  - absolute: `realpath -m "$TO"`
  - relative: `realpath --relative-to="$AT_DIR" "$TO_ABS"`
- [ ] create parent directories for --at via `mkdir -p`
- [ ] create symlink via `ln -s "$TARGET_PATH" "$AT_ABS"`
- [ ] emit success message with path, target, mode
- [ ] **test [case1]:** relative symlink created, readlink shows relative path
- [ ] **test [case2]:** absolute symlink created, readlink shows absolute path
- [ ] **test [case6]:** parent directories created automatically

**verify:** `npm run test:integration -- symlink.integration.test.ts` passes for [case1], [case2], [case6]

---

## phase 3: existing path handling + tests
> fail fast when --at already exists, with --idem hint

- [ ] check if path exists at --at
- [ ] if regular file: error "non-symlink file exists"
- [ ] if symlink exists (no --idem): error with hint about --idem options
- [ ] error message includes what exists and points to
- [ ] **test [case4.t0]:** symlink exists, no --idem → error with --idem hints

**verify:** `npm run test:integration -- symlink.integration.test.ts` passes for [case4.t0]

---

## phase 4: idempotency + tests
> implement findsert and upsert behaviors

- [ ] --idem findsert:
  - compare resolved targets (normalize relative vs absolute)
  - if same: succeed silently, exit 0
  - if different: error with existing vs requested
- [ ] --idem upsert:
  - if symlink exists: remove it
  - proceed to create new symlink
- [ ] both --idem modes: still error on regular files (never delete)
- [ ] **test [case4.t1]:** --idem findsert, same target → succeeds
- [ ] **test [case4.t2]:** --idem findsert, different target → error with comparison
- [ ] **test [case4.t3]:** --idem upsert → symlink replaced
- [ ] **test [case4.t4]:** regular file exists, --idem upsert → error

**verify:** `npm run test:integration -- symlink.integration.test.ts` passes for [case4.t1-t4]

---

## phase 5: target warning + tests
> warn but continue if --to doesn't exist

- [ ] check if resolved --to path exists
- [ ] if not: emit warning to stderr
- [ ] continue to create symlink anyway
- [ ] **test [case5]:** --to doesn't exist → warning emitted, symlink still created

**verify:** `npm run test:integration -- symlink.integration.test.ts` passes for [case5]

---

## phase 6: permissions
> register skill in permissions

- [ ] add to `src/domain.roles/mechanic/inits/init.claude.permissions.jsonc`:
  ```jsonc
  // symlink - create symlinks within repo
  "Bash(npx rhachet run --skill symlink:*)"
  ```

**verify:** `grep -r "symlink" src/domain.roles/mechanic/inits/` shows entry

---

## phase 7: build and verify
> end-to-end verification via tests only

- [ ] `npm run build`
- [ ] `npm run test:types`
- [ ] `npm run test:integration -- symlink.integration.test.ts`

**verify:** all commands exit 0

---

## summary

| phase | description | depends on |
|-------|-------------|------------|
| 0 | scaffold + tests | - |
| 1 | validation + tests | 0 |
| 2 | core creation + tests | 1 |
| 3 | existing path + tests | 2 |
| 4 | idempotency + tests | 3 |
| 5 | target warning + tests | 2 |
| 6 | permissions | 0 |
| 7 | build and verify | 4, 5, 6 |
