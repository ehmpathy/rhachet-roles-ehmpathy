# execution: websearch.border.guard

## progress tracker

| phase | description | status |
|-------|-------------|--------|
| 0 | setup | âœ… done |
| 1 | domain.operations (deterministic) | âœ… done |
| 2 | domain.operations (probabilistic) | âœ… done |
| 3 | contract/cli | âœ… done |
| 4 | hook integration | âœ… done |
| 5 | acceptance tests | âœ… done |
| 6 | integration tests | âœ… done |
| 7 | end-to-end verification | ðŸ”„ active |

---

## phase 0: setup

### tasks

- [x] create `.quarantine/.gitignore` with `*`
- [x] verify `rhachet-brains-xai` dependency available (v0.2.0 installed)
- [x] note: `XAI_API_KEY` must be configured by human

### verification

```sh
# .quarantine/.gitignore exists
cat .quarantine/.gitignore | grep -q '*'

# XAI_API_KEY is set (human responsibility)
test -n "$XAI_API_KEY" && echo "XAI_API_KEY configured"
```

### execution log

- `.quarantine/.gitignore` created with `*`
- `rhachet-brains-xai@0.2.0` confirmed installed
- `XAI_API_KEY` â€” human must configure in their environment

---

## phase 1: domain.operations (deterministic)

### tasks

- [x] create `src/domain.operations/guardBorder/computeIsUrlAdmissible.ts`
- [x] create `src/domain.operations/guardBorder/computeIsUrlAdmissible.test.ts`
- [x] create `src/domain.operations/guardBorder/setContentToQuarantine.ts`
- [x] create `src/domain.operations/guardBorder/setContentToQuarantine.test.ts`

### execution log

- `computeIsUrlAdmissible.ts` â€” blocks localhost, private IPs (10.x, 172.16-31.x, 192.168.x, 169.254.x), IPv6 private (fc00:, fe80:)
- `computeIsUrlAdmissible.test.ts` â€” 15 tests passed
- `setContentToQuarantine.ts` â€” writes JSON with metadata to quarantine dir
- `setContentToQuarantine.test.ts` â€” 4 tests passed

---

## phase 2: domain.operations (probabilistic)

### tasks

- [x] create `src/domain.operations/guardBorder/imagineIsContentAdmissible.ts`
- [x] create `src/domain.operations/guardBorder/imagineIsContentAdmissible.test.ts`
- [x] create `src/domain.operations/guardBorder/decideIsContentAdmissible.ts`
- [x] create `src/domain.operations/guardBorder/decideIsContentAdmissible.test.ts`
- [x] create `src/domain.operations/guardBorder/decideIsContentAdmissibleOnWebfetch.ts`
- [x] create `src/domain.operations/guardBorder/decideIsContentAdmissibleOnWebfetch.test.ts`

### execution log

- `imagineIsContentAdmissible.ts` â€” binary detection, size limit, brain.ask for classification
- `imagineIsContentAdmissible.test.ts` â€” 6 tests passed (binary, size, allow, block, truncation)
- `decideIsContentAdmissible.ts` â€” orchestrates url check, content check, quarantine
- `decideIsContentAdmissible.test.ts` â€” 7 tests passed
- `decideIsContentAdmissibleOnWebfetch.ts` â€” adapter for webfetch PostToolUse format
- `decideIsContentAdmissibleOnWebfetch.test.ts` â€” 4 tests passed

---

## phase 3: contract/cli

### tasks

- [x] create `src/contract/cli/guardBorder.onWebfetch.ts`
- [x] create `src/contract/cli/index.ts` to export CLI
- [x] update `src/index.ts` to export cli object
- [x] add `zod` as direct dependency

### execution log

- `guardBorder.onWebfetch.ts` â€” CLI entry point, reads stdin, calls domain operation
- `src/contract/cli/index.ts` â€” exports guardBorderOnWebfetch
- `src/index.ts` â€” exports cli namespace
- added `zod@4.3.4` as direct dependency for schema definition
- build verified successful

---

## phase 4: hook integration

### tasks

- [x] create `src/domain.roles/mechanic/inits/claude.hooks/posttooluse.guardBorder.onWebfetch.sh`
- [x] update `src/domain.roles/mechanic/getMechanicRole.ts` with PostToolUse hook
- [x] update `src/domain.roles/mechanic/inits/init.claude.permissions.jsonc`

### execution log

- `posttooluse.guardBorder.onWebfetch.sh` â€” thin shell wrapper delegates to TypeScript CLI via node esm import
- `getMechanicRole.ts` â€” added PostToolUse hook with `filter: { what: 'WebFetch', when: 'after' }`, timeout 60s
- `init.claude.permissions.jsonc` â€” replaced domain-specific WebFetch entries with full `WebFetch` allow (border guard inspects all), added `Read(.quarantine/*)` to deny list
- build verified successful

---

## phase 5: acceptance tests

### tasks

- [x] create acceptance test for guardBorder hook

### execution log

- `guardBorderOnWebfetch.acceptance.test.ts` â€” blackbox tests that invoke the shell hook directly
- covers: safe content (allow), prompt injection (block), localhost/private IPs (block), binary content (block), oversized content (block), API key check, quarantine metadata
- note: collocated at `src/domain.operations/guardBorder/` rather than `blackbox/` dir since this repo uses colocation pattern

---

## phase 6: integration tests

### tasks

- [x] create `imagineIsContentAdmissible.integration.test.ts` with real xAI API call
- [x] add XAI_API_KEY to required apikeys in `.agent/repo=.this/role=any/skills/use.apikeys.json`

### execution log

- `imagineIsContentAdmissible.integration.test.ts` â€” tests against real xAI Grok API
- covers: safe docs (allow), prompt injection (block), social manipulation (block), normal technical content (allow)
- `use.apikeys.json` updated to require XAI_API_KEY for integration tests
- note: tests skip automatically if XAI_API_KEY not set

---

## phase 7: end-to-end verification

### tasks

- [ ] ensure .quarantine/.gitignore exists
- [ ] verify full flow with manual test
- [ ] all tests pass

### execution log

<!-- execution details will be added below -->

