# research: templates for websearch.border.guard

## template.1 = rhachet-roles-bhuild portable skill pattern

### what

a pattern for skills that require more logic than shell alone can provide, used by rhachet-roles-bhuild for behavior-driven development skills.

### pattern overview

```
skill.sh (thin wrapper)
    â†“
node -e "import('package').then(m => m.cli.method())"
    â†“
src/contract/cli/method.ts (CLI entry point)
    â†“
src/domain.operations/* (business logic)
```

### skill.sh â€” thin bash wrapper

```bash
# from rhachet-roles-bhuild/src/domain.roles/behaver/skills/init.behavior.sh [1]
#!/usr/bin/env bash
set -euo pipefail

exec node -e "import('rhachet-roles-bhuild').then(m => m.cli.initBehavior())" -- "$@"
```

key points:
- passes all args via `-- "$@"`
- dispatches to TypeScript immediately
- no bash logic beyond the dispatch

### contract/cli/*.ts â€” CLI entry point

```ts
// from rhachet-roles-bhuild/src/contract/cli/init.behavior.ts [2]
import { z } from 'zod';
import { getCliArgs } from '@src/infra/cli';
import { initBehaviorDir } from '@src/domain.operations/behavior/init';

const schemaOfArgs = z.object({
  named: z.object({
    name: z.string(),
    dir: z.string().optional(),
    // rhachet passthrough args (optional, ignored)
    repo: z.string().optional(),
    role: z.string().optional(),
    skill: z.string().optional(),
  }),
  ordered: z.array(z.string()).default([]),
});

export const initBehavior = (): void => {
  const { named } = getCliArgs({ schema: schemaOfArgs });
  // ... validation and domain.operations calls
};
```

key points:
- zod schema for args parse
- handles rhachet passthrough args (repo, role, skill)
- calls domain.operations for business logic

### src/index.ts â€” cli export

```ts
// from rhachet-roles-bhuild/src/index.ts [3]
import { withEmojiSpaceShim } from 'emoji-space-shim';
import { initBehavior } from './contract/cli/init.behavior';

export const cli = {
  initBehavior: () => withEmojiSpaceShim({ logic: async () => initBehavior() }),
};
```

key points:
- exports `cli` object with all CLI methods
- wraps in emoji-space-shim for output format
- enables dispatch via `import('package').then(m => m.cli.method())`

### relation to wish

border guard will need:
- network call to brain.atom for content inspection
- complex decision logic (url validation, content type checks, size limits)
- quarantine file writes with metadata

this is beyond what shell can cleanly handle â†’ use bhuild pattern.

### decision

ADOPT â€” create borderGuard skill with:
- `posttooluse.border-guard.sh` â€” thin bash wrapper
- `src/contract/cli/borderGuard.ts` â€” CLI entry point
- `src/domain.operations/borderGuard/*` â€” inspection logic
- export via `cli.borderGuard` in src/index.ts

---

## template.2 = PostToolUse hook stdin format

### what

Claude Code passes tool response data to PostToolUse hooks via stdin JSON.

### pattern

```json
{
  "tool_name": "WebFetch",
  "tool_input": {
    "url": "https://example.com/page",
    "prompt": "extract the main content"
  },
  "tool_response": "... the fetched and processed content ...",
  "tool_use_id": "toolu_01ABC123...",
  "session_id": "abc123"
}
```

key fields for border guard:
- `tool_name` â€” "WebFetch" or "WebSearch"
- `tool_input.url` â€” the url that was fetched (for WebFetch)
- `tool_response` â€” the content to inspect

### exit code semantics

same as PreToolUse:
- `exit 0` â€” allow content to reach agent
- `exit 2` â€” block content, show stderr to agent

### relation to wish

PostToolUse hook will:
1. read stdin JSON
2. extract tool_response
3. invoke border guard inspection
4. exit 0 (allow) or exit 2 (block with message)

---

## template.3 = acceptance test pattern

### what

blackbox tests that invoke skills via `npx rhachet run` and assert on output and side effects.

### directory structure

```
blackbox/
  role=behaver/
    skill.init.behavior.acceptance.test.ts
    skill.review.behavior.acceptance.test.ts
  .test/
    infra/
      genTestGitRepo.ts
      genConsumerRepo.ts
      runRhachetSkill.ts
      index.ts
```

### test infra â€” runRhachetSkill helper

```ts
// from rhachet-roles-bhuild/blackbox/.test/infra/runRhachetSkill.ts [4]
export const runRhachetSkill = (input: {
  repo: string;
  role?: string;
  skill: string;
  args?: string;
  repoDir: string;
}): SkillResult => {
  const args = input.args ? `-- ${input.args}` : '';
  const roleFlag = input.role ? `--role ${input.role}` : '';

  try {
    const stdout = execSync(
      `npx rhachet run --repo ${input.repo} ${roleFlag} --skill ${input.skill} ${args}`,
      { cwd: input.repoDir, encoding: 'utf-8' },
    );
    return { stdout: stdout.trim(), exitCode: 0 };
  } catch (error) {
    // ... handle error and return exitCode
  }
};
```

### test structure â€” given/when/then with BDD

```ts
// from rhachet-roles-bhuild/blackbox/role=behaver/skill.init.behavior.acceptance.test.ts [5]
describe('init.behavior', () => {
  given('[case1] consumer: fresh consumer repo on main branch', () => {
    let consumer: ConsumerRepo;

    beforeAll(() => {
      consumer = genConsumerRepo({ prefix: 'init-behavior-test-' });
    });

    afterAll(() => {
      consumer.cleanup();
    });

    when('[t0] init.behavior --name test-feature is invoked', () => {
      then('creates behavior directory with scaffold files', () => {
        runInitBehaviorSkillViaRhachet({
          behaviorName: 'scaffold-test',
          repoDir: consumer.repoDir,
        });

        const behaviorRoot = path.join(consumer.repoDir, '.behavior');
        expect(fs.existsSync(behaviorRoot)).toBe(true);
      });

      then('outputs success message', () => {
        const result = runInitBehaviorSkillViaRhachet({...});
        expect(result.output).toContain('ðŸ¦« oh, behave!');
      });
    });
  });
});
```

### key patterns

- **blackbox/** directory at repo root for acceptance tests
- **runRhachetSkill** â€” invoke via `npx rhachet run` as consumer would
- **given/when/then** from test-fns for BDD structure
- **[caseN]/[tN]** labels for test organization

### prescription: use genTempDir from test-fns

bhuild uses custom `genConsumerRepo`/`genTestGitRepo` helpers. we should prefer `genTempDir` from test-fns instead:

```ts
// from rhachet-roles-ehmpathy/src/domain.roles/mechanic/skills/claude.tools/cpsafe.integration.test.ts [6]
import { genTempDir, given, then, when } from 'test-fns';

given('[case1] content is safe', () => {
  // genTempDir creates a temp directory and returns the path string
  // options: { slug: string, git?: boolean }
  // when git: true, initializes git repo with user.email and user.name
  const tempDir = genTempDir({ slug: 'border-guard-test', git: true });

  when('[t0] border guard inspects', () => {
    then('returns allow decision', async () => {
      // tempDir is a string path, use directly
      const quarantinePath = path.join(tempDir, '.quarantine');
      // ...
    });
  });
});
```

api:
- `genTempDir({ slug: string })` â€” creates temp dir with slug prefix
- `genTempDir({ slug: string, git: true })` â€” creates temp dir AND initializes git repo
- returns `string` â€” the path to the temp directory

benefits:
- built into test-fns (no custom infra needed)
- `git: true` option handles git init with user config
- simpler than custom infra

### relation to wish

border guard acceptance tests will:
- use `genTempDir` for quarantine directory tests
- invoke PostToolUse hook with mock stdin
- assert on allow/block decisions and quarantine file creation

### decision

ADOPT â€” create `blackbox/role=mechanic/` for border guard acceptance tests, use `genTempDir` from test-fns.

---

## summary

| template | source | use for |
|----------|--------|---------|
| portable skill pattern | rhachet-roles-bhuild | borderGuard skill with TypeScript logic |
| PostToolUse stdin format | Claude Code docs | hook implementation |
| acceptance test pattern | rhachet-roles-bhuild | blackbox tests for border guard |

---

## citations

[1] https://github.com/ehmpathy/rhachet-roles-bhuild/blob/main/src/domain.roles/behaver/skills/init.behavior.sh
[2] https://github.com/ehmpathy/rhachet-roles-bhuild/blob/main/src/contract/cli/init.behavior.ts
[3] https://github.com/ehmpathy/rhachet-roles-bhuild/blob/main/src/index.ts
[4] https://github.com/ehmpathy/rhachet-roles-bhuild/blob/main/blackbox/.test/infra/runRhachetSkill.ts
[5] https://github.com/ehmpathy/rhachet-roles-bhuild/blob/main/blackbox/role=behaver/skill.init.behavior.acceptance.test.ts
[6] src/domain.roles/mechanic/skills/claude.tools/cpsafe.integration.test.ts (local)
