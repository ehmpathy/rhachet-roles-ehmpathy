# roadmap: websearch.border.guard

## overview

checklist for execution of the border guard blueprint. each phase has:
- prerequisites (briefs to read)
- tasks (ordered by dependency)
- verification (behavioral acceptance criteria)

---

## phase 0: setup

### prerequisites
- [ ] read: `3.3.blueprint.v1.i1.md` (architecture overview)

### tasks
- [ ] create `.quarantine/.gitignore` with `*` to ignore quarantined content
- [ ] add `XAI_API_KEY` to local environment (e.g., `.env.local` or shell profile)
- [ ] verify `rhachet-brains-xai` is installed: `npm list rhachet-brains-xai`

### verification
```sh
# .quarantine/.gitignore exists
cat .quarantine/.gitignore | grep -q '*'

# XAI_API_KEY is set
test -n "$XAI_API_KEY" && echo "XAI_API_KEY configured"
```

---

## phase 1: domain.operations (deterministic)

### prerequisites
- [ ] read: `3.1.research.patterns._.code.prod.v1.i1.md` (prod code patterns)
- [ ] read: `3.1.research.domain.terms.v1.i1.md` (ubiquitous language)

### tasks (ordered)

#### 1.1 computeIsUrlAdmissible
- [ ] create `src/domain.operations/guardBorder/computeIsUrlAdmissible.ts`
- [ ] create `src/domain.operations/guardBorder/computeIsUrlAdmissible.test.ts`

**verification:**
```sh
npm run test:unit -- computeIsUrlAdmissible
```

**acceptance criteria:**
- [ ] `localhost` returns `false`
- [ ] `127.0.0.1` returns `false`
- [ ] `192.168.x.x` returns `false`
- [ ] `10.x.x.x` returns `false`
- [ ] `172.16.x.x` returns `false`
- [ ] `https://github.com` returns `true`

#### 1.2 setContentToQuarantine
- [ ] create `src/domain.operations/guardBorder/setContentToQuarantine.ts`
- [ ] create `src/domain.operations/guardBorder/setContentToQuarantine.test.ts`

**verification:**
```sh
npm run test:unit -- setContentToQuarantine
```

**acceptance criteria:**
- [ ] creates `.quarantine/` directory if not exists
- [ ] writes JSON file with `quarantinedAt`, `reason`, `url`, `toolName`, `sessionId`, `content`
- [ ] filename follows `{timestamp}.{sessionId}.json` pattern

---

## phase 2: domain.operations (probabilistic)

### prerequisites
- [ ] read: `3.1.research.templates._.v1.i1.md` (portable skill pattern)
- [ ] phase 1 complete

### tasks (ordered)

#### 2.1 imagineIsContentAdmissible
- [ ] create `src/domain.operations/guardBorder/imagineIsContentAdmissible.ts`
- [ ] create `src/domain.operations/guardBorder/imagineIsContentAdmissible.test.ts` (mock brain.choice)

**verification:**
```sh
npm run test:unit -- imagineIsContentAdmissible
```

**acceptance criteria:**
- [ ] truncates content to 2000 chars for inspection
- [ ] returns `{ decision: 'block', reason: 'binary content cannot be inspected' }` for binary
- [ ] returns `{ decision: 'block', reason: 'content too large for inspection' }` for >100KB
- [ ] calls `context.brain.choice.ask` with proper schema
- [ ] returns allow/block decision from brain response

#### 2.2 decideIsContentAdmissible (orchestrator)
- [ ] create `src/domain.operations/guardBorder/decideIsContentAdmissible.ts`
- [ ] create `src/domain.operations/guardBorder/decideIsContentAdmissible.test.ts`

**verification:**
```sh
npm run test:unit -- decideIsContentAdmissible
```

**acceptance criteria:**
- [ ] calls `computeIsUrlAdmissible` first if url provided
- [ ] short-circuits to block if url not admissible
- [ ] calls `imagineIsContentAdmissible` for content check
- [ ] calls `setContentToQuarantine` if decision is block
- [ ] returns `{ decision, reason }` shape

#### 2.3 decideIsContentAdmissibleOnWebfetch (adapter)
- [ ] create `src/domain.operations/guardBorder/decideIsContentAdmissibleOnWebfetch.ts`
- [ ] create `src/domain.operations/guardBorder/decideIsContentAdmissibleOnWebfetch.test.ts`

**verification:**
```sh
npm run test:unit -- decideIsContentAdmissibleOnWebfetch
```

**acceptance criteria:**
- [ ] adapts `toolInput.url` to `url` parameter
- [ ] adapts `toolResponse` to `content` parameter
- [ ] passes `toolName` and `sessionId` as metadata

---

## phase 3: contract/cli

### prerequisites
- [ ] read: `3.1.research.templates._.v1.i1.md` (CLI entry pattern)
- [ ] phase 2 complete

### tasks (ordered)

#### 3.1 guardBorderOnWebfetch CLI
- [ ] create `src/contract/cli/guardBorder.onWebfetch.ts`
- [ ] export `guardBorderOnWebfetch` from `src/contract/cli/index.ts`
- [ ] export `cli.guardBorderOnWebfetch` from `src/index.ts`

**verification:**
```sh
# verify export exists
node -e "import('rhachet-roles-ehmpathy').then(m => console.log(typeof m.cli.guardBorderOnWebfetch))"
# should print: function
```

**acceptance criteria:**
- [ ] failfast if `XAI_API_KEY` not set (exit 2, helpful message)
- [ ] reads stdin JSON
- [ ] calls `decideIsContentAdmissibleOnWebfetch`
- [ ] exits 0 if allow
- [ ] exits 2 with stderr message if block

---

## phase 4: hook integration

### prerequisites
- [ ] read: `3.1.research.patterns._.code.prod.v1.i1.md` (hook registration)
- [ ] phase 3 complete

### tasks (ordered)

#### 4.1 posttooluse shell wrapper
- [ ] create `src/domain.roles/mechanic/inits/claude.hooks/posttooluse.guardBorder.onWebfetch.sh`
- [ ] make executable: `chmod +x`

**verification:**
```sh
# verify executable exists
test -x src/domain.roles/mechanic/inits/claude.hooks/posttooluse.guardBorder.onWebfetch.sh
```

#### 4.2 hook registration
- [ ] update `src/domain.roles/mechanic/getMechanicRole.ts` with PostToolUse hook entry
  - command: `./node_modules/.bin/rhachet run --repo ehmpathy --role mechanic --init claude.hooks/posttooluse.guardBorder.onWebfetch`
  - timeout: `PT60S`
  - filter: `{ what: 'WebFetch', when: 'after' }`

**verification:**
```sh
# verify hook registered
grep -q "posttooluse.guardBorder.onWebfetch" src/domain.roles/mechanic/getMechanicRole.ts
```

#### 4.3 permissions update
- [ ] update `src/domain.roles/mechanic/inits/init.claude.permissions.jsonc`:
  - add `"WebSearch"` to allow
  - add `"WebFetch"` to allow
  - remove domain-specific WebFetch allowlist
  - add `"Read(.quarantine/*)"` to deny

**verification:**
```sh
# verify permissions
grep -q '"WebFetch"' src/domain.roles/mechanic/inits/init.claude.permissions.jsonc
grep -q 'Read(.quarantine' src/domain.roles/mechanic/inits/init.claude.permissions.jsonc
```

---

## phase 5: acceptance tests

### prerequisites
- [ ] read: `2.1.criteria.blackbox.md` (blackbox criteria)
- [ ] read: `3.1.research.templates._.v1.i1.md` (acceptance test pattern)
- [ ] phase 4 complete

### tasks
- [ ] create `blackbox/role=mechanic/guardBorder.acceptance.test.ts`
- [ ] implement `genWebfetchStdin` helper for realistic stdin
- [ ] implement all test cases:
  - [ ] case1: safe content (npm readme) → exit 0, no quarantine
  - [ ] case2: prompt injection → exit 2, quarantine created
  - [ ] case3: localhost url (SSRF) → exit 2, url not admissible
  - [ ] case4: private IP url → exit 2
  - [ ] case5: binary content → exit 2, binary message
  - [ ] case6: oversized content → exit 2, too large message
  - [ ] case7: XAI_API_KEY unset → exit 2, asks human to configure

**verification:**
```sh
npm run test:acceptance -- guardBorder
```

**acceptance criteria:**
- [ ] all 7 cases pass
- [ ] realistic PostToolUse stdin format verified

---

## phase 6: integration tests

### prerequisites
- [ ] `XAI_API_KEY` configured in environment
- [ ] phase 5 complete

### tasks
- [ ] create `src/domain.operations/guardBorder/imagineIsContentAdmissible.integration.test.ts`
- [ ] test with real xAI API call

**verification:**
```sh
npm run test:integration -- imagineIsContentAdmissible
```

**acceptance criteria:**
- [ ] safe documentation content returns `allow`
- [ ] prompt injection content returns `block`
- [ ] response includes reason when blocked

---

## phase 7: end-to-end verification

### prerequisites
- [ ] all phases complete
- [ ] `npm run build` passes
- [ ] `npx rhachet roles link --role mechanic`
- [ ] `npx rhachet roles init --role mechanic`

### manual verification

#### test 1: absent API key behavior
```sh
# unset key temporarily
unset XAI_API_KEY

# attempt webfetch via claude code
# expected: block message with instructions to add XAI_API_KEY
```

#### test 2: safe content passthrough
```sh
export XAI_API_KEY=your-key

# attempt webfetch of github readme
# expected: content reaches agent without prompt
```

#### test 3: quarantine on block
```sh
# attempt webfetch of suspicious content
# expected: block message, file in .quarantine/
ls .quarantine/
```

---

## summary checklist

| phase | description | status |
|-------|-------------|--------|
| 0 | setup | [ ] |
| 1 | domain.operations (deterministic) | [ ] |
| 2 | domain.operations (probabilistic) | [ ] |
| 3 | contract/cli | [ ] |
| 4 | hook integration | [ ] |
| 5 | acceptance tests | [ ] |
| 6 | integration tests | [ ] |
| 7 | end-to-end verification | [ ] |
