# roadmap: proactive forbidden term enforcement

## .overview

ordered execution checklist for implementing the forbidden term blocklist feature.

**legend:**
- `[ ]` = pending
- `[~]` = in progress
- `[x]` = complete
- `deps:` = must complete before this step
- `verify:` = behavioral acceptance verification command/check

---

## phase 1: rename gerunds hook for consistency

### step 1.1: rename gerunds hook file

- [ ] rename `pretooluse.forbid-gerunds.sh` → `pretooluse.forbid-terms.gerunds.sh`

**deps:** none

**acceptance criteria:**
- file exists at new path
- file does not exist at old path

**verify:**
```bash
# should exist
ls src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.gerunds.sh

# should not exist
! ls src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.sh 2>/dev/null
```

---

### step 1.2: rename gerunds test file

- [ ] rename `pretooluse.forbid-gerunds.test.sh` → `pretooluse.forbid-terms.gerunds.test.sh`

**deps:** none (parallel with 1.1)

**acceptance criteria:**
- file exists at new path
- file does not exist at old path

**verify:**
```bash
# should exist
ls src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.gerunds.test.sh

# should not exist
! ls src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.test.sh 2>/dev/null
```

---

### step 1.3: rename gerunds allowlist file

- [ ] rename `gerunds.allowlist.jsonc` → `terms.gerunds.allowlist.jsonc`

**deps:** none (parallel with 1.1, 1.2)

**acceptance criteria:**
- file exists at new path
- file does not exist at old path

**verify:**
```bash
# should exist
ls src/domain.roles/mechanic/inits/claude.hooks/terms.gerunds.allowlist.jsonc

# should not exist
! ls src/domain.roles/mechanic/inits/claude.hooks/gerunds.allowlist.jsonc 2>/dev/null
```

---

### step 1.4: update internal references in gerunds hook

- [ ] update `ALLOWLIST_FILE` path to `terms.gerunds.allowlist.jsonc`
- [ ] update `NUDGE_FILE` name to `terms.gerunds.nudges.local.json`

**deps:** 1.1, 1.3

**acceptance criteria:**
- hook references correct allowlist filename
- hook creates nudge file with correct name

**verify:**
```bash
# check allowlist reference
grep -q "terms.gerunds.allowlist.jsonc" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.gerunds.sh

# check nudge file reference
grep -q "terms.gerunds.nudges" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.gerunds.sh
```

---

### step 1.5: update internal references in gerunds test

- [ ] update `HOOK_SCRIPT` path to `pretooluse.forbid-terms.gerunds.sh`
- [ ] update nudge file cleanup path

**deps:** 1.2, 1.4

**acceptance criteria:**
- test references correct hook filename
- test cleans up correct nudge file

**verify:**
```bash
# check hook reference
grep -q "pretooluse.forbid-terms.gerunds.sh" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.gerunds.test.sh

# check nudge file reference
grep -q "terms.gerunds.nudges" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.gerunds.test.sh
```

---

### step 1.6: verify renamed gerunds hook tests pass

- [ ] run gerunds test suite

**deps:** 1.5

**acceptance criteria:**
- all gerunds tests pass
- no regressions from rename

**verify:**
```bash
cd src/domain.roles/mechanic/inits/claude.hooks && bash pretooluse.forbid-terms.gerunds.test.sh
# expect: all tests pass, exit 0
```

---

## phase 2: create blocklist configuration

### step 2.1: create terms.blocklist.jsonc

- [ ] create `terms.blocklist.jsonc` with initial "script" entry
- [ ] include `term`, `why`, and `alt` fields

**deps:** none (can start parallel with phase 1)

**acceptance criteria:**
- file exists with valid JSONC
- contains "script" term entry
- `why` explains rationale
- `alt` provides alternatives

**verify:**
```bash
# file exists
ls src/domain.roles/mechanic/inits/claude.hooks/terms.blocklist.jsonc

# valid JSON after stripping comments
sed 's|//.*||' src/domain.roles/mechanic/inits/claude.hooks/terms.blocklist.jsonc | jq .

# has script entry
sed 's|//.*||' src/domain.roles/mechanic/inits/claude.hooks/terms.blocklist.jsonc | jq -e '.terms[] | select(.term == "script")'
```

---

## phase 3: implement blocklist hook

### step 3.1: create blocklist hook shell script

- [ ] create `pretooluse.forbid-terms.blocklist.sh`
- [ ] implement stdin JSON parsing
- [ ] implement Write/Edit tool filtering
- [ ] implement content extraction

**deps:** 2.1

**acceptance criteria:**
- script exists and is executable
- parses stdin JSON correctly
- extracts tool_name and tool_input

**verify:**
```bash
# file exists and is executable
ls -la src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh | grep -q "x"

# has proper header
head -20 src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh | grep -q ".what"
```

---

### step 3.2: implement blocklist config loading

- [ ] load `terms.blocklist.jsonc`
- [ ] strip JSONC comments
- [ ] parse terms array

**deps:** 3.1

**acceptance criteria:**
- loads config file correctly
- handles missing config gracefully (exit 0)
- parses all term entries

**verify:**
```bash
# config loading code exists
grep -q "terms.blocklist.jsonc" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh

# comment stripping exists
grep -q "sed.*//.*" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh
```

---

### step 3.3: implement term detection with word boundaries

- [ ] scan content for each blocklisted term
- [ ] use word boundary matching (`\b`)
- [ ] case-insensitive matching

**deps:** 3.2

**acceptance criteria:**
- detects exact term matches
- does not match substrings (e.g., "typescript" should not match "script")
- matches regardless of case

**verify:**
```bash
# word boundary grep exists
grep -qE "grep.*\\\\b" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh

# case-insensitive flag exists
grep -qE "grep.*-i" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh
```

---

### step 3.4: implement HARDNUDGE pattern

- [ ] create/load nudge file (`terms.blocklist.nudges.local.json`)
- [ ] generate nudge key via sha256(file_path:term)
- [ ] check 5-minute retry window
- [ ] record attempt timestamp on block
- [ ] cleanup stale entries (1 hour)

**deps:** 3.3

**acceptance criteria:**
- blocks on first attempt
- allows retry within 5 minutes
- cleans up old entries

**verify:**
```bash
# nudge file reference exists
grep -q "terms.blocklist.nudges" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh

# 5 minute window (300 seconds)
grep -q "300" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh

# sha256 for key generation
grep -q "sha256sum" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh
```

---

### step 3.5: implement block message with why and alternatives

- [ ] output file path
- [ ] output detected term
- [ ] output `why` from config
- [ ] output `alt` from config
- [ ] exit 2 on block

**deps:** 3.4

**acceptance criteria:**
- block message includes file path
- block message includes term
- block message includes rationale
- block message includes alternatives
- exits with code 2

**verify:**
```bash
# check for block message components
grep -q "BLOCKED" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh
grep -q "why:" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh
grep -q "alt:" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh
grep -q "exit 2" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh
```

---

## phase 4: test coverage for blocklist hook

### step 4.1: create blocklist test file structure

- [ ] create `pretooluse.forbid-terms.blocklist.test.sh`
- [ ] add header documentation
- [ ] add test utilities (build JSON, assert functions)

**deps:** 3.5

**acceptance criteria:**
- test file exists and is executable
- has proper header
- has test utilities

**verify:**
```bash
# file exists and is executable
ls -la src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.test.sh | grep -q "x"

# has header
head -20 src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.test.sh | grep -q ".what"
```

---

### step 4.2: implement [case1] Write with blocklisted term blocks

- [ ] test: Write with "script" blocks on first attempt
- [ ] verify: exit code 2
- [ ] verify: output contains term, why, alt

**deps:** 4.1

**acceptance criteria:**
- test case implemented
- verifies blocking behavior

**verify:**
```bash
grep -q "case1\|script.*blocks" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.test.sh
```

---

### step 4.3: implement [case2] retry within window allows

- [ ] test: Write with "script" allows on retry within 5 min
- [ ] verify: exit code 0

**deps:** 4.2

**acceptance criteria:**
- test case implemented
- verifies HARDNUDGE retry behavior

**verify:**
```bash
grep -q "case2\|retry" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.test.sh
```

---

### step 4.4: implement [case3] Write without blocklisted terms allows

- [ ] test: Write without blocklisted terms
- [ ] verify: exit code 0

**deps:** 4.1

**acceptance criteria:**
- test case implemented
- verifies clean content passes

**verify:**
```bash
grep -q "case3\|without.*blocklist\|clean" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.test.sh
```

---

### step 4.5: implement [case4] Edit with term in new_string blocks

- [ ] test: Edit with blocklisted term in new_string
- [ ] verify: exit code 2

**deps:** 4.1

**acceptance criteria:**
- test case implemented
- verifies Edit tool handling

**verify:**
```bash
grep -q "case4\|Edit.*new_string" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.test.sh
```

---

### step 4.6: implement [case5] Edit with term only in old_string allows

- [ ] test: Edit with blocklisted term only in old_string
- [ ] verify: exit code 0 (only scans additions)

**deps:** 4.1

**acceptance criteria:**
- test case implemented
- verifies only new_string is scanned

**verify:**
```bash
grep -q "case5\|old_string" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.test.sh
```

---

### step 4.7: implement [case6] Bash tool call allows

- [ ] test: Bash tool call with blocklisted term
- [ ] verify: exit code 0 (not Write/Edit)

**deps:** 4.1

**acceptance criteria:**
- test case implemented
- verifies non-Write/Edit tools pass through

**verify:**
```bash
grep -q "case6\|Bash" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.test.sh
```

---

### step 4.8: implement [case7] word boundary prevents false positives

- [ ] test: Write with "typescript" (contains "script" as substring)
- [ ] verify: exit code 0 (word boundary match)

**deps:** 4.1

**acceptance criteria:**
- test case implemented
- verifies word boundary matching

**verify:**
```bash
grep -q "case7\|typescript\|word.*boundary\|substring" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.test.sh
```

---

### step 4.9: implement [case8] case-insensitive matching

- [ ] test: Write with "SCRIPT" (uppercase)
- [ ] verify: exit code 2 (blocks regardless of case)

**deps:** 4.1

**acceptance criteria:**
- test case implemented
- verifies case-insensitive detection

**verify:**
```bash
grep -q "case8\|SCRIPT\|case.*insensitive\|uppercase" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.test.sh
```

---

### step 4.10: implement [case9] empty blocklist config allows

- [ ] test: empty terms array in config
- [ ] verify: exit code 0 (nothing to block)

**deps:** 4.1

**acceptance criteria:**
- test case implemented
- verifies graceful handling of empty config

**verify:**
```bash
grep -q "case9\|empty.*config\|empty.*blocklist" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.test.sh
```

---

### step 4.11: implement [case10] empty stdin errors

- [ ] test: empty stdin
- [ ] verify: exit code 2 (error)

**deps:** 4.1

**acceptance criteria:**
- test case implemented
- verifies error handling for missing input

**verify:**
```bash
grep -q "case10\|empty.*stdin" src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.test.sh
```

---

### step 4.12: run blocklist test suite

- [ ] execute all blocklist tests
- [ ] verify all pass

**deps:** 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8, 4.9, 4.10, 4.11

**acceptance criteria:**
- all 10 test cases pass
- exit code 0

**verify:**
```bash
cd src/domain.roles/mechanic/inits/claude.hooks && bash pretooluse.forbid-terms.blocklist.test.sh
# expect: all tests pass, exit 0
```

---

## phase 5: hook registration

### step 5.1: update init.claude.hooks.sh for gerunds rename

- [ ] update gerunds hook registration to use new filename

**deps:** 1.6

**acceptance criteria:**
- registration uses `pretooluse.forbid-terms.gerunds.sh`

**verify:**
```bash
grep -q "pretooluse.forbid-terms.gerunds.sh" src/domain.roles/mechanic/inits/init.claude.hooks.sh
```

---

### step 5.2: add blocklist hook registration

- [ ] register blocklist hook for Write matcher
- [ ] register blocklist hook for Edit matcher

**deps:** 4.12

**acceptance criteria:**
- blocklist hook registered for Write
- blocklist hook registered for Edit

**verify:**
```bash
grep -q "forbid-terms.blocklist" src/domain.roles/mechanic/inits/init.claude.hooks.sh
grep -c "pretooluse.forbid-terms.blocklist.sh" src/domain.roles/mechanic/inits/init.claude.hooks.sh | grep -q "2"
```

---

## phase 6: build and integration verification

### step 6.1: run npm build

- [ ] build dist from src

**deps:** 5.2

**acceptance criteria:**
- build succeeds
- dist files created

**verify:**
```bash
npm run build
ls dist/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh
ls dist/domain.roles/mechanic/inits/claude.hooks/terms.blocklist.jsonc
```

---

### step 6.2: run full test suite

- [ ] run all project tests

**deps:** 6.1

**acceptance criteria:**
- all tests pass
- no regressions

**verify:**
```bash
npm run test
# expect: all tests pass
```

---

### step 6.3: verify hooks link correctly

- [ ] link roles to .agent directory
- [ ] verify hooks are accessible

**deps:** 6.1

**acceptance criteria:**
- hooks symlinked to .agent
- hooks executable from linked location

**verify:**
```bash
npx rhachet roles link --role mechanic
ls -la .agent/repo=ehmpathy/role=mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh
```

---

### step 6.4: manual integration test - blocklist blocks "script"

- [ ] reinitialize hooks
- [ ] attempt Write with "script" term
- [ ] verify blocked on first attempt
- [ ] verify allowed on retry

**deps:** 6.3

**acceptance criteria:**
- hook triggers on Write with "script"
- HARDNUDGE pattern works end-to-end

**verify:**
```bash
npx rhachet roles init --role mechanic
# then manually test via Claude session or direct hook invocation:
echo '{"tool_name":"Write","tool_input":{"file_path":"test.md","content":"run the script"}}' | \
  bash .agent/repo=ehmpathy/role=mechanic/inits/claude.hooks/pretooluse.forbid-terms.blocklist.sh
# expect: exit 2 with block message on first attempt
```

---

## .dependency graph

```
phase 1 (rename gerunds)
├── 1.1 rename hook ─────────────────┐
├── 1.2 rename test ─────────────────┤
├── 1.3 rename allowlist ────────────┤
│                                    │
├── 1.4 update hook refs ◄───────────┤ (deps: 1.1, 1.3)
├── 1.5 update test refs ◄───────────┤ (deps: 1.2, 1.4)
└── 1.6 verify tests pass ◄──────────┘ (deps: 1.5)

phase 2 (blocklist config)           │ (parallel with phase 1)
└── 2.1 create terms.blocklist.jsonc ┘

phase 3 (blocklist hook)
├── 3.1 create script ◄──────────────── (deps: 2.1)
├── 3.2 config loading ◄───────────────┤ (deps: 3.1)
├── 3.3 term detection ◄───────────────┤ (deps: 3.2)
├── 3.4 HARDNUDGE pattern ◄────────────┤ (deps: 3.3)
└── 3.5 block message ◄────────────────┘ (deps: 3.4)

phase 4 (blocklist tests)
├── 4.1 test structure ◄───────────────── (deps: 3.5)
├── 4.2-4.11 test cases ◄──────────────┬─ (deps: 4.1)
└── 4.12 run tests ◄───────────────────┘ (deps: all 4.x)

phase 5 (hook registration)
├── 5.1 update gerunds reg ◄───────────── (deps: 1.6)
└── 5.2 add blocklist reg ◄──────────────┘ (deps: 4.12)

phase 6 (integration)
├── 6.1 npm build ◄────────────────────── (deps: 5.2)
├── 6.2 full test suite ◄──────────────┬─ (deps: 6.1)
├── 6.3 verify link ◄──────────────────┤
└── 6.4 manual integration ◄───────────┘ (deps: 6.3)
```

---

## .final acceptance checklist

- [ ] `pretooluse.forbid-gerunds.sh` renamed to `pretooluse.forbid-terms.gerunds.sh`
- [ ] `gerunds.allowlist.jsonc` renamed to `terms.gerunds.allowlist.jsonc`
- [ ] renamed gerunds hook tests pass
- [ ] `terms.blocklist.jsonc` contains "script" entry with why and alt
- [ ] `pretooluse.forbid-terms.blocklist.sh` implemented
- [ ] blocklist hook blocks terms from config
- [ ] HARDNUDGE pattern: blocks first attempt, allows retry within 5 min
- [ ] word boundary matching prevents false positives
- [ ] case-insensitive matching works
- [ ] block message shows term, why, and alternatives
- [ ] all 10 blocklist test cases pass
- [ ] hooks registered via `init.claude.hooks.sh`
- [ ] npm build succeeds
- [ ] full test suite passes
- [ ] manual integration test confirms end-to-end behavior
