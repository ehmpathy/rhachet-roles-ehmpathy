# Roadmap: Git Commit Skill

## Phase 0: Infrastructure Setup
**depends on:** nothing
**read before:**
- `.behavior/v2026_02_03.git-commit/3.3.blueprint.v1.i1.md`

### Tasks
- [ ] create `src/domain.roles/mechanic/skills/git.commit/` directory
- [ ] create `output.sh` with turtle vibes helpers

### Acceptance
- [ ] directory exists
- [ ] `output.sh` exports: `print_turtle_header`, `print_tree_start`, `print_tree_branch`, `print_tree_leaf`

### Verification
```bash
ls src/domain.roles/mechanic/skills/git.commit/
source src/domain.roles/mechanic/skills/git.commit/output.sh && print_turtle_header "test"
```

---

## Phase 1: git.commit.uses (Human Command)
**depends on:** Phase 0
**read before:**
- `.behavior/v2026_02_03.git-commit/1.vision.md` (usecase 1, 3)
- `.behavior/v2026_02_03.git-commit/2.1.criteria.blackbox.md` (usecase.1, usecase.4)
- `.behavior/v2026_02_03.git-commit/3.1.research.patterns._.code.test.v1.i1.md`

### Tasks
- [ ] create `git.commit.uses.sh`
  - [ ] parse `set --allow N --push allow|block`
  - [ ] parse `get`
  - [ ] validate `--push` required on `set`
  - [ ] write state to `.meter/git.commit.uses.jsonc`
  - [ ] read state from `.meter/git.commit.uses.jsonc`
  - [ ] output with turtle vibes (gnarly/radical/groovy)
- [ ] create `git.commit.uses.integration.test.ts`
  - [ ] [case1] set --allow 3 --push block
  - [ ] [case2] set --allow 1 --push allow
  - [ ] [case3] set --allow 0 --push block (revoke)
  - [ ] [case4] set without --push (error)
  - [ ] [case5] get shows remaining
  - [ ] [case6] get when no state file (error)

### Acceptance
- [ ] `set --allow 3 --push block` â†’ outputs "ğŸ¢ gnarly! thanks human!" + tree
- [ ] `set --allow 1 --push allow` â†’ outputs "ğŸ¢ radical! let's ride!" + tree
- [ ] `set --allow 0 --push block` â†’ outputs "ğŸ¢ groovy, break time" + revoked
- [ ] `set --allow 3` (no --push) â†’ error about required flag
- [ ] `get` â†’ outputs "ğŸ¢ lets check the meter..." + remaining
- [ ] state file created at `.meter/git.commit.uses.jsonc`

### Verification
```bash
npm run test:integration -- src/domain.roles/mechanic/skills/git.commit/git.commit.uses.integration.test.ts
```

---

## Phase 2: git.commit.set (Mechanic Command)
**depends on:** Phase 1
**read before:**
- `.behavior/v2026_02_03.git-commit/1.vision.md` (usecase 2, 4)
- `.behavior/v2026_02_03.git-commit/2.1.criteria.blackbox.md` (usecase.2-8)
- `.behavior/v2026_02_03.git-commit/3.1.research.claims._.v1.i1.md` (Co-authored-by format)
- `.behavior/v2026_02_03.git-commit/3.1.research.patterns._.code.test.v1.i1.md`

### Tasks
- [ ] create `git.commit.set.sh`
  - [ ] parse `--message "..."` and `--push`
  - [ ] read quota from `.meter/git.commit.uses.jsonc`
  - [ ] validate uses > 0
  - [ ] validate push permission if `--push`
  - [ ] get human git identity (`git config user.name/email`)
  - [ ] validate human identity exists
  - [ ] check staged changes exist
  - [ ] create commit with `--author="seaturtle[bot] <seaturtle@ehmpathy.com>"`
  - [ ] append Co-authored-by trailer (blank line + trailer)
  - [ ] push if `--push`
  - [ ] decrement uses in state file
  - [ ] output with turtle vibes (righteous/cowabunga/bummer)
- [ ] create `git.commit.set.integration.test.ts`
  - [ ] [case1] commit without push â†’ righteous!
  - [ ] [case2] commit with push â†’ cowabunga!
  - [ ] [case3] no uses remaining â†’ bummer dude...
  - [ ] [case4] push not allowed â†’ bummer dude...
  - [ ] [case5] nothing to commit â†’ error, uses not decremented
  - [ ] [case6] no git user configured â†’ error, uses not decremented
  - [ ] [case7] verify Co-authored-by trailer format
  - [ ] [case8] verify author is seaturtle[bot]

### Acceptance
- [ ] commit without push â†’ "ğŸ¢ righteous!" + tree with push: skipped
- [ ] commit with push â†’ "ğŸ¢ cowabunga!" + tree with push: origin/branch âœ“
- [ ] no uses â†’ "ğŸ¢ bummer dude..." + error + instructions
- [ ] push blocked â†’ "ğŸ¢ bummer dude..." + error about push
- [ ] git log shows author: `seaturtle[bot] <seaturtle@ehmpathy.com>`
- [ ] git log shows `Co-authored-by: Human <human@email>`
- [ ] uses decremented after successful commit
- [ ] uses NOT decremented on failure

### Verification
```bash
npm run test:integration -- src/domain.roles/mechanic/skills/git.commit/git.commit.set.integration.test.ts
```

---

## Phase 3: Permissions Update
**depends on:** Phase 2
**read before:**
- `.behavior/v2026_02_03.git-commit/2.1.criteria.blackbox.md` (usecase.10)
- `src/domain.roles/mechanic/inits/init.claude.permissions.jsonc`

### Tasks
- [ ] update `init.claude.permissions.jsonc`
  - [ ] add `allow Bash(npx rhachet run --skill git.commit.set:*)`
  - [ ] verify `deny Edit(.meter/*)` exists
  - [ ] verify `deny Write(.meter/*)` exists
- [ ] update `.claude/settings.json` to mirror

### Acceptance
- [ ] mechanic can run `git.commit.set` without permission prompt
- [ ] mechanic cannot write to `.meter/` (denied)

### Verification
```bash
# manual test: attempt to write .meter/ as mechanic â†’ should be denied
grep -A2 "Edit(.meter" .claude/settings.json
grep -A2 "Write(.meter" .claude/settings.json
grep "git.commit.set" .claude/settings.json
```

---

## Phase 4: End-to-End Validation
**depends on:** Phase 3
**read before:**
- `.behavior/v2026_02_03.git-commit/1.vision.md` (full)
- `.behavior/v2026_02_03.git-commit/2.1.criteria.blackbox.md` (usecase.9)

### Tasks
- [ ] manual e2e test: human grants â†’ mechanic commits â†’ quota decrements
- [ ] manual e2e test: human grants with push â†’ mechanic commits+pushes
- [ ] manual e2e test: quota exhausted â†’ mechanic sees bummer dude
- [ ] manual e2e test: mechanic tries to modify .meter/ â†’ denied

### Acceptance
- [ ] full workflow works as described in vision
- [ ] orchestration chaining works: `cmd || git.commit.uses set --allow 1 --push allow`
- [ ] security boundary holds: mechanic cannot grant itself permissions

### Verification
```bash
# in a test repo:
git.commit.uses set --allow 2 --push allow
# make changes, stage them
git.commit.set --message "test: first commit" --push
git.commit.uses get  # should show 1 remaining
git.commit.set --message "test: second commit"
git.commit.uses get  # should show 0 remaining
git.commit.set --message "test: should fail"  # should show bummer dude
```

---

## Summary

| Phase | Deliverable | Tests |
|-------|-------------|-------|
| 0 | output.sh helpers | manual |
| 1 | git.commit.uses.sh | 6 integration tests |
| 2 | git.commit.set.sh | 8 integration tests |
| 3 | permissions update | grep verification |
| 4 | e2e validation | manual workflow |

**Total:** 14 integration tests + manual e2e
