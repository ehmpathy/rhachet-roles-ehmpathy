# Blackbox Criteria: Git Commit Skill

# usecase.1 = human grants commit permission
given(human wants to allow mechanic to commit)
  when(human runs `git.commit.uses set --allow 3 --push block`)
    then(output starts with "ğŸ¢ gnarly! thanks human!")
    then(output shows tree with ğŸš git.commit.uses set)
    then(output shows meter.granted: 3)
    then(output shows meter.push: blocked)
      sothat(human sees the grant confirmed with good vibes)

  when(human runs `git.commit.uses set --allow 1 --push allow`)
    then(output starts with "ğŸ¢ radical! let's ride!")
    then(output shows meter.granted: 1)
    then(output shows meter.push: allowed)
      sothat(human knows mechanic is pumped and ready)

  when(human runs `git.commit.uses set --allow 0 --push block`)
    then(output starts with "ğŸ¢ groovy, break time")
    then(output shows meter.revoked)
      sothat(human knows permissions are cleared)

given(human forgets --push flag)
  when(human runs `git.commit.uses set --allow 3`)
    then(command fails)
    then(output shows: "--push allow|block is required")
      sothat(human cannot accidentally leave push unspecified)

# usecase.2 = mechanic makes a commit (no push)
given(mechanic has 3 commit uses remaining)
given(push is blocked)
given(staged changes exist)
  when(mechanic runs `git.commit.set --message "fix(api): validate input"`)
    then(output starts with "ğŸ¢ righteous!")
    then(output shows tree with ğŸš git.commit.set)
    then(output shows commit.header: fix(api): validate input)
    then(output shows commit.author: seaturtle[bot] <seaturtle@ehmpathy.com>)
    then(output shows commit.patron: {human's git identity})
    then(output shows push: skipped)
    then(output shows meter.remaining: 2 (push: blocked))
      sothat(mechanic sees smooth sailing confirmation)

# usecase.3 = mechanic makes a commit (with push)
given(mechanic has 2 commit uses remaining)
given(push is allowed)
given(staged changes exist)
  when(mechanic runs `git.commit.set --message "fix(api): handle edge case" --push`)
    then(output starts with "ğŸ¢ cowabunga!")
    then(output shows commit.header: fix(api): handle edge case)
    then(output shows commit.author: seaturtle[bot] <seaturtle@ehmpathy.com>)
    then(output shows commit.patron: {human's git identity})
    then(output shows push: origin/main âœ“)
    then(output shows meter.remaining: 1 (push: allowed))
      sothat(mechanic knows it caught the big wave)

# usecase.4 = mechanic checks quota
given(mechanic has 2 commit uses remaining)
given(push is allowed)
  when(mechanic runs `git.commit.uses get`)
    then(output starts with "ğŸ¢ lets check the meter...")
    then(output shows tree with ğŸš git.commit.uses)
    then(output shows meter.remaining: 2)
    then(output shows meter.push: allowed)
      sothat(mechanic can plan before attempting commit)

given(mechanic has 0 commit uses remaining)
  when(mechanic runs `git.commit.uses get`)
    then(output starts with "ğŸ¢ lets check the meter...")
    then(output shows meter.remaining: 0)
      sothat(mechanic knows it cannot commit)

# usecase.5 = permission denied - no uses
given(mechanic has 0 commit uses remaining)
given(staged changes exist)
  when(mechanic runs `git.commit.set --message "some fix"`)
    then(output starts with "ğŸ¢ bummer dude...")
    then(output shows tree with ğŸš git.commit.set)
    then(output shows error: no commit uses remaining)
    then(output shows: "ask your human to grant more:")
    then(output shows: "  $ git.commit.uses set --allow N --push allow|block")
      sothat(mechanic knows it wiped out and what to ask for)

# usecase.6 = permission denied - push not allowed
given(mechanic has 1 commit use remaining)
given(push is blocked)
given(staged changes exist)
  when(mechanic runs `git.commit.set --message "some fix" --push`)
    then(output starts with "ğŸ¢ bummer dude...")
    then(output shows error: push not allowed in current grant)
    then(output shows: "ask your human to grant with --push allow")
      sothat(mechanic knows push was explicitly blocked)

# usecase.7 = nothing to commit
given(mechanic has commit uses remaining)
given(no staged changes exist)
  when(mechanic runs `git.commit.set --message "some fix"`)
    then(commit is NOT created)
    then(output shows: "nothing to commit")
    then(uses are NOT decremented)
      sothat(failed commits don't waste quota)

# usecase.8 = missing git identity for co-author
given(mechanic has commit uses remaining)
given(staged changes exist)
given(human's git user.name is NOT configured)
  when(mechanic runs `git.commit.set --message "some fix"`)
    then(commit is NOT created)
    then(output shows error: cannot determine patron)
    then(output shows: "human must configure git user.name and user.email")
    then(uses are NOT decremented)
      sothat(commits always have proper attribution)

# usecase.9 = orchestration chaining
given(CI build failed)
given(human runs `git release --watch || (rhx show.gh.build.errors && git.commit.uses set --allow 1 --push allow)`)
  when(mechanic sees CI failure)
    then(mechanic analyzes errors)
    then(mechanic makes fix)
    then(mechanic runs `git.commit.set --message "fix: ..." --push`)
    then(output shows "ğŸ¢ cowabunga!" with commit + push confirmation)
    then(CI re-runs)
      sothat(fix-commit-push-watch cycles work with good vibes)

# usecase.10 = mechanic cannot modify its own quota
given(mechanic wants more commit uses)
  when(mechanic attempts to write to .meter/)
    then(write is denied by permissions denylist)
    then(mechanic sees permission denied error)
      sothat(only humans can grant commit permission)
