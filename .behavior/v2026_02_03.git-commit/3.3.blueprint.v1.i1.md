# Blueprint: Git Commit Skill

## Overview

Two shell scripts implementing metered git commit permissions:
- `git.commit.uses.sh` - human controls quota (set/get)
- `git.commit.set.sh` - mechanic executes commit within quota

State persisted in `.meter/git.commit.uses.jsonc`.

---

## Filediffs

```
[+] src/domain.roles/mechanic/skills/git.commit/git.commit.uses.sh
[+] src/domain.roles/mechanic/skills/git.commit/git.commit.set.sh
[+] src/domain.roles/mechanic/skills/git.commit/git.commit.uses.integration.test.ts
[+] src/domain.roles/mechanic/skills/git.commit/git.commit.set.integration.test.ts
[+] src/domain.roles/mechanic/skills/git.commit/output.sh
[~] src/domain.roles/mechanic/inits/init.claude.permissions.jsonc
[~] .claude/settings.json
[â—‹] .meter/.gitignore
[â—‹] .meter/.readme
```

---

## Codepaths

```
src/domain.roles/mechanic/skills/git.commit/
â”œâ”€ [+] git.commit.uses.sh
â”‚     â”œâ”€ parse args (set --allow N --push allow|block | get)
â”‚     â”œâ”€ validate --push required on set
â”‚     â”œâ”€ read/write .meter/git.commit.uses.jsonc
â”‚     â””â”€ output with turtle vibes
â”‚
â”œâ”€ [+] git.commit.set.sh
â”‚     â”œâ”€ parse args (--message "..." [--push])
â”‚     â”œâ”€ read .meter/git.commit.uses.jsonc
â”‚     â”œâ”€ validate quota > 0
â”‚     â”œâ”€ validate push permission if --push
â”‚     â”œâ”€ get human git identity for co-author
â”‚     â”œâ”€ configure temp git author (seaturtle[bot])
â”‚     â”œâ”€ create commit with Co-authored-by trailer
â”‚     â”œâ”€ push if --push
â”‚     â”œâ”€ decrement quota
â”‚     â”œâ”€ write .meter/git.commit.uses.jsonc
â”‚     â””â”€ output with turtle vibes
â”‚
â”œâ”€ [+] output.sh
â”‚     â”œâ”€ print_turtle_header(phrase)
â”‚     â”œâ”€ print_tree_start(command)
â”‚     â”œâ”€ print_tree_branch(key, value)
â”‚     â””â”€ print_tree_leaf(key, value)
â”‚
â”œâ”€ [+] git.commit.uses.integration.test.ts
â”‚     â”œâ”€ [case1] set --allow N --push block
â”‚     â”œâ”€ [case2] set --allow N --push allow
â”‚     â”œâ”€ [case3] set --allow 0 (revoke)
â”‚     â”œâ”€ [case4] set without --push (error)
â”‚     â”œâ”€ [case5] get (shows remaining)
â”‚     â””â”€ [case6] get when no state (error)
â”‚
â””â”€ [+] git.commit.set.integration.test.ts
      â”œâ”€ [case1] commit without push (righteous!)
      â”œâ”€ [case2] commit with push (cowabunga!)
      â”œâ”€ [case3] no uses remaining (bummer dude...)
      â”œâ”€ [case4] push not allowed (bummer dude...)
      â”œâ”€ [case5] nothing to commit
      â”œâ”€ [case6] no git user configured
      â”œâ”€ [case7] uses not decremented on failure
      â””â”€ [case8] Co-authored-by trailer format

.meter/
â”œâ”€ [â—‹] .gitignore
â”œâ”€ [â—‹] .readme
â””â”€ [+] git.commit.uses.jsonc (created by git.commit.uses set)

permissions/
â”œâ”€ [~] init.claude.permissions.jsonc
â”‚     â”œâ”€ [+] deny Edit(.meter/*)
â”‚     â”œâ”€ [+] deny Write(.meter/*)
â”‚     â””â”€ [+] allow Bash(npx rhachet run --skill git.commit.set:*)
â”‚
â””â”€ [~] .claude/settings.json
      â””â”€ (mirror permission changes)
```

---

## Contracts

### git.commit.uses.sh

**Input:**
```bash
# set quota
git.commit.uses set --allow <N> --push <allow|block>

# get quota
git.commit.uses get
```

**Output (set):**
```
ğŸ¢ gnarly! thanks human!        # --push block
ğŸ¢ radical! let's ride!         # --push allow
ğŸ¢ groovy, break time           # --allow 0

ğŸš git.commit.uses set
â””â”€ meter
   â”œâ”€ granted: N
   â””â”€ push: allowed|blocked
```

**Output (get):**
```
ğŸ¢ lets check the meter...

ğŸš git.commit.uses
â””â”€ meter
   â”œâ”€ remaining: N
   â””â”€ push: allowed|blocked
```

**State file:** `.meter/git.commit.uses.jsonc`
```jsonc
{
  "uses": 3,
  "push": "allow"  // or "block"
}
```

---

### git.commit.set.sh

**Input:**
```bash
git.commit.set --message "<message>" [--push]
```

**Output (success, no push):**
```
ğŸ¢ righteous!

ğŸš git.commit.set
â”œâ”€ commit
â”‚  â”œâ”€ header: <message>
â”‚  â”œâ”€ author: seaturtle[bot] <seaturtle@ehmpathy.com>
â”‚  â””â”€ patron: <human name> <human@email>
â”œâ”€ push: skipped
â””â”€ meter
   â””â”€ remaining: N (push: blocked)
```

**Output (success, with push):**
```
ğŸ¢ cowabunga!

ğŸš git.commit.set
â”œâ”€ commit
â”‚  â”œâ”€ header: <message>
â”‚  â”œâ”€ author: seaturtle[bot] <seaturtle@ehmpathy.com>
â”‚  â””â”€ patron: <human name> <human@email>
â”œâ”€ push: origin/<branch> âœ“
â””â”€ meter
   â””â”€ remaining: N (push: allowed)
```

**Output (no uses):**
```
ğŸ¢ bummer dude...

ğŸš git.commit.set
â””â”€ error: no commit uses remaining

ask your human to grant more:
  $ git.commit.uses set --allow N --push allow|block
```

**Output (push not allowed):**
```
ğŸ¢ bummer dude...

ğŸš git.commit.set
â””â”€ error: push not allowed in current grant

ask your human to grant with --push allow
```

---

## Git Commit Logic

```bash
# 1. get human identity for co-author
HUMAN_NAME=$(git config user.name)
HUMAN_EMAIL=$(git config user.email)

# 2. create commit as seaturtle[bot]
git commit \
  --author="seaturtle[bot] <seaturtle@ehmpathy.com>" \
  --message="$MESSAGE

Co-authored-by: $HUMAN_NAME <$HUMAN_EMAIL>"

# 3. push if requested
if [[ "$PUSH" == true ]]; then
  git push
fi
```

---

## Test Coverage

| Test | Type | Covers |
|------|------|--------|
| git.commit.uses set variations | integration | usecase.1 |
| git.commit.uses get | integration | usecase.4 |
| git.commit.set no push | integration | usecase.2 |
| git.commit.set with push | integration | usecase.3 |
| git.commit.set no uses | integration | usecase.5 |
| git.commit.set push blocked | integration | usecase.6 |
| git.commit.set nothing to commit | integration | usecase.7 |
| git.commit.set no git user | integration | usecase.8 |
| quota not decremented on failure | integration | usecase.7, usecase.8 |
| Co-authored-by trailer format | integration | vision |
| .meter/ write denied | integration | usecase.10 |

---

## Dependencies

- `jq` - for reading/writing JSON state
- `git` - for commit operations
- existing test-fns patterns (`given`, `when`, `then`, `genTempDir`)

---

## Security

1. **Mechanic cannot modify `.meter/`** - denied via permissions denylist
2. **Quota enforced** - each commit decrements, zero blocks
3. **Push explicit** - `--push` flag required on grant, checked on commit
4. **Repo-scoped** - all operations within git repo only
