# blueprint: brief compressor evals

## overview

implement an evaluation framework to compare methodology brief combinations for bhrain/sitrep compression. the framework tests 4 combinations against 4 brief types with 3 runs each, executes in parallel, and reports a ranked comparison table.

### core principle

> **kernels retain, density rises**

semantic density = kernels / tokens. good compression:
- removes tokens (noise)
- retains kernels (signal)
- raises density (more signal per token)

this metric powers the evaluation: max signal to min noise.

---

## filediffs

```
src/domain.roles/librarian/skills/brief.compress/
â”œâ”€â”€ [~] compress.via.bhrain.ts                              # add configurable methodologies
â”œâ”€â”€ [~] compress.via.bhrain.perfeval.integration.test.ts    # implement combination comparison
â”œâ”€â”€ [â—‹] compress.shared.ts                                  # retain token count utility
â”œâ”€â”€ [â—‹] .test/fixtures/briefs.ts                            # retain test briefs
â””â”€â”€ briefs/
    â”œâ”€â”€ [â—‹] sitrep.methodology.md                           # retain sitrep methodology
    â””â”€â”€ [â—‹] tsc.methodology.md                              # retain tsc methodology
```

**legend:**
- `[+]` create â€” file to create
- `[~]` update â€” file to update
- `[-]` delete â€” file to delete
- `[â—‹]` retain â€” file to retain

---

## codepaths

### compress.via.bhrain.ts

```
compress.via.bhrain.ts
â”œâ”€â”€ [+] MethodologyBrief type                    # 'sitrep' | 'tsc'
â”œâ”€â”€ [+] METHODOLOGY_BRIEF_PATHS                  # map methodology â†’ path
â”œâ”€â”€ [+] genCompressionPrompt(methodologies)      # dynamic prompt based on combination
â”œâ”€â”€ [+] DEFAULT_METHODOLOGIES                    # ['sitrep', 'tsc'] for backward compat
â”œâ”€â”€ [~] compressViaBhrain(input)                 # add methodologies option
â”‚   â”œâ”€â”€ [â—‹] countTokens                          # retain token count
â”‚   â”œâ”€â”€ [+] methodologyBriefArtifacts            # load briefs per combination
â”‚   â”œâ”€â”€ [â—‹] genContextBrain                      # retain brain resolution
â”‚   â”œâ”€â”€ [~] brain.choice.ask                     # use dynamic briefs
â”‚   â””â”€â”€ [â—‹] return metrics                       # retain ratio calculation
â””â”€â”€ [â—‹] main()                                   # retain cli interface
```

### compress.via.bhrain.perfeval.integration.test.ts

```
compress.via.bhrain.perfeval.integration.test.ts
â”œâ”€â”€ [+] METHODOLOGY_COMBINATIONS                 # 4 combinations to test
â”‚   â”œâ”€â”€ ['sitrep']
â”‚   â”œâ”€â”€ ['sitrep', 'tsc']
â”‚   â”œâ”€â”€ ['tsc', 'sitrep']
â”‚   â””â”€â”€ ['sitrep', 'tsc', 'sitrep']
â”œâ”€â”€ [+] BRIEF_TYPES                              # filter by type for coverage
â”œâ”€â”€ [â—‹] computeStats(values)                     # retain mean/min/max/stddev
â”œâ”€â”€ [+] formatCombination(combo)                 # display helper
â”œâ”€â”€ [+] runSingleCompression(input)              # isolated compression call
â”‚   â”œâ”€â”€ [â†] compressViaBhrain                    # reuse from compress.via.bhrain.ts
â”‚   â””â”€â”€ [+] error handler                        # capture failures without crash
â”œâ”€â”€ [+] given('[perfeval] methodology comparison')
â”‚   â””â”€â”€ [+] when('[t0] all combinations tested')
â”‚       â”œâ”€â”€ [+] then('compressions execute in parallel')
â”‚       â”‚   â”œâ”€â”€ [+] build compression tasks      # 4 Ã— 4 Ã— 3 = 48 tasks
â”‚       â”‚   â””â”€â”€ [+] Promise.all(tasks)           # parallel execution
â”‚       â”œâ”€â”€ [+] then('stats computed per combination')
â”‚       â”‚   â”œâ”€â”€ [+] group by combination
â”‚       â”‚   â”œâ”€â”€ [+] compute stats per group
â”‚       â”‚   â””â”€â”€ [+] log comparison table
â”‚       â”œâ”€â”€ [+] then('duration metrics reported')
â”‚       â”‚   â”œâ”€â”€ [+] total wall-clock time
â”‚       â”‚   â””â”€â”€ [+] avg per compression
â”‚       â”œâ”€â”€ [+] then('combinations ranked')
â”‚       â”‚   â””â”€â”€ [+] sort by mean ratio desc
â”‚       â””â”€â”€ [+] then('brief types tested')
â”‚           â””â”€â”€ [+] verify all 4 types present
â””â”€â”€ [+] given('[perfeval] error resilience')
    â””â”€â”€ [+] then('partial results reported')
```

**legend:**
- `[+]` create â€” codepath to create
- `[~]` update â€” codepath to update
- `[â—‹]` retain â€” codepath to retain
- `[â†]` reuse â€” codepath to reuse from elsewhere

---

## contracts

### compressViaBhrain input contract

```ts
input: {
  content: string;                      // brief content to compress
  brainSlug: string;                    // e.g., 'xai/grok/code-fast-1'
  methodologies?: MethodologyBrief[];   // e.g., ['sitrep', 'tsc']
}
```

### compressViaBhrain output contract

```ts
output: {
  compressed: string;      // compressed brief content
  forethought: string;     // brain's grasp of task
  rationale: string;       // brain's compression decisions
  tokensBefore: number;    # input token count
  tokensAfter: number;     // output token count
  ratio: number;           // tokensBefore / tokensAfter
}
```

### perfeval result contract

```ts
result: {
  briefName: string;       // e.g., 'input-context-pattern'
  runIndex: number;        // 0, 1, or 2
  combination: string;     // e.g., '[sitrep, tsc]'
  ratio: number;           // compression ratio
  tokensBefore: number;
  tokensAfter: number;
  error: string | null;    // null if success
}
```

### comparison stats contract

```ts
stats: {
  mean: number;    // average ratio
  min: number;     // lowest ratio
  max: number;     // highest ratio
  stddev: number;  // standard deviation
}
```

---

## domain decomposition

### domain.objects (implicit via types)

| object | description |
|--------|-------------|
| `MethodologyBrief` | union type: `'sitrep' \| 'tsc'` |
| `CompressionResult` | output of single compression |
| `CompressionStats` | aggregated stats per combination |

### domain.operations

| operation | input | output |
|-----------|-------|--------|
| `compressViaBhrain` | content, brainSlug, methodologies | compressed, metrics |
| `computeStats` | number[] | mean, min, max, stddev |
| `runSingleCompression` | content, methodologies, briefName, runIndex | result with error handle |

---

## test coverage

### unit tests

| test | covers |
|------|--------|
| `computeStats` | mean/min/max/stddev calculation |
| `genCompressionPrompt` | prompt generation per combination |
| `formatCombination` | display format |

### integration tests

| test | covers |
|------|--------|
| `compressViaBhrain` with methodologies | configurable brief combinations |
| parallel compression execution | Promise.all behavior |
| error resilience | partial failure handle |

### acceptance tests (via perfeval)

| test | covers |
|------|--------|
| all 4 combinations tested | usecase.2 |
| all 4 brief types tested | usecase.3 |
| stats per combination | usecase.1 |
| ranked comparison table | usecase.1 |
| duration metrics | usecase.5 |
| partial results on failure | usecase.4 |

---

## execution plan

### phase 1: update compress.via.bhrain.ts

1. add `MethodologyBrief` type export
2. add `METHODOLOGY_BRIEF_PATHS` map
3. add `genCompressionPrompt(methodologies)` function
4. add `DEFAULT_METHODOLOGIES` constant
5. update `compressViaBhrain` to accept `methodologies` option
6. export `compressViaBhrain` for test use

### phase 2: update perfeval integration test

1. define `METHODOLOGY_COMBINATIONS` array
2. define `BRIEF_TYPES` filter
3. implement `runSingleCompression` with error handle
4. implement parallel execution via `Promise.all`
5. implement stats computation per combination
6. implement comparison table output
7. implement duration metrics output
8. implement rank output

### phase 3: verify coverage

1. run `npm run test:integration -- compress.via.bhrain.perfeval`
2. verify all 48 compressions execute
3. verify comparison table displays
4. verify duration metrics display
5. verify rank displays

---

## output format

```
ğŸ¢ compression complete
   total compressions: 48
   duration: 47.2s

ğŸ“Š methodology brief comparison:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ combination             â”‚ mean     â”‚ min      â”‚ max      â”‚ stddev   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [tsc, sitrep]           â”‚ 2.31x    â”‚ 1.89x    â”‚ 2.74x    â”‚ 0.28     â”‚
â”‚ [sitrep, tsc, sitrep]   â”‚ 2.18x    â”‚ 1.76x    â”‚ 2.61x    â”‚ 0.31     â”‚
â”‚ [sitrep, tsc]           â”‚ 2.05x    â”‚ 1.68x    â”‚ 2.42x    â”‚ 0.24     â”‚
â”‚ [sitrep]                â”‚ 1.72x    â”‚ 1.45x    â”‚ 1.99x    â”‚ 0.18     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â±ï¸  duration metrics:
   total: 47.2s
   avg per compression: 983ms
   sample: 4 briefs Ã— 4 combinations Ã— 3 runs = 48 compressions

ğŸ† ranked by mean compression ratio:
   1. [tsc, sitrep]: 2.31x
   2. [sitrep, tsc, sitrep]: 2.18x
   3. [sitrep, tsc]: 2.05x
   4. [sitrep]: 1.72x

ğŸ“ brief types tested:
   âœ“ rule
   âœ“ concept
   âœ“ lesson
   âœ“ tactic
```

---

## risks and mitigations

| risk | mitigation |
|------|------------|
| brain api timeout | 60s timeout per call, error capture |
| high token cost | limited sample (4 briefs Ã— 4 combos Ã— 3 runs) |
| variance in results | 3 runs per combination, report stddev |
| parallel rate limits | brain provider may throttle; adjust if needed |
