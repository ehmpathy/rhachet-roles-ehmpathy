# blueprint: keyrack

## overview

update git.commit.push.sh to fetch the github token from keyrack before the token guard.

rhachet implements keyrack. this blueprint just integrates it.


## filediffs

```
src/domain.roles/mechanic/
├── keyrack.yml                        [~] update — add EHMPATHY_SEATURTLE_PROD_GITHUB_TOKEN
└── skills/
    └── git.commit/
        └── git.commit.push.sh         [~] update — fetch token from keyrack with fallback
```


## codepaths

```
git.commit/
└── [~] git.commit.push.sh
    ├── [○] retain current logic
    ├── [-] remove token guard (line ~158)
    └── [+] add keyrack fetch with owner fallback
```


## integration point: git.commit.push.sh

replace the token guard with keyrack fetch + fallback:

```bash
# fetch token from keyrack (errors propagate with actionable messages)
EHMPATHY_SEATURTLE_PROD_GITHUB_TOKEN=$(
  "$REPO_ROOT/node_modules/.bin/rhachet" keyrack get \
    --key EHMPATHY_SEATURTLE_PROD_GITHUB_TOKEN
) || EHMPATHY_SEATURTLE_PROD_GITHUB_TOKEN=$(
  "$REPO_ROOT/node_modules/.bin/rhachet" keyrack get \
    --key EHMPATHY_SEATURTLE_PROD_GITHUB_TOKEN \
    --owner ehmpath.demo
)
```

flow:
1. try default owner keyrack get
2. if that fails, fallback to `--owner ehmpath.demo` (passwordless sshkey host manifest)
3. if both fail, errors propagate with actionable messages

error messages guide the mechanic to ask a human:
- "please ask a human to `rhx keyrack unlock`"
- "please ask a human to `rhx keyrack unlock --owner ehmpath.demo`"

remove the old token guard — keyrack handles all error cases.


## keyrack.yml update

add the key to env.all:

```yaml
env.all:
  - EHMPATHY_SEATURTLE_PROD_GITHUB_TOKEN
```


## test coverage

update `git.commit.push.integration.test.ts`:

### test setup

run `npx rhachet keyrack unlock --owner ehmpath.demo` in beforeAll.
this ensures the ehmpath.demo host manifest is unlocked for tests that need a valid token.

### three tests

1. **happy path** (keyrack unlocked via ehmpath.demo → skill works)
   - setup: beforeAll already unlocked ehmpath.demo
   - run: `git.commit.push --mode plan`
   - assert: exits 0, outputs plan correctly

2. **sad path: no keyrack.yml** (keyrack not configured → asks human)
   - setup: no keyrack.yml fixture in temp repo
   - run: `git.commit.push --mode plan`
   - assert: exits non-zero
   - assert: stderr snapshot shows clear message about keyrack config

3. **sad path: keyrack locked** (all owners locked → asks human)
   - setup: `npx rhachet keyrack relock --owner ehmpath.demo` to lock the fallback
   - run: `git.commit.push --mode plan` with fake HOME (no host manifests)
   - assert: exits non-zero
   - assert: stderr shows ONLY the first error (user's real issue, not fallback noise)
   - assert: stderr snapshot for clear "please unlock" message

note: rhachet now supports `--owner` on all keyrack operations (get, relock, etc.),
which allows precise control over which owner's keys are locked/unlocked in tests.


## summary

- 1 keyrack.yml update (add key name)
- 1 skill update (keyrack fetch with owner fallback)
- 3 tests (happy path, no config, real user locked)
