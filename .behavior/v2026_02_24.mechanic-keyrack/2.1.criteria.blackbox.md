# blackbox criteria: keyrack

## usecase.1 = human inits keyrack

given a repo without a keyrack
  when the human runs `rhx keyrack init --extends .agent/repo=ehmpathy/role=mechanic/keyrack.yml`
    then a `.agent/keyrack.yml` is created
      sothat the repo declares which role keyracks it trusts
    then the keyrack extends the specified role keyrack
      sothat skills from that role can request keys

given a repo with a keyrack
  when the human runs `rhx keyrack init --extends .agent/repo=ehmpathy/role=mechanic/keyrack.yml`
    then the keyrack is updated to extend the specified role keyrack
      sothat additional roles can be trusted over time


## usecase.2 = human unlocks keyrack

given a keyrack that is locked
  when the human runs `rhx keyrack unlock`
    then the keyrack authenticates to the host keystore
      sothat keys can be fetched for this session
    then the keyrack remains unlocked for the session
      sothat the human doesn't need to unlock repeatedly

given a keyrack that is already unlocked
  when the human runs `rhx keyrack unlock`
    then the keyrack remains unlocked
      sothat the command is idempotent


## usecase.3 = human sets a key

given an unlocked keyrack
  when the human runs `rhx keyrack set --key SOME_API_KEY`
    then the key is registered in the host manifest
      sothat skills can fetch it by name
    then no storage details are exposed
      sothat the host manifest remains secretive

given a key already in the host manifest
  when the human runs `rhx keyrack set --key SOME_API_KEY`
    then the key is updated in the host manifest
      sothat the command is idempotent


## usecase.4 = skill fetches a key

given an extended keyrack
  given an unlocked keyrack
    given a key in the host manifest
      when a skill calls `rhx keyrack get --key SOME_API_KEY`
        then the key value is returned
          sothat the skill can use it
        then the mechanic is unaware of the fetch
          sothat cognitive load stays on the work


## usecase.5 = error cases

given no keyrack in the repo
  when a skill calls `rhx keyrack get --key SOME_API_KEY`
    then the skill fails fast
    then the error says "please ask a human to `rhx keyrack init --extends ...`"
      sothat the mechanic knows exactly what to ask

given a locked keyrack
  when a skill calls `rhx keyrack get --key SOME_API_KEY`
    then the skill fails fast
    then the error says "please ask a human to `rhx keyrack unlock`"
      sothat the mechanic knows exactly what to ask

given a key not in the host manifest
  when a skill calls `rhx keyrack get --key SOME_API_KEY`
    then the skill fails fast
    then the error says "please ask a human to `rhx keyrack set --key SOME_API_KEY`"
      sothat the mechanic knows exactly what to ask
