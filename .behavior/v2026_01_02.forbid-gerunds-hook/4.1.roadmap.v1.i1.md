# roadmap: forbid-gerunds-hook

## phase 0: foundation

### 0.1 create allowlist file
- [ ] create `src/domain.roles/mechanic/inits/claude.hooks/gerunds.allowlist.jsonc`
- [ ] add `string` to primitives array with comment

**acceptance criteria**:
```
given: allowlist file exists
  when: parsed with `sed 's|//.*||' | jq '.primitives[]'`
    then: outputs "string"
```

**verify**:
```bash
sed 's|//.*||' src/domain.roles/mechanic/inits/claude.hooks/gerunds.allowlist.jsonc | jq -e '.primitives | index("string")' && echo "âœ” PASS" || echo "âœ˜ FAIL"
```

---

## phase 1: core hook (no HARDNUDGE)

### 1.1 create hook script skeleton
- [ ] create `src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.sh`
- [ ] add shebang, header comment, `set -euo pipefail`
- [ ] read stdin JSON
- [ ] extract tool_name

**depends on**: nothing

**acceptance criteria**:
```
given: hook script exists
  when: run with empty stdin
    then: exits with code 2 (error)
  when: run with valid JSON for Bash tool
    then: exits with code 0 (allow)
```

**verify**:
```bash
echo "" | bash src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.sh 2>/dev/null && echo "âœ˜ FAIL: should exit 2" || echo "âœ” PASS: exits non-zero on empty stdin"

echo '{"tool_name":"Bash","tool_input":{"command":"ls"}}' | bash src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.sh && echo "âœ” PASS: allows Bash" || echo "âœ˜ FAIL"
```

---

### 1.2 add content extraction
- [ ] extract content from Write tool (`tool_input.content`)
- [ ] extract content from Edit tool (`tool_input.new_string`)
- [ ] skip old_string (only scan additions)

**depends on**: 1.1

**acceptance criteria**:
```
given: Write tool JSON with content field
  when: hook extracts content
    then: content variable contains the value

given: Edit tool JSON with new_string field
  when: hook extracts content
    then: content variable contains new_string value (not old_string)
```

**verify**: manual inspection via `set -x` or echo debug

---

### 1.3 add gerund detection
- [ ] extract all -ing words via regex `\b[a-zA-Z]+ing\b`
- [ ] load allowlist from gerunds.allowlist.jsonc
- [ ] filter detected words against allowlist

**depends on**: 0.1, 1.2

**acceptance criteria**:
```
given: content "const myString: string = existingUser"
  when: gerund detection runs
    then: "string" is filtered out (allowlisted)
    then: "existingUser" remains as detected gerund
```

**verify**:
```bash
echo '{"tool_name":"Write","tool_input":{"file_path":"x.ts","content":"const s: string = existingUser"}}' \
  | bash src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.sh 2>&1 \
  | grep -q "existingUser" && echo "âœ” PASS: detects existingUser" || echo "âœ˜ FAIL"
```

---

### 1.4 add block message output
- [ ] format block message per blueprint spec
- [ ] include file path
- [ ] list detected gerunds with alternatives
- [ ] exit 2 on block

**depends on**: 1.3

**acceptance criteria**:
```
given: Write with gerund "loadingState"
  when: hook blocks
    then: stderr contains "ðŸ›‘ BLOCKED"
    then: stderr contains "loadingState"
    then: exit code is 2
```

**verify**:
```bash
result=$(echo '{"tool_name":"Write","tool_input":{"file_path":"x.ts","content":"const loadingState = true"}}' \
  | bash src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.sh 2>&1) || true
echo "$result" | grep -q "BLOCKED" && echo "âœ” PASS: shows BLOCKED" || echo "âœ˜ FAIL"
echo "$result" | grep -q "loadingState" && echo "âœ” PASS: shows gerund" || echo "âœ˜ FAIL"
```

---

## phase 2: HARDNUDGE

### 2.1 add nudge track file management
- [ ] locate .claude directory
- [ ] create gerund.nudges.local.json if absent
- [ ] read/write timestamps per nudge key

**depends on**: 1.4

**acceptance criteria**:
```
given: .claude directory exists
  when: hook records a nudge
    then: gerund.nudges.local.json contains the key with timestamp
```

**verify**:
```bash
# after run that triggers block
cat .claude/gerund.nudges.local.json | jq -e 'keys | length > 0' && echo "âœ” PASS" || echo "âœ˜ FAIL"
```

---

### 2.2 implement 5-minute retry window
- [ ] compute nudge key as sha256(file_path + gerund)
- [ ] check if prior attempt within 300 seconds
- [ ] if within window: allow (exit 0)
- [ ] if outside window: block and record new timestamp

**depends on**: 2.1

**acceptance criteria**:
```
given: Write with gerund "existingUser"
  when: first attempt
    then: blocked with exit 2
  when: immediate retry (within 5 min)
    then: allowed with exit 0
```

**verify**:
```bash
# first attempt - should block
echo '{"tool_name":"Write","tool_input":{"file_path":"test.ts","content":"existingUser"}}' \
  | bash src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.sh 2>/dev/null && echo "âœ˜ FAIL: should block first" || echo "âœ” PASS: blocks first"

# second attempt - should allow
echo '{"tool_name":"Write","tool_input":{"file_path":"test.ts","content":"existingUser"}}' \
  | bash src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.sh 2>/dev/null && echo "âœ” PASS: allows retry" || echo "âœ˜ FAIL: should allow retry"
```

---

### 2.3 add stale entry cleanup
- [ ] prune entries older than 1 hour on each run

**depends on**: 2.2

**acceptance criteria**:
```
given: nudge file with entry from 2 hours ago
  when: hook runs
    then: stale entry is removed
```

**verify**: manual test with backdated timestamp

---

## phase 3: test suite

### 3.1 create test script
- [ ] create `src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.test.sh`
- [ ] add test helpers (build_stdin_json, assert_exit_code, etc.)
- [ ] follow pattern from pretooluse.forbid-stderr-redirect.test.sh

**depends on**: 2.2

**acceptance criteria**:
```
given: test script exists
  when: run
    then: outputs PASS/FAIL for each test case
    then: exits 0 if all pass, 1 if any fail
```

---

### 3.2 implement all test cases from blueprint
- [ ] Write with gerund - first attempt blocks
- [ ] Write with gerund - retry allows
- [ ] Write with allowlisted "string" - allows
- [ ] Write with "building" - blocks (no noun exceptions)
- [ ] Edit with gerund in new_string - blocks
- [ ] Edit with gerund only in old_string - allows
- [ ] Write without -ing words - allows
- [ ] Bash tool call - allows
- [ ] multiple gerunds - blocks, lists all

**depends on**: 3.1

**acceptance criteria**:
```
given: test suite complete
  when: run
    then: all 9+ test cases pass
```

**verify**:
```bash
bash src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.test.sh && echo "âœ” ALL TESTS PASS" || echo "âœ˜ TESTS FAILED"
```

---

## phase 4: hook registration

### 4.1 update init.claude.hooks.sh
- [ ] add run_findsert for Write matcher
- [ ] add run_findsert for Edit matcher
- [ ] place after forbid-stderr-redirect, before check-permissions

**depends on**: 3.2

**acceptance criteria**:
```
given: init.claude.hooks.sh updated
  when: run
    then: hook bound for Write matcher
    then: hook bound for Edit matcher
```

**verify**:
```bash
bash src/domain.roles/mechanic/inits/init.claude.hooks.sh 2>&1 | grep -q "forbid-gerunds" && echo "âœ” PASS" || echo "âœ˜ FAIL"
cat .claude/settings.json | jq '.hooks.PreToolUse' | grep -q "forbid-gerunds" && echo "âœ” PASS: registered" || echo "âœ˜ FAIL"
```

---

## phase 5: build and validate

### 5.1 build dist
- [ ] run `npm run build`
- [ ] verify dist/domain.roles/mechanic/inits/claude.hooks/ contains new files

**depends on**: 4.1

**acceptance criteria**:
```
given: build complete
  when: check dist directory
    then: pretooluse.forbid-gerunds.sh exists
    then: gerunds.allowlist.jsonc exists
```

**verify**:
```bash
npm run build && \
  ls dist/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.sh && \
  ls dist/domain.roles/mechanic/inits/claude.hooks/gerunds.allowlist.jsonc && \
  echo "âœ” PASS" || echo "âœ˜ FAIL"
```

---

### 5.2 end-to-end test in real session
- [ ] start new claude session
- [ ] attempt Write with gerund
- [ ] verify block message appears
- [ ] retry same operation
- [ ] verify retry succeeds

**depends on**: 5.1

**acceptance criteria**:
```
given: new claude session with hook active
  when: attempt to write file with "existingUser"
    then: blocked with guidance message
  when: retry the same write
    then: operation proceeds
```

**verify**: manual test in claude session

---

## phase 6: cleanup

### 6.1 add gerund.nudges.local.json to .gitignore
- [ ] ensure .claude/gerund.nudges.local.json is not committed

**depends on**: 5.2

**acceptance criteria**:
```
given: .gitignore updated
  when: git status
    then: gerund.nudges.local.json not shown as untracked
```

---

## dependency graph

```
0.1 allowlist
 â”‚
 â”œâ”€â”€â–¶ 1.1 skeleton
 â”‚     â”‚
 â”‚     â””â”€â”€â–¶ 1.2 content extraction
 â”‚           â”‚
 â”‚           â””â”€â”€â–¶ 1.3 gerund detection â—€â”€â”€ 0.1
 â”‚                 â”‚
 â”‚                 â””â”€â”€â–¶ 1.4 block message
 â”‚                       â”‚
 â”‚                       â””â”€â”€â–¶ 2.1 nudge file mgmt
 â”‚                             â”‚
 â”‚                             â””â”€â”€â–¶ 2.2 retry window
 â”‚                                   â”‚
 â”‚                                   â”œâ”€â”€â–¶ 2.3 cleanup
 â”‚                                   â”‚
 â”‚                                   â””â”€â”€â–¶ 3.1 test script
 â”‚                                         â”‚
 â”‚                                         â””â”€â”€â–¶ 3.2 all test cases
 â”‚                                               â”‚
 â”‚                                               â””â”€â”€â–¶ 4.1 hook registration
 â”‚                                                     â”‚
 â”‚                                                     â””â”€â”€â–¶ 5.1 build
 â”‚                                                           â”‚
 â”‚                                                           â””â”€â”€â–¶ 5.2 e2e test
 â”‚                                                                 â”‚
 â”‚                                                                 â””â”€â”€â–¶ 6.1 gitignore
```

## summary

| phase | steps | description |
|-------|-------|-------------|
| 0 | 1 | foundation (allowlist) |
| 1 | 4 | core hook without HARDNUDGE |
| 2 | 3 | HARDNUDGE retry logic |
| 3 | 2 | test suite |
| 4 | 1 | hook registration |
| 5 | 2 | build and e2e validation |
| 6 | 1 | cleanup |

**total**: 14 steps
