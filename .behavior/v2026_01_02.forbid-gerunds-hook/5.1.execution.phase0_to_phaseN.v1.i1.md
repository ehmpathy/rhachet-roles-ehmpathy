# execution: forbid-gerunds-hook

## phase 0: foundation

### 0.1 create allowlist file
- [x] create `src/domain.roles/mechanic/inits/claude.hooks/gerunds.allowlist.jsonc`
- [x] add `string` to primitives array with comment

**status**: ✅ complete

---

## phase 1: core hook (no HARDNUDGE)

### 1.1 create hook script skeleton
- [x] create `src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.sh`
- [x] add shebang, header comment, `set -euo pipefail`
- [x] read stdin JSON
- [x] extract tool_name

**status**: ✅ complete

---

### 1.2 add content extraction
- [x] extract content from Write tool (`tool_input.content`)
- [x] extract content from Edit tool (`tool_input.new_string`)
- [x] skip old_string (only scan additions)

**status**: ✅ complete

---

### 1.3 add gerund detection
- [x] extract all -ing words via regex (with camelCase split)
- [x] load allowlist from gerunds.allowlist.jsonc
- [x] filter detected words against allowlist

**status**: ✅ complete

---

### 1.4 add block message output
- [x] format block message per blueprint spec
- [x] include file path
- [x] list detected gerunds with alternatives (80+ patterns)
- [x] exit 2 on block

**status**: ✅ complete

---

## phase 2: HARDNUDGE

### 2.1 add nudge track file management
- [x] locate .claude directory
- [x] create gerund.nudges.local.json if absent
- [x] read/write timestamps per nudge key

**status**: ✅ complete

---

### 2.2 implement 5-minute retry window
- [x] compute nudge key as sha256(file_path + gerund)
- [x] check if prior attempt within 300 seconds
- [x] if within window: allow (exit 0)
- [x] if outside window: block and record new timestamp

**status**: ✅ complete

---

### 2.3 add stale entry cleanup
- [x] prune entries older than 1 hour on each run

**status**: ✅ complete

---

## phase 3: test suite

### 3.1 create test script
- [x] create `src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.test.sh`
- [x] add test helpers (build_write_json, build_edit_json, assert_blocks_with_output, etc.)
- [x] follow pattern from pretooluse.forbid-stderr-redirect.test.sh

**status**: ✅ complete

---

### 3.2 implement all test cases
- [x] Write with gerund - first attempt blocks
- [x] Write with gerund - retry allows
- [x] Write with allowlisted "string" - allows
- [x] Write with "building" - blocks (no noun exceptions)
- [x] Edit with gerund in new_string - blocks
- [x] Edit with gerund only in old_string - allows
- [x] Write without -ing words - allows
- [x] Bash tool call - allows
- [x] multiple gerunds - blocks, lists all
- [x] empty stdin - exits 2

**status**: ✅ complete (13/13 tests pass)

---

## phase 4: hook registration

### 4.1 update init.claude.hooks.sh
- [x] add run_findsert for Write matcher (`pretooluse.forbid-gerunds.write`)
- [x] add run_findsert for Edit matcher (`pretooluse.forbid-gerunds.edit`)
- [x] update header comment

**status**: ✅ complete

---

## phase 5: build and validate

### 5.1 build dist
- [x] run `npm run build`
- [x] verify dist contains `pretooluse.forbid-gerunds.sh`
- [x] verify dist contains `gerunds.allowlist.jsonc`

**status**: ✅ complete

---

### 5.2 end-to-end test
- [x] run init.claude.hooks.sh
- [x] verify hooks bound for Write and Edit matchers
- [x] verify hooks in .claude/settings.json

**status**: ✅ complete

---

## phase 6: cleanup

### 6.1 add to .gitignore
- [x] verify `*.local.json` pattern in .gitignore covers `gerund.nudges.local.json`

**status**: ✅ complete (already covered by existing pattern)

---

## progress summary

| phase | status |
|-------|--------|
| 0 | ✅ complete |
| 1 | ✅ complete |
| 2 | ✅ complete |
| 3 | ✅ complete |
| 4 | ✅ complete |
| 5 | ✅ complete |
| 6 | ✅ complete |

## files created/modified

### new files
- `src/domain.roles/mechanic/inits/claude.hooks/gerunds.allowlist.jsonc`
- `src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.sh`
- `src/domain.roles/mechanic/inits/claude.hooks/pretooluse.forbid-gerunds.test.sh`

### modified files
- `src/domain.roles/mechanic/inits/init.claude.hooks.sh` (added hook registration)
