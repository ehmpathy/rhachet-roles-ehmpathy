# roadmap: get.package.docs

## overview

execute the blueprint in 5 phases:

1. **scaffold** — create skill shell with header and arg parse
2. **filetree** — implement filetree subcommand
3. **readme:local** — implement readme from node_modules
4. **readme:remote** — implement readme from npm api with cache
5. **brief** — create workflow rule brief

each phase has acceptance criteria and verification steps.

---

## phase 0: prep

### read before start

- [ ] `.behavior/v2026_01_31.get-readmes/3.3.blueprint.v1.i1.md` — the full blueprint
- [ ] `.behavior/v2026_01_31.get-readmes/3.1.research.patterns._.code.prod.v1.i1.md` — skill structure patterns

### checklist

- [ ] ensure `node_modules/` has test packages installed (e.g., `test-fns`, `domain-objects`)
- [ ] verify `jq`, `curl`, `tree` are available: `which jq curl tree`

### verify

```sh
which jq curl tree && echo "✓ deps ready"
ls node_modules/test-fns/package.json && echo "✓ test package available"
```

---

## phase 1: scaffold

### read before start

- [ ] `.behavior/v2026_01_31.get-readmes/3.1.research.patterns._.code.prod.v1.i1.md` — pattern.1 (skill shell structure)

### checklist

- [ ] create `src/domain.roles/mechanic/skills/get.package.docs.sh`
- [ ] add shebang: `#!/usr/bin/env bash`
- [ ] add header block with `.what`, `.why`, usage, guarantee
- [ ] add `set -euo pipefail`
- [ ] add arg parse loop (reuse pattern from cpsafe.sh)
  - [ ] ignore `--skill|--repo|--role` (rhachet passthrough)
  - [ ] capture subcommand: `readme|filetree`
  - [ ] capture `--of` → `$PACKAGE`
  - [ ] error on unknown args
- [ ] add package validation: check `node_modules/$PACKAGE` exists
- [ ] add version detection: `jq -r '.version' "node_modules/$PACKAGE/package.json"`
- [ ] add subcommand dispatch stub: `case $SUBCOMMAND in readme|filetree`
- [ ] make executable: `chmod +x`

### acceptance criteria

```
given('skill is invoked with --of test-fns')
  when('package exists in node_modules')
    then('no error is thrown')
    then('version is detected correctly')

given('skill is invoked with --of nonexistent-pkg')
  when('package does not exist')
    then('error: package not found in node_modules')
```

### verify

```sh
npm run build
npx rhachet roles link --role mechanic
npx rhachet run --skill get.package.docs readme --of test-fns
# expect: stub output or empty (no error)

npx rhachet run --skill get.package.docs readme --of nonexistent-pkg-12345
# expect: error message about package not found
```

---

## phase 2: filetree

### checklist

- [ ] implement `_get_filetree()` function
- [ ] use `tree -a --noreport "node_modules/$PACKAGE"`
- [ ] wire up dispatch: `filetree) _get_filetree ;;`

### acceptance criteria

```
given('package test-fns is installed')
  when('filetree subcommand is called')
    then('directory tree of node_modules/test-fns is returned')
```

### verify

```sh
npm run build && npx rhachet roles link --role mechanic
npx rhachet run --skill get.package.docs filetree --of test-fns
# expect: tree output of test-fns package
```

---

## phase 3: readme:local

### checklist

- [ ] implement `_get_readme()` function
- [ ] add case-insensitive readme glob: `find ... -iname "readme.md"`
- [ ] if found in node_modules → cat and exit
- [ ] wire up dispatch: `readme) _get_readme ;;`

### acceptance criteria

```
given('package with readme in node_modules')
  when('readme subcommand is called')
    then('readme content is returned from node_modules')
```

### verify

```sh
npm run build && npx rhachet roles link --role mechanic
npx rhachet run --skill get.package.docs readme --of test-fns
# expect: readme content displayed

# verify it's from node_modules (not network)
ls node_modules/test-fns/README.md && echo "✓ readme exists locally"
```

---

## phase 4: readme:remote

### read before start

- [ ] `.behavior/v2026_01_31.get-readmes/3.1.research.access._.v1.i1.md` — npm registry api contract

### checklist

- [ ] add cache directory bootstrap (findsert pattern)
  - [ ] `mkdir -p .refs/get.package.docs`
  - [ ] create `.gitignore` with `*` if not exists
- [ ] add scoped package path encode
  - [ ] cache path: `@scope/name` → `@scope__name`
  - [ ] api url: `@scope/name` → `@scope%2Fname`
- [ ] add cache check: if cached file exists → cat and exit
- [ ] add npm api fetch: `curl -s "https://registry.npmjs.org/$PACKAGE_ENCODED/$VERSION"`
- [ ] parse readme: `jq -r '.readme // empty'`
- [ ] if readme found → cache to file, output, exit
- [ ] if readme empty → error with filetree suggestion
- [ ] handle curl failure → error with network message

### acceptance criteria

```
given('package without readme in node_modules but on npm')
  when('readme subcommand is called')
    then('readme is fetched from npm registry')
    then('readme is cached to .refs/get.package.docs/$package.$version.readme.md')
    then('subsequent call uses cache (no network)')

given('scoped package like @ehmpathy/as-command')
  when('readme is requested')
    then('scoped name is handled correctly in api call')
    then('cache path uses __ instead of /')

given('first use of skill')
  when('.refs/get.package.docs/ does not exist')
    then('directory is created')
    then('.gitignore with * is created')

given('package with no readme anywhere')
  when('readme is requested')
    then('error message is returned')
    then('filetree suggestion is shown')
```

### verify

```sh
npm run build && npx rhachet roles link --role mechanic

# test cache bootstrap
rm -rf .refs/get.package.docs
npx rhachet run --skill get.package.docs readme --of some-package-without-local-readme
ls .refs/get.package.docs/.gitignore && echo "✓ gitignore created"
cat .refs/get.package.docs/.gitignore  # should show: *

# test cache reuse (second call should be instant)
time npx rhachet run --skill get.package.docs readme --of some-package > /dev/null
# first call: slower (network)
time npx rhachet run --skill get.package.docs readme --of some-package > /dev/null
# second call: faster (cache)

# test scoped package
npx rhachet run --skill get.package.docs readme --of @ehmpathy/as-command
ls .refs/get.package.docs/@ehmpathy__as-command.*.readme.md && echo "✓ scoped cache works"
```

---

## phase 5: brief

### read before start

- [ ] `.behavior/v2026_01_31.get-readmes/1.vision.md` — the workflow rule section

### checklist

- [ ] create `src/domain.roles/mechanic/briefs/practices/work.flow/tools/rule.require.read-package-docs-before-use.md`
- [ ] document the rule: read docs before use of unfamiliar package api
- [ ] include command examples
- [ ] explain what it prevents (boilerplate, misuse, reinvention)

### acceptance criteria

```
given('the brief exists')
  when('mechanic role is loaded')
    then('the rule appears in briefs')
```

### verify

```sh
npm run build && npx rhachet roles link --role mechanic
cat .agent/repo=ehmpathy/role=mechanic/briefs/practices/work.flow/tools/rule.require.read-package-docs-before-use.md
# expect: rule content displayed
```

---

## phase 6: integration tests

### read before start

- [ ] `.behavior/v2026_01_31.get-readmes/2.1.criteria.blackbox.md` — all blackbox criteria
- [ ] `.behavior/v2026_01_31.get-readmes/3.1.research.patterns._.code.test.v1.i1.md` (if declared)

### checklist

- [ ] create `src/domain.roles/mechanic/skills/get.package.docs.integration.test.ts`
- [ ] implement 7 test cases from blueprint:
  - [ ] case1: package with readme in node_modules
  - [ ] case2: package without readme in node_modules but on npm
  - [ ] case3: package with no readme anywhere
  - [ ] case4: package not installed
  - [ ] case5: filetree subcommand
  - [ ] case6: scoped package
  - [ ] case7: cache directory bootstrap
- [ ] use `given/when/then` from `test-fns`
- [ ] invoke skill via `execa` or `child_process`

### acceptance criteria

```
given('all integration tests')
  when('npm run test:integration -- get.package.docs')
    then('all 7 cases pass')
```

### verify

```sh
npm run test:integration -- get.package.docs.integration.test.ts
# expect: all tests pass
```

---

## final verification

```sh
# full build + link
npm run build && npx rhachet roles link --role mechanic && npx rhachet roles init --role mechanic

# smoke test all subcommands
npx rhachet run --skill get.package.docs readme --of test-fns
npx rhachet run --skill get.package.docs filetree --of test-fns

# run all tests
npm run test:integration -- get.package.docs

# verify brief is accessible
grep -r "read-package-docs" .agent/repo=ehmpathy/role=mechanic/briefs/
```

---

## dependency graph

```
phase 0 (prep)
    │
    v
phase 1 (scaffold)
    │
    ├──────────────┐
    v              v
phase 2        phase 3
(filetree)     (readme:local)
                   │
                   v
               phase 4
               (readme:remote)
                   │
    ┌──────────────┴──────────────┐
    v                             v
phase 5                       phase 6
(brief)                       (integration tests)
```
