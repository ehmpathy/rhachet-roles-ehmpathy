# blueprint: get.package.docs

## summary

implement a pure shell skill that fetches package documentation:
- `rhx get.package.docs readme --of $package` — fetch and display readme
- `rhx get.package.docs filetree --of $package` — display package file tree

the skill checks sources in priority order: node_modules → cache → npm registry api

## filediffs

```
src/domain.roles/mechanic/
  └── skills/
      └── [+] get.package.docs.sh           # main skill executable

  └── briefs/
      └── practices/
          └── work.flow/
              └── tools/
                  └── [+] rule.require.read-package-docs-before-use.md
```

**legend:**
- `[+]` create — file to create
- `[~]` update — file to update
- `[-]` delete — file to delete

## codepaths

```
get.package.docs.sh
  │
  ├── [+] header block
  │   ├── shebang: #!/usr/bin/env bash
  │   ├── .what/.why documentation
  │   ├── usage examples
  │   └── guarantee declarations
  │
  ├── [+] setup
  │   └── set -euo pipefail
  │
  ├── [←] arg parse (reuse pattern from cpsafe.sh)
  │   ├── --skill|--repo|--role → ignore (rhachet passthrough)
  │   ├── readme|filetree → SUBCOMMAND
  │   ├── --of → PACKAGE
  │   └── unknown → error + exit 1
  │
  ├── [+] validate package installed
  │   ├── check: node_modules/$PACKAGE exists
  │   └── error: "package not found in node_modules. install it first."
  │
  ├── [+] get version
  │   └── VERSION=$(jq -r '.version' "node_modules/$PACKAGE/package.json")
  │
  ├── [+] dispatch subcommand
  │   ├── readme → _get_readme
  │   └── filetree → _get_filetree
  │
  ├── [+] _get_filetree()
  │   └── tree -a --noreport "node_modules/$PACKAGE"
  │
  ├── [+] _get_readme()
  │   │
  │   ├── [+] try node_modules readme
  │   │   ├── glob for README.md (case-insensitive)
  │   │   └── if found → cat and exit
  │   │
  │   ├── [+] try cache
  │   │   ├── compute cache path: .refs/get.package.docs/$PACKAGE_SAFE.$VERSION.readme.md
  │   │   ├── if cached → cat and exit
  │   │   └── (scoped packages: @scope/name → @scope__name)
  │   │
  │   ├── [+] try npm registry api
  │   │   ├── url encode package name (scoped: @scope%2Fname)
  │   │   ├── curl -s "https://registry.npmjs.org/$PACKAGE_ENCODED/$VERSION"
  │   │   ├── jq -r '.readme // empty'
  │   │   ├── if empty → fallback to error
  │   │   └── if found → cache result, output, exit
  │   │
  │   ├── [+] bootstrap cache dir (findsert pattern)
  │   │   ├── mkdir -p .refs/get.package.docs
  │   │   └── echo "*" > .refs/get.package.docs/.gitignore (if not exists)
  │   │
  │   └── [+] error: readme not found
  │       ├── error message with emoji (storm cloud pattern)
  │       └── suggest: use filetree subcommand
  │
  └── [←] error output pattern (reuse from init.behavior.ts)
      └── emoji + message + suggestion format
```

**legend:**
- `[+]` create — codepath to create
- `[~]` update — codepath to update
- `[○]` retain — codepath to retain
- `[-]` delete — codepath to delete
- `[←]` reuse — codepath to reuse from elsewhere
- `[→]` eject — codepath to decompose for reuse

## contracts

### input contract

```sh
# subcommand as first positional arg
rhx get.package.docs readme --of $package
rhx get.package.docs filetree --of $package
```

### output contract

| subcommand | output |
|------------|--------|
| `readme` | readme content to stdout |
| `filetree` | tree output to stdout |

### error contract

| condition | message |
|-----------|---------|
| package not installed | `error: package '$PACKAGE' not found in node_modules. install it first.` |
| readme not found anywhere | `error: readme not found for '$PACKAGE'. try: rhx get.package.docs filetree --of $PACKAGE` |
| npm api unreachable | `error: could not fetch readme from npm registry. check network or use filetree.` |

### cache contract

```
.refs/get.package.docs/
  ├── .gitignore                           # contains: *
  ├── iso-price.1.0.0.readme.md           # regular package
  └── @ehmpathy__as-command.2.0.0.readme.md  # scoped package (/ → __)
```

## test coverage

### unit tests

none required — pure shell with no complex logic to isolate

### integration tests

| test | what it covers |
|------|----------------|
| `get.package.docs.integration.test.ts` | all blackbox criteria |

```
given('[case1] package with readme in node_modules')
  when('[t0] readme subcommand is called')
    then('readme content is returned')
    then('readme is cached')

given('[case2] package without readme in node_modules but on npm')
  when('[t0] readme subcommand is called')
    then('readme is fetched from npm registry')
    then('readme is cached')
    then('subsequent call uses cache')

given('[case3] package with no readme anywhere')
  when('[t0] readme subcommand is called')
    then('error message is returned')
    then('filetree suggestion is shown')

given('[case4] package not installed')
  when('[t0] readme subcommand is called')
    then('error: package not found in node_modules')

given('[case5] filetree subcommand')
  when('[t0] filetree is called for installed package')
    then('tree output is returned')

given('[case6] scoped package like @ehmpathy/as-command')
  when('[t0] readme subcommand is called')
    then('scoped name is handled correctly')
    then('cache path uses __ instead of /')

given('[case7] cache directory bootstrap')
  when('[t0] first use of skill')
    then('.refs/get.package.docs/ is created')
    then('.gitignore with * is created')
```

### acceptance tests

none required — integration tests cover blackbox behaviors via shell invocation

## implementation notes

### scoped package path encode

```bash
# for cache paths: replace / with __
PACKAGE_SAFE="${PACKAGE/\//__}"
# result: @ehmpathy/as-command → @ehmpathy__as-command

# for npm api: url encode the /
PACKAGE_ENCODED="${PACKAGE/\//%2F}"
# result: @ehmpathy/as-command → @ehmpathy%2Fas-command
```

### readme glob (case-insensitive)

```bash
# find README.md regardless of case
README_FILE=$(find "node_modules/$PACKAGE" -maxdepth 1 -iname "readme.md" -type f | head -1)
```

### cache bootstrap (findsert pattern)

```bash
CACHE_DIR=".refs/get.package.docs"
if [[ ! -d "$CACHE_DIR" ]]; then
  mkdir -p "$CACHE_DIR"
  echo "*" > "$CACHE_DIR/.gitignore"
fi
```

### npm api call

```bash
README=$(curl -s "https://registry.npmjs.org/$PACKAGE_ENCODED/$VERSION" | jq -r '.readme // empty')
```

## dependencies

| dependency | purpose | availability |
|------------|---------|--------------|
| `bash` | shell execution | standard |
| `jq` | json parse | standard in dev environments |
| `curl` | http requests | standard |
| `tree` | directory tree | standard |
| `find` | file glob | standard |

## permissions

the skill is auto-approved via the generic `npx rhachet run:*` pattern already present in `init.claude.permissions.jsonc`. no explicit entry needed.

## risk assessment

| risk | likelihood | mitigation |
|------|------------|------------|
| npm api rate limit | low | cache reduces calls |
| large readme (>64K from api) | low | npm truncates; no action needed |
| malformed package name | low | validate via node_modules existence first |
| network timeout | medium | clear error message + filetree fallback |
