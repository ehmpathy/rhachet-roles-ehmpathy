# research: production code patterns for get.package.docs

## pattern.1 = skill shell executable structure [REUSE]

**what**: standard structure for rhachet skills

**location**: `src/domain.roles/mechanic/skills/*.sh`

**pattern**:
```bash
#!/usr/bin/env bash
######################################################################
# .what = one-line description
#
# .why  = why this skill exists
#         - benefit 1
#         - benefit 2
#
# usage:
#   skill.sh --arg "value"
#
# guarantee:
#   - what this skill guarantees
######################################################################
set -euo pipefail

# parse named arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --skill|--repo|--role)  # rhachet passthrough - ignore
      shift 2
      ;;
    --my-arg)
      MY_ARG="$2"
      shift 2
      ;;
    *)
      echo "unknown argument: $1"
      exit 1
      ;;
  esac
done

# validation
# execution
# output
```

**citations**:

[1] from `show.gh.test.errors.sh`:
```bash
#!/usr/bin/env bash
######################################################################
# .what = show test errors from the latest test workflow run
#
# .why  = focused command for the most common ci debug task:
```

[2] from `cpsafe.sh`:
```bash
set -euo pipefail
...
while [[ $# -gt 0 ]]; do
  case $1 in
    --src)
      SRC="$2"
      shift 2
      ;;
```

**relation to wish**: the get.package.docs skill will follow this exact structure

---

## pattern.2 = skill subdirectories [REUSE]

**what**: skills organized in subdirectories by purpose

**location**: `src/domain.roles/mechanic/skills/claude.tools/`

**pattern**: Claude-specific tools live in `claude.tools/` subdirectory

**citations**:

[3] directory structure shows:
```
src/domain.roles/mechanic/skills/
  ├── claude.tools/
  │   ├── cpsafe.sh
  │   ├── mvsafe.sh
  │   ├── rmsafe.sh
  │   ├── sedreplace.sh
  │   └── symlink.sh
  ├── show.gh.action.logs.sh
  └── show.gh.test.errors.sh
```

**relation to wish**: get.package.docs could live in `claude.tools/` or at root level

---

## pattern.3 = skill delegation [REUSE]

**what**: skills can delegate to other skills via `exec`

**location**: `src/domain.roles/mechanic/skills/show.gh.test.errors.sh`

**pattern**:
```bash
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
exec "$SCRIPT_DIR/other-skill.sh" --flow "$FLOW" "${ARGS[@]}"
```

**citations**:

[4] from `show.gh.test.errors.sh`:
```bash
# resolve the directory where this skill lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
...
# dispatch to show.gh.action.logs.sh with defaults
exec "$SCRIPT_DIR/show.gh.action.logs.sh" --flow "$FLOW" "${ARGS[@]}"
```

**relation to wish**: get.package.docs has two subcommands (readme, filetree) - could use delegation or single executable with subcommand parse

---

## pattern.4 = repo boundary validation [REUSE]

**what**: validate paths are within git repo before file operations

**location**: `src/domain.roles/mechanic/skills/claude.tools/cpsafe.sh`

**pattern**:
```bash
# get repo root
REPO_ROOT=$(git rev-parse --show-toplevel)

# resolve absolute paths
PATH_ABS=$(realpath -m "$PATH")

# validate within repo
if [[ "$PATH_ABS" != "$REPO_ROOT"* ]]; then
  echo "error: path must be within the git repository"
  exit 1
fi
```

**citations**:

[5] from `cpsafe.sh`:
```bash
# get repo root
REPO_ROOT=$(git rev-parse --show-toplevel)

# resolve absolute paths
SRC_ABS=$(realpath -m "$SRC")
DEST_ABS=$(realpath -m "$DEST")

# validate source is within repo
if [[ "$SRC_ABS" != "$REPO_ROOT"* ]]; then
  echo "error: source must be within the git repository"
```

**relation to wish**: cache writes to `.refs/get.package.docs/` should validate they're within repo

---

## pattern.5 = permissions declaration [EXTEND]

**what**: auto-approve skills via permission patterns

**location**: `src/domain.roles/mechanic/inits/init.claude.permissions.jsonc`

**pattern**:
```jsonc
"allow": [
  "Bash(npx rhachet run --skill skillname:*)"
]
```

**citations**:

[6] from `init.claude.permissions.jsonc`:
```jsonc
// sedreplace - safe bulk find-and-replace on git-tracked files only
"Bash(npx rhachet run --skill sedreplace:*)",

// cpsafe - safe file copy within git repo (source must be git-tracked)
"Bash(npx rhachet run --skill cpsafe:*)",
```

[7] generic pattern also exists:
```jsonc
// any skill, really
"Bash(npx rhachet run:*)",
```

**relation to wish**: get.package.docs will be auto-approved via the generic `npx rhachet run:*` pattern; no explicit entry needed

---

## pattern.6 = directory bootstrap with .gitignore [NEW]

**what**: create directory with .gitignore on first use

**pattern** (to implement):
```bash
CACHE_DIR=".refs/get.package.docs"

# bootstrap cache directory if needed
if [[ ! -d "$CACHE_DIR" ]]; then
  mkdir -p "$CACHE_DIR"
  echo "*" > "$CACHE_DIR/.gitignore"
fi
```

**relation to wish**: cache directory needs .gitignore to stay out of git

---

## pattern.7 = curl for http requests [REUSE]

**what**: use curl for api requests in shell

**citations**:

[8] from `show.gh.action.logs.sh` (uses gh cli which wraps http):
```bash
gh api --method GET "repos/$REPO/actions/runs/$RUN_ID/jobs" -q '.jobs'
```

**relation to wish**: npm registry api can be called via curl:
```bash
curl -s "https://registry.npmjs.org/$PACKAGE/$VERSION" | jq -r '.readme'
```

---

## pattern.8 = jq for json parse [REUSE]

**what**: use jq to parse json responses

**citations**:

[9] from `show.gh.action.logs.sh`:
```bash
RUN_ID=$(echo "$RUNS_JSON" | jq -r '.[0].databaseId')
WORKFLOW_NAME=$(echo "$RUNS_JSON" | jq -r '.[0].workflowName')
```

**relation to wish**: parse npm registry api response with jq:
```bash
README=$(curl -s "$URL" | jq -r '.readme // empty')
```

---

## pattern.9 = version detection from package.json [NEW]

**what**: read installed package version from node_modules

**pattern** (to implement):
```bash
# get installed version
VERSION=$(jq -r '.version' "node_modules/$PACKAGE/package.json")
```

**relation to wish**: need version for cache filename and npm api call

---

## summary

| pattern | action | reason |
|---------|--------|--------|
| skill structure | [REUSE] | standard header, arg parse, validation |
| skill subdirs | [REUSE] | organize in claude.tools/ or root |
| skill delegation | [REUSE] | subcommands via single executable |
| repo validation | [REUSE] | validate cache path within repo |
| permissions | [EXTEND] | already covered by generic pattern |
| dir bootstrap | [NEW] | .gitignore for cache |
| curl for http | [REUSE] | npm registry api calls |
| jq for json | [REUSE] | parse api response |
| version detect | [NEW] | read from package.json |
