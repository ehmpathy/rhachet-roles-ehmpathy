# roadmap: Role.hooks migration

## refs

- wish: `.behavior/v2026_01_19.role-hooks/0.wish.md`
- research: `.behavior/v2026_01_19.role-hooks/3.1.research.access._.v1.i1.md`
- blueprint: `.behavior/v2026_01_19.role-hooks/3.3.blueprint.v1.i1.md`

---

## step 1: verify rhachet version supports Role.hooks

### task
confirm rhachet dependency includes Role.hooks interface (v1.24.0+)

### depends on
- (none — first step)

### acceptance criteria
- [ ] `npm view rhachet version` shows >= 1.24.0
- [ ] Role interface in node_modules includes `hooks?: RoleHooks` property

### verification
```bash
# check installed version
npm view rhachet version

# check Role interface has hooks property
grep -A5 "hooks?:" node_modules/rhachet/dist/domain.objects/Role.d.ts
```

---

## step 2: write unit tests for Role.hooks declaration

### task
create unit tests that verify the mechanic role declares all 7 hooks with correct structure

### depends on
- step 1 (rhachet version verified)

### acceptance criteria
- [ ] test file exists at `src/domain.roles/mechanic/getMechanicRole.test.ts`
- [ ] tests verify `onBrain.onBoot` contains 3 hooks
- [ ] tests verify `onBrain.onTool` contains 4 hooks
- [ ] tests verify `onBrain.onStop` is empty array
- [ ] tests verify hook commands match expected patterns
- [ ] tests verify hook timeouts use ISO 8601 format
- [ ] tests verify onTool filters match expected tools

### verification
```bash
# tests should fail initially (hooks not yet declared)
npm run test:unit -- getMechanicRole.test.ts
# expected: FAIL (hooks property undefined)
```

---

## step 3: add hooks property to getMechanicRole.ts

### task
declare all 7 hooks in the ROLE_MECHANIC definition

### depends on
- step 2 (unit tests written)

### acceptance criteria
- [ ] `getMechanicRole.ts` includes `hooks: { onBrain: { ... } }` property
- [ ] onBoot declares 3 hooks: notify-permissions, boot.this, boot.mechanic
- [ ] onTool declares 4 hooks: forbid-stderr-redirect, forbid-terms.gerunds, forbid-terms.blocklist, check-permissions
- [ ] onStop declares empty array
- [ ] all commands use `./node_modules/.bin/rhachet` format
- [ ] all timeouts use ISO 8601 format (PT5S, PT60S)
- [ ] onTool filters use correct tool matchers (Bash, Write|Edit)

### verification
```bash
# unit tests should now pass
npm run test:unit -- getMechanicRole.test.ts
# expected: PASS (all assertions green)

# type check passes
npm run test:types
# expected: no errors
```

---

## step 4: write integration tests for hook registration

### task
create integration tests that verify hooks are written to .claude/settings.json

### depends on
- step 3 (hooks declared in role)

### acceptance criteria
- [ ] test file exists at `src/domain.roles/mechanic/getMechanicRole.integration.test.ts`
- [ ] tests create isolated temp directory with git repo
- [ ] tests execute `rhachet roles init --role mechanic`
- [ ] tests verify SessionStart hooks appear in settings.json
- [ ] tests verify PreToolUse hooks appear in settings.json
- [ ] tests verify hooks have correct author format
- [ ] tests clean up temp directory after run

### verification
```bash
# integration tests should pass
npm run test:integration -- getMechanicRole.integration.test.ts
# expected: PASS (hooks registered correctly)
```

---

## step 5: verify hook registration manually

### task
run `rhachet roles init` and inspect .claude/settings.json

### depends on
- step 4 (integration tests pass)

### acceptance criteria
- [ ] `./node_modules/.bin/rhachet roles init --role mechanic` completes without error
- [ ] `.claude/settings.json` contains `hooks.SessionStart` array with 3 entries
- [ ] `.claude/settings.json` contains `hooks.PreToolUse` array with entries for Bash and Write|Edit
- [ ] each hook entry has `author` field with format `repo=ehmpathy/role=mechanic`
- [ ] re-run init does not duplicate hooks (idempotent)

### verification
```bash
# run init
./node_modules/.bin/rhachet roles init --role mechanic

# inspect settings
cat .claude/settings.json | jq '.hooks'

# verify idempotency - run again
./node_modules/.bin/rhachet roles init --role mechanic

# verify no duplicates
cat .claude/settings.json | jq '.hooks.SessionStart | length'
# expected: 3 (not 6)
```

---

## step 6: update init.claude.sh to remove shell-based hook registration

### task
remove the call to `init.claude.hooks.sh` from `init.claude.sh`

### depends on
- step 5 (hook registration verified)

### acceptance criteria
- [ ] `init.claude.sh` no longer calls `init.claude.hooks.sh`
- [ ] `init.claude.sh` still calls other init files (permissions, etc)
- [ ] run of `init.claude.sh` does not register hooks via shell
- [ ] run of `rhachet roles init` still registers hooks via Role.hooks

### verification
```bash
# grep for hook registration call
grep -n "init.claude.hooks" src/domain.roles/mechanic/inits/init.claude.sh
# expected: no matches (or only comments)

# run init.claude.sh directly
bash src/domain.roles/mechanic/inits/init.claude.sh
# expected: no hook registration output

# verify hooks still work via rhachet
./node_modules/.bin/rhachet roles init --role mechanic
cat .claude/settings.json | jq '.hooks.SessionStart | length'
# expected: 3
```

---

## step 7: verify hooks fire correctly at runtime

### task
start a claude code session and verify hooks execute

### depends on
- step 6 (init.claude.sh updated)

### acceptance criteria
- [ ] SessionStart:notify-permissions fires and outputs permission list
- [ ] SessionStart:boot.this fires (if .agent/repo=.this exists)
- [ ] SessionStart:boot.mechanic fires and outputs brief stats
- [ ] PreToolUse:forbid-stderr-redirect blocks `2>&1` in Bash commands
- [ ] PreToolUse:forbid-terms.gerunds blocks gerunds in Write/Edit
- [ ] PreToolUse:forbid-terms.blocklist blocks forbidden terms in Write/Edit
- [ ] PreToolUse:check-permissions validates Bash commands

### verification
```bash
# start new claude session and observe output
# expected: hook output visible at session start

# test gerund block via attempt to write a file with gerunds
# expected: blocked with exit code 2

# test stderr redirect block via Bash with 2>&1
# expected: blocked with exit code 2
```

---

## step 8: write acceptance tests for end-to-end behavior

### task
create acceptance tests that verify hooks block/allow correctly

### depends on
- step 7 (runtime behavior verified)

### acceptance criteria
- [ ] test file exists at `src/contract/commands/roles/init.acceptance.test.ts`
- [ ] tests verify idempotent registration (no duplicates on re-init)
- [ ] tests verify hook order matches declaration order
- [ ] tests verify hooks with matched author are removed on unlink

### verification
```bash
# acceptance tests should pass
npm run test:acceptance -- init.acceptance.test.ts
# expected: PASS
```

---

## step 9: deprecate shell-based hook files

### task
mark shell files for removal and verify no dependencies

### depends on
- step 8 (acceptance tests pass)

### acceptance criteria
- [ ] `init.claude.hooks.sh` is no longer imported or called anywhere
- [ ] `init.claude.hooks.findsert.sh` is no longer imported or called anywhere
- [ ] `init.claude.hooks.cleanup.sh` is no longer imported or called anywhere
- [ ] `init.claude.hooks.cleanup.repograin.sh` is no longer imported or called anywhere
- [ ] `init.claude.hooks.cleanup.localgrain.sh` is no longer imported or called anywhere

### verification
```bash
# search for references to deprecated files
grep -r "init.claude.hooks" src/ --include="*.sh" --include="*.ts"
# expected: no matches (or only the deprecated files themselves)

# verify build passes without deprecated files
npm run build
npm run test:types
# expected: PASS
```

---

## step 10: remove deprecated shell files

### task
delete the deprecated shell files

### depends on
- step 9 (no dependencies on deprecated files)

### acceptance criteria
- [ ] `init.claude.hooks.sh` removed
- [ ] `init.claude.hooks.findsert.sh` removed
- [ ] `init.claude.hooks.cleanup.sh` removed
- [ ] `init.claude.hooks.cleanup.repograin.sh` removed
- [ ] `init.claude.hooks.cleanup.localgrain.sh` removed
- [ ] build still passes
- [ ] all tests still pass

### verification
```bash
# remove files
rm src/domain.roles/mechanic/inits/init.claude.hooks.sh
rm src/domain.roles/mechanic/inits/init.claude.hooks.findsert.sh
rm src/domain.roles/mechanic/inits/init.claude.hooks.cleanup.sh
rm src/domain.roles/mechanic/inits/init.claude.hooks.cleanup.repograin.sh
rm src/domain.roles/mechanic/inits/init.claude.hooks.cleanup.localgrain.sh

# verify build
npm run build
# expected: PASS

# verify all tests
npm run test:unit
npm run test:integration
# expected: PASS
```

---

## step 11: final verification

### task
run full test suite and verify migration complete

### depends on
- step 10 (deprecated files removed)

### acceptance criteria
- [ ] `npm run build` passes
- [ ] `npm run test:types` passes
- [ ] `npm run test:unit` passes
- [ ] `npm run test:integration` passes
- [ ] new claude session boots with hooks via Role.hooks
- [ ] all 7 hooks fire correctly at appropriate lifecycle events

### verification
```bash
# full build and test
npm run build && npm run test:types && npm run test:unit && npm run test:integration
# expected: all PASS

# start fresh claude session
# expected: hooks fire at session start, tools blocked appropriately
```

---

## summary

| step | task | depends on |
|------|------|------------|
| 1 | verify rhachet version | — |
| 2 | write unit tests | 1 |
| 3 | add hooks to role | 2 |
| 4 | write integration tests | 3 |
| 5 | verify registration manually | 4 |
| 6 | update init.claude.sh | 5 |
| 7 | verify runtime behavior | 6 |
| 8 | write acceptance tests | 7 |
| 9 | deprecate shell files | 8 |
| 10 | remove deprecated files | 9 |
| 11 | final verification | 10 |
