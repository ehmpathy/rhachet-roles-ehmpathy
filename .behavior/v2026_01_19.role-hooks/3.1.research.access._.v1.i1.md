# research: remote access requirements for Role.hooks migration

## summary

this migration replaces custom shell-based hook registration with rhachet's declarative `Role.hooks` interface. the remote repositories accessed are:

1. **claude code settings** — local filesystem (`.claude/settings.json`)
2. **rhachet library** — npm package with `Role.hooks` interface

---

## 1. claude code hooks (local filesystem)

### 1.1 repository type
- local json file: `.claude/settings.json`
- interface: filesystem via shell/jq

### 1.2 contract

claude code hooks are configured via json in `.claude/settings.json` [1]:

```json
{
  "hooks": {
    "EventName": [
      {
        "matcher": "ToolPattern",
        "hooks": [
          {
            "type": "command",
            "command": "your-command-here",
            "timeout": 60
          }
        ]
      }
    ]
  }
}
```

### 1.3 hook events

| event | triggers | matcher support |
|-------|----------|-----------------|
| `SessionStart` | at session initialization | no matcher |
| `PreToolUse` | before tool execution | yes (Bash, Write, Edit, etc.) |
| `PostToolUse` | after tool completion | yes |
| `Stop` | when agent finishes | no matcher |
| `UserPromptSubmit` | when user submits prompt | no matcher |

### 1.4 exit code semantics

| exit code | behavior |
|-----------|----------|
| `0` | success, continue |
| `2` | block operation (stderr shown to Claude) |
| other | non-block error, continue |

### 1.5 citations

[1] claude code hooks reference: "Hooks are configured in settings files: `~/.claude/settings.json` - User settings, `.claude/settings.json` - Project settings" — [code.claude.com/docs/en/hooks](https://code.claude.com/docs/en/hooks)

[2] hook configuration structure: "Key fields: `matcher`: Pattern to match tool names (case-sensitive, supports regex). Only for `PreToolUse`, `PermissionRequest`, `PostToolUse`; `hooks`: Array of hook definitions; `type`: Either `\"command\"` (bash) or `\"prompt\"` (LLM-based); `command`: Bash command to execute; `timeout`: Optional timeout in seconds (default: 60)" — [code.claude.com/docs/en/hooks](https://code.claude.com/docs/en/hooks)

[3] exit code behavior: "Exit Code Behavior: `0` Success. `stdout` shown in verbose mode... `2` Block error. Only `stderr` used as error message. JSON in `stdout` ignored. `Other` Non-block error. `stderr` shown in verbose mode. Execution continues." — [code.claude.com/docs/en/hooks](https://code.claude.com/docs/en/hooks)

---

## 2. rhachet Role.hooks interface (npm package)

### 2.1 repository type
- npm package: `rhachet`
- interface: typescript sdk

### 2.2 version requirements

Role.hooks was introduced in rhachet v1.24.0 (January 17, 2026) [4]:
- commit: `feat(hooks): support brain.repl hooks via brain.repl adapters (#148)`
- current version: 1.25.2

### 2.3 contract: Role interface

the `Role` interface includes an optional `hooks` property [5]:

```typescript
export interface Role<TSolid, TRigid> {
  slug: string;
  name: string;
  purpose: string;
  readme: { uri: string };
  traits: RoleTrait[];
  skills: { solid?: TSolid; rigid?: TRigid; dirs: { uri: string } | { uri: string }[]; refs: RoleSkill<any>[] };
  briefs: { dirs: { uri: string } | { uri: string }[] };
  inits?: { dirs?: { uri: string } | { uri: string }[]; exec?: { cmd: string }[] };
  hooks?: RoleHooks;  // <-- new in v1.24.0
}
```

### 2.4 contract: RoleHooks interface

```typescript
export interface RoleHooks {
  onDispatch?: RoleHooksOnDispatch;  // middleware over rhachet dispatch actions
  onBrain?: RoleHooksOnBrain;        // hooks applied to brain repl configs
}
```

[6] RoleHooks documentation: "a container for all hook types a role can declare... distinguishes between two hook categories: `onDispatch` - Middleware over rhachet dispatch actions (interface with callbacks); `onBrain` - Hooks applied to brain repl configs (domain literal with data)"

### 2.5 contract: RoleHooksOnBrain interface

```typescript
export interface RoleHooksOnBrain {
  onBoot?: RoleHookOnBrain[];   // SessionStart equivalent
  onTool?: RoleHookOnBrain[];   // PreToolUse/PostToolUse equivalent
  onStop?: RoleHookOnBrain[];   // Stop equivalent
}
```

[7] RoleHooksOnBrain documentation: "container for hook declarations by event type... separates hooks across three lifecycle moments: `onBoot` - Hooks executed at initialization; `onTool` - Hooks triggered at tool usage; `onStop` - Hooks executed at shutdown"

### 2.6 contract: RoleHookOnBrain interface

```typescript
export interface RoleHookOnBrain {
  command: string;           // command to execute
  timeout: IsoDuration;      // ISO 8601 duration (e.g., "PT60S", "PT5M")
  filter?: BrainHookFilter;  // optional filter for tool-specific hooks
}
```

[8] RoleHookOnBrain documentation: ".what = a single hook declared by a role; .why = author is derived on application from registry + role context; .note = timeout format: ISO 8601 duration (e.g., 'PT60S', 'PT5M')"

### 2.7 contract: BrainHookFilter interface

```typescript
export interface BrainHookFilter {
  what: string;                // filter criteria (e.g., "Bash", "Write|Edit", "*")
  when?: 'before' | 'after';   // time specifier (defaults to "before")
}
```

[9] BrainHookFilter documentation: "`what` (required string): Represents filter criteria for onTool hooks, patterns like 'Bash', 'Write|Edit', or '*'; `when` (optional): Time specifier, default is 'before'"

### 2.8 contract: BrainHookEvent type

```typescript
export type BrainHookEvent = 'onBoot' | 'onTool' | 'onStop';
```

[10] BrainHookEvent documentation: "`onBoot`: Triggers at session initialization, corresponds to SessionStart (claudecode); `onTool`: Executes around tool usage, maps to PreToolUse/PostToolUse (claudecode); `onStop`: Fires at session termination, aligns with Stop (claudecode)"

### 2.9 contract: BrainHook domain entity

the internal representation used by rhachet [11]:

```typescript
export interface BrainHook {
  author: string;            // "repo={registry.slug}/role={role.slug}"
  event: BrainHookEvent;     // 'onBoot' | 'onTool' | 'onStop'
  command: string;           // command to execute
  timeout: IsoDuration;      // ISO 8601 duration
  filter?: BrainHookFilter;  // optional filter
}
```

### 2.10 contract: BrainHooksAdapterDao interface

rhachet uses adapters to apply hooks to brain.repl configurations [12]:

```typescript
export interface BrainHooksAdapterDao {
  get: {
    one(input: { by: { unique: RefByUnique<typeof BrainHook> } }): Promise<BrainHook | null>;
    all(input?: { by?: PickOne<{ author: string; event: BrainHookEvent; command: string }> }): Promise<BrainHook[]>;
  };
  set: {
    findsert(input: { hook: BrainHook }): Promise<BrainHook>;
    upsert(input: { hook: BrainHook }): Promise<BrainHook>;
  };
  del(input: { by: { unique: RefByUnique<typeof BrainHook> } }): Promise<void>;
}
```

### 2.11 citations

[4] rhachet v1.24.0 commit: "feat(hooks): support brain.repl hooks via brain.repl adapters (#148)" — [github.com/ehmpathy/rhachet/commits/main](https://github.com/ehmpathy/rhachet/commits/main), January 17, 2026

[5] Role interface with hooks: "hooks?: RoleHooks - enables role authors to register hooks for dispatch and brain events... onDispatch: middleware for rhachet dispatch actions; onBrain: hooks for brain repl configuration events" — [github.com/ehmpathy/rhachet/blob/main/src/domain.objects/Role.ts](https://github.com/ehmpathy/rhachet/blob/main/src/domain.objects/Role.ts)

[6] RoleHooks documentation — [github.com/ehmpathy/rhachet/blob/main/src/domain.objects/RoleHooks.ts](https://github.com/ehmpathy/rhachet/blob/main/src/domain.objects/RoleHooks.ts)

[7] RoleHooksOnBrain documentation — [github.com/ehmpathy/rhachet/blob/main/src/domain.objects/RoleHooksOnBrain.ts](https://github.com/ehmpathy/rhachet/blob/main/src/domain.objects/RoleHooksOnBrain.ts)

[8] RoleHookOnBrain documentation — [github.com/ehmpathy/rhachet/blob/main/src/domain.objects/RoleHookOnBrain.ts](https://github.com/ehmpathy/rhachet/blob/main/src/domain.objects/RoleHookOnBrain.ts)

[9] BrainHookFilter documentation — [github.com/ehmpathy/rhachet/blob/main/src/domain.objects/BrainHookFilter.ts](https://github.com/ehmpathy/rhachet/blob/main/src/domain.objects/BrainHookFilter.ts)

[10] BrainHookEvent documentation — [github.com/ehmpathy/rhachet/blob/main/src/domain.objects/BrainHookEvent.ts](https://github.com/ehmpathy/rhachet/blob/main/src/domain.objects/BrainHookEvent.ts)

[11] BrainHook documentation: "author (string): Identifies the hook's owner via namespace format, structured as 'repo={registry.slug}/role={role.slug}' for ownership track and declarative sync with namespace isolation" — [github.com/ehmpathy/rhachet/blob/main/src/domain.objects/BrainHook.ts](https://github.com/ehmpathy/rhachet/blob/main/src/domain.objects/BrainHook.ts)

[12] BrainHooksAdapterDao documentation: "DAO interface contract for brain hooks CRUD operations... enables declastruct pattern with idempotent get/set/del semantics" — [github.com/ehmpathy/rhachet/blob/main/src/domain.objects/BrainHooksAdapterDao.ts](https://github.com/ehmpathy/rhachet/blob/main/src/domain.objects/BrainHooksAdapterDao.ts)

---

## 3. best practices

### 3.1 current implementation (to be replaced)

the current implementation uses shell scripts to manipulate `.claude/settings.json` directly [13]:

```bash
# from init.claude.hooks.findsert.sh
HOOK_CONFIG=$(jq -n \
  --arg hookType "$HOOK_TYPE" \
  --arg matcher "$MATCHER" \
  --arg command "$HOOK_COMMAND" \
  --argjson timeout "$TIMEOUT" \
  --arg author "$AUTHOR" \
  '{
    hooks: {
      ($hookType): [
        {
          matcher: $matcher,
          hooks: [{
            type: "command",
            command: $command,
            timeout: $timeout,
            author: $author
          }]
        }
      ]
    }
  }'
)
```

### 3.2 new approach (Role.hooks)

with rhachet's Role.hooks interface, hooks are declared as part of the Role definition [5]:

```typescript
const mechanicRole = Role.typed({
  slug: 'mechanic',
  name: 'Mechanic',
  // ... other properties
  hooks: {
    onBrain: {
      onBoot: [
        {
          command: 'npx rhachet roles boot --repo ehmpathy --role mechanic',
          timeout: 'PT60S',
        },
      ],
      onTool: [
        {
          command: 'npx rhachet run --init claude.hooks/pretooluse.forbid-stderr-redirect',
          timeout: 'PT5S',
          filter: { what: 'Bash', when: 'before' },
        },
      ],
    },
  },
});
```

### 3.3 benefits of Role.hooks approach

1. **declarative** — hooks are defined as data, not imperative shell scripts
2. **portable** — hooks travel with the role definition, not separate init scripts
3. **author-tracked** — rhachet automatically derives `author` from `repo={registry}/role={role}`
4. **idempotent** — rhachet's adapter pattern handles findsert/upsert semantics
5. **maintainable** — no need to maintain jq scripts for json manipulation

### 3.4 migration map

| current (init.claude.hooks.sh) | new (Role.hooks) |
|--------------------------------|------------------|
| `SessionStart` hooks | `hooks.onBrain.onBoot` |
| `PreToolUse` hooks | `hooks.onBrain.onTool` with `filter.when: 'before'` |
| `PostToolUse` hooks | `hooks.onBrain.onTool` with `filter.when: 'after'` |
| `Stop` hooks | `hooks.onBrain.onStop` |
| `--matcher "Bash"` | `filter: { what: 'Bash' }` |
| `--timeout 5` | `timeout: 'PT5S'` |
| `--author "repo=ehmpathy/role=mechanic"` | derived automatically |

### 3.5 citations

[13] current findsert implementation — [src/domain.roles/mechanic/inits/init.claude.hooks.findsert.sh](./src/domain.roles/mechanic/inits/init.claude.hooks.findsert.sh)

---

## 4. implementation requirements

### 4.1 package upgrade

upgrade rhachet to v1.24.0 or later:

```bash
npm install rhachet@^1.24.0
```

### 4.2 role definition changes

add `hooks` property to the mechanic role definition in `getMechanicRole.ts` (or equivalent).

### 4.3 deprecate init scripts

these files can be deprecated after migration:
- `init.claude.hooks.sh`
- `init.claude.hooks.findsert.sh`
- `init.claude.hooks.cleanup.sh`
- `init.claude.hooks.cleanup.repograin.sh`
- `init.claude.hooks.cleanup.localgrain.sh`

### 4.4 rhachet initialization

rhachet's `npx rhachet init` or `roles boot` commands will handle hook registration automatically when the Role includes `hooks` property.

---

## 5. sources

- [Claude Code Hooks Reference](https://code.claude.com/docs/en/hooks)
- [rhachet GitHub Repository](https://github.com/ehmpathy/rhachet)
- [rhachet npm Package](https://www.npmjs.com/package/rhachet)
