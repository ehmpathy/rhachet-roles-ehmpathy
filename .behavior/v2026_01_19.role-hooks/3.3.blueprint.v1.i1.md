# blueprint: Role.hooks migration

## summary

migrate the mechanic role from shell-based hook registration (`init.claude.hooks.sh`) to rhachet's declarative `Role.hooks` interface.

---

## 1. architecture

### 1.1 current state

the mechanic role registers hooks via shell executables:

```
src/domain.roles/mechanic/
├── getMechanicRole.ts          # Role definition (no hooks property)
├── inits/
│   ├── init.claude.sh          # orchestrates all inits
│   ├── init.claude.hooks.sh    # registers 9 hooks via shell
│   ├── init.claude.hooks.findsert.sh
│   └── init.claude.hooks.cleanup.*.sh
```

### 1.2 target state

the mechanic role declares hooks directly on the Role object:

```
src/domain.roles/mechanic/
├── getMechanicRole.ts          # Role definition WITH hooks property
├── inits/
│   ├── init.claude.sh          # orchestrates inits (no hook registration)
│   └── init.claude.permissions.jsonc
```

### 1.3 Role.hooks structure

```typescript
export const ROLE_MECHANIC: Role = Role.build({
  slug: 'mechanic',
  // ... other properties
  hooks: {
    onBrain: {
      onBoot: [
        // SessionStart hooks
      ],
      onTool: [
        // PreToolUse and PostToolUse hooks
      ],
      onStop: [
        // Stop hooks (none currently)
      ],
    },
  },
});
```

---

## 2. hook migration map

### 2.1 SessionStart hooks → onBoot

| current shell registration | new Role.hooks declaration |
|---------------------------|---------------------------|
| `SessionStart` / `notify-permissions` | `{ command: '...notify-permissions', timeout: 'PT5S' }` |
| `SessionStart` / `boot.this` | `{ command: '...boot.this', timeout: 'PT60S' }` |
| `SessionStart` / `boot.mechanic` | `{ command: '...boot.mechanic', timeout: 'PT60S' }` |

### 2.2 PreToolUse hooks → onTool (when: 'before')

| current shell registration | new Role.hooks declaration |
|---------------------------|---------------------------|
| `PreToolUse` / `Bash` / `forbid-stderr-redirect` | `{ ..., filter: { what: 'Bash', when: 'before' } }` |
| `PreToolUse` / `Write\|Edit` / `forbid-terms.gerunds` | `{ ..., filter: { what: 'Write\|Edit', when: 'before' } }` |
| `PreToolUse` / `Write\|Edit` / `forbid-terms.blocklist` | `{ ..., filter: { what: 'Write\|Edit', when: 'before' } }` |
| `PreToolUse` / `Bash` / `check-permissions` | `{ ..., filter: { what: 'Bash', when: 'before' } }` |

### 2.3 complete hooks declaration

```typescript
hooks: {
  onBrain: {
    onBoot: [
      {
        command: './node_modules/.bin/rhachet run --repo ehmpathy --role mechanic --init claude.hooks/sessionstart.notify-permissions',
        timeout: 'PT5S',
      },
      {
        command: './node_modules/.bin/rhachet roles boot --repo .this --role any --if-present',
        timeout: 'PT60S',
      },
      {
        command: './node_modules/.bin/rhachet roles boot --repo ehmpathy --role mechanic',
        timeout: 'PT60S',
      },
    ],
    onTool: [
      {
        command: './node_modules/.bin/rhachet run --repo ehmpathy --role mechanic --init claude.hooks/pretooluse.forbid-stderr-redirect',
        timeout: 'PT5S',
        filter: { what: 'Bash', when: 'before' },
      },
      {
        command: './node_modules/.bin/rhachet run --repo ehmpathy --role mechanic --init claude.hooks/pretooluse.forbid-terms.gerunds',
        timeout: 'PT5S',
        filter: { what: 'Write|Edit', when: 'before' },
      },
      {
        command: './node_modules/.bin/rhachet run --repo ehmpathy --role mechanic --init claude.hooks/pretooluse.forbid-terms.blocklist',
        timeout: 'PT5S',
        filter: { what: 'Write|Edit', when: 'before' },
      },
      {
        command: './node_modules/.bin/rhachet run --repo ehmpathy --role mechanic --init claude.hooks/pretooluse.check-permissions',
        timeout: 'PT5S',
        filter: { what: 'Bash', when: 'before' },
      },
    ],
    onStop: [],
  },
},
```

---

## 3. implementation steps

### 3.1 step 1: upgrade rhachet dependency

```bash
npm install rhachet@^1.24.0
```

verify Role interface includes `hooks?: RoleHooks` property.

### 3.2 step 2: update getMechanicRole.ts

add `hooks` property to the Role definition with all 9 hooks declared.

### 3.3 step 3: update init.claude.sh

remove the call to `init.claude.hooks.sh` — rhachet now handles hook registration via Role.hooks.

### 3.4 step 4: deprecate shell files

mark these files for removal after verification:
- `init.claude.hooks.sh`
- `init.claude.hooks.findsert.sh`
- `init.claude.hooks.cleanup.sh`
- `init.claude.hooks.cleanup.repograin.sh`
- `init.claude.hooks.cleanup.localgrain.sh`

### 3.5 step 5: verify behavior

run `./node_modules/.bin/rhachet roles init --role mechanic` and confirm hooks appear in `.claude/settings.json`.

---

## 4. test coverage

### 4.1 unit tests

**file**: `src/domain.roles/mechanic/getMechanicRole.test.ts`

```typescript
import { given, when, then } from 'test-fns';
import { ROLE_MECHANIC } from './getMechanicRole';

describe('getMechanicRole', () => {
  given('[case1] the mechanic role definition', () => {
    when('[t0] hooks property is accessed', () => {
      then('onBrain.onBoot contains 3 hooks', () => {
        expect(ROLE_MECHANIC.hooks?.onBrain?.onBoot).toHaveLength(3);
      });

      then('onBrain.onTool contains 4 hooks', () => {
        expect(ROLE_MECHANIC.hooks?.onBrain?.onTool).toHaveLength(4);
      });

      then('onBrain.onStop is empty', () => {
        expect(ROLE_MECHANIC.hooks?.onBrain?.onStop).toHaveLength(0);
      });
    });

    when('[t1] onBoot hooks are inspected', () => {
      then('notify-permissions hook is first', () => {
        const hook = ROLE_MECHANIC.hooks?.onBrain?.onBoot?.[0];
        expect(hook?.command).toContain('notify-permissions');
        expect(hook?.timeout).toEqual('PT5S');
      });

      then('boot.this hook is second', () => {
        const hook = ROLE_MECHANIC.hooks?.onBrain?.onBoot?.[1];
        expect(hook?.command).toContain('boot --repo .this');
        expect(hook?.timeout).toEqual('PT60S');
      });

      then('boot.mechanic hook is third', () => {
        const hook = ROLE_MECHANIC.hooks?.onBrain?.onBoot?.[2];
        expect(hook?.command).toContain('boot --repo ehmpathy --role mechanic');
        expect(hook?.timeout).toEqual('PT60S');
      });
    });

    when('[t2] onTool hooks are inspected', () => {
      then('forbid-stderr-redirect targets Bash', () => {
        const hook = ROLE_MECHANIC.hooks?.onBrain?.onTool?.[0];
        expect(hook?.filter?.what).toEqual('Bash');
        expect(hook?.filter?.when).toEqual('before');
      });

      then('forbid-terms.gerunds targets Write|Edit', () => {
        const hook = ROLE_MECHANIC.hooks?.onBrain?.onTool?.[1];
        expect(hook?.filter?.what).toEqual('Write|Edit');
      });

      then('forbid-terms.blocklist targets Write|Edit', () => {
        const hook = ROLE_MECHANIC.hooks?.onBrain?.onTool?.[2];
        expect(hook?.filter?.what).toEqual('Write|Edit');
      });

      then('check-permissions targets Bash', () => {
        const hook = ROLE_MECHANIC.hooks?.onBrain?.onTool?.[3];
        expect(hook?.filter?.what).toEqual('Bash');
      });
    });
  });
});
```

### 4.2 integration tests

**file**: `src/domain.roles/mechanic/getMechanicRole.integration.test.ts`

```typescript
import { given, when, then, useBeforeAll } from 'test-fns';
import * as fs from 'fs/promises';
import * as path from 'path';
import * as os from 'os';
import { execSync } from 'child_process';

describe('getMechanicRole integration', () => {
  given('[case1] a temp directory with role initialized', () => {
    const scene = useBeforeAll(async () => {
      const tempDir = await fs.mkdtemp(path.join(os.tmpdir(), 'role-hooks-test-'));

      // init git repo
      execSync('git init', { cwd: tempDir });

      // create .claude directory
      await fs.mkdir(path.join(tempDir, '.claude'), { recursive: true });
      await fs.writeFile(
        path.join(tempDir, '.claude', 'settings.json'),
        JSON.stringify({}, null, 2),
      );

      return { tempDir };
    });

    afterAll(async () => {
      await fs.rm(scene.tempDir, { recursive: true, force: true });
    });

    when('[t0] rhachet roles init is executed', () => {
      const result = useBeforeAll(async () => {
        execSync('./node_modules/.bin/rhachet roles init --role mechanic', {
          cwd: scene.tempDir,
          env: { ...process.env },
        });

        const settingsPath = path.join(scene.tempDir, '.claude', 'settings.json');
        const settings = JSON.parse(await fs.readFile(settingsPath, 'utf-8'));
        return { settings };
      });

      then('SessionStart hooks are registered', () => {
        expect(result.settings.hooks?.SessionStart).toBeDefined();
        expect(result.settings.hooks?.SessionStart).toHaveLength(3);
      });

      then('PreToolUse hooks are registered', () => {
        expect(result.settings.hooks?.PreToolUse).toBeDefined();
        expect(result.settings.hooks?.PreToolUse.length).toBeGreaterThanOrEqual(4);
      });

      then('hooks have correct author format', () => {
        const hook = result.settings.hooks?.SessionStart?.[0]?.hooks?.[0];
        expect(hook?.author).toMatch(/repo=ehmpathy\/role=mechanic/);
      });
    });
  });
});
```

### 4.3 acceptance tests

**file**: `src/contract/commands/roles/init.acceptance.test.ts`

```typescript
import { given, when, then, useBeforeAll } from 'test-fns';

describe('roles init command acceptance', () => {
  given('[case1] mechanic role with hooks declaration', () => {
    when('[t0] init command completes', () => {
      then('SessionStart:notify-permissions hook fires on session start', async () => {
        // verify via hook output or side effect
      });

      then('PreToolUse:forbid-stderr-redirect blocks stderr redirects', async () => {
        // verify via hook exit code 2 on forbidden pattern
      });

      then('PreToolUse:forbid-terms.gerunds blocks gerunds in Write', async () => {
        // verify via hook exit code 2 on gerund detection
      });
    });
  });

  given('[case2] idempotent hook registration', () => {
    when('[t0] init command runs twice', () => {
      then('hooks are not duplicated', async () => {
        // verify hook count remains stable
      });

      then('hook order is preserved', async () => {
        // verify hook array order matches declaration
      });
    });
  });

  given('[case3] hook cleanup on role removal', () => {
    when('[t0] role is unlinked', () => {
      then('hooks with matched author are removed', async () => {
        // verify hooks with author=repo=ehmpathy/role=mechanic are gone
      });

      then('hooks from other authors remain', async () => {
        // verify other hooks are untouched
      });
    });
  });
});
```

---

## 5. verification checklist

### 5.1 functional verification

- [ ] `./node_modules/.bin/rhachet roles init --role mechanic` registers all 7 hooks
- [ ] hooks appear in `.claude/settings.json` with correct format
- [ ] hooks have `author: "repo=ehmpathy/role=mechanic"` for cleanup
- [ ] re-init does not duplicate hooks (idempotent)
- [ ] SessionStart hooks fire at session boot
- [ ] PreToolUse hooks fire before tool execution
- [ ] hook filters match correct tools (Bash, Write|Edit)

### 5.2 test verification

- [ ] unit tests pass: `npm run test:unit -- getMechanicRole`
- [ ] integration tests pass: `npm run test:integration -- getMechanicRole`
- [ ] acceptance tests pass: `npm run test:acceptance -- roles/init`

### 5.3 deprecation verification

- [ ] `init.claude.hooks.sh` is no longer called
- [ ] `init.claude.hooks.findsert.sh` is no longer needed
- [ ] `init.claude.hooks.cleanup.*.sh` files are no longer needed
- [ ] old files can be safely removed

---

## 6. risks and mitigations

### 6.1 risk: rhachet version incompatibility

**mitigation**: pin rhachet to `^1.24.0` in package.json and verify Role.hooks interface exists before migration.

### 6.2 risk: hook registration order changes

**mitigation**: unit tests verify hook array order matches declaration. integration tests verify `.claude/settings.json` order.

### 6.3 risk: author format mismatch

**mitigation**: verify rhachet derives author as `repo={registry.slug}/role={role.slug}` per documentation.

### 6.4 risk: timeout format errors

**mitigation**: use ISO 8601 duration format (`PT5S`, `PT60S`) as specified in RoleHookOnBrain interface.

---

## 7. rollback plan

if migration fails:

1. revert `getMechanicRole.ts` to remove hooks property
2. restore call to `init.claude.hooks.sh` in `init.claude.sh`
3. keep shell files intact until next attempt

---

## 8. timeline

| step | description |
|------|-------------|
| 1 | upgrade rhachet dependency |
| 2 | add hooks to getMechanicRole.ts |
| 3 | write unit tests |
| 4 | write integration tests |
| 5 | update init.claude.sh |
| 6 | verify all hooks register correctly |
| 7 | write acceptance tests |
| 8 | deprecate shell files |
| 9 | remove deprecated files |
