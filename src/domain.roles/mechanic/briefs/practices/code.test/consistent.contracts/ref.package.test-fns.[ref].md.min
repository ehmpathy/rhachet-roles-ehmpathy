# test-fns

![ci_on_commit](https://github.com/ehmpathy/test-fns/workflows/ci_on_commit/badge.svg)
![deploy_on_tag](https://github.com/ehmpathy/test-fns/workflows/deploy_on_tag/badge.svg)

write usecase-driven tests for simpler, safer code.

# purpose

establishes pattern for tests via given, when, then.
tests are simpler, easier to read, safer.

# install

```sh
npm install --save test-fns
```

# use

```ts
type Plant = { id: number, hydration: 'DRY' | 'WET' };
const doesPlantNeedWater = (plant: Plant) => plant.hydration === 'DRY';

describe('doesPlantNeedWater', () => {
  given('a plant', () => {
    when('the plant doesnt have enough water', () => {
      const plant: Plant = { id: 7, hydration: 'DRY' };
      then('it should return true', () => {
        expect(doesPlantNeedWater(plant)).toEqual(true)
      })
    })
  })
})
```

produces:

```sh
 PASS  src/givenWhenThen.test.ts
  doesPlantNeedWater
    given: a plant
      when: the plant doesnt have enough water
        âœ“ then: it should return true (1 ms)
```

# features

### .runif(condition) && .skipif(condition)

skip suite if condition not met.

```ts
describe('your test', () => {
  given.runIf(onLocalMachine)('some test that should only run locally', () => {
    then.skipIf(onProduction)('some test that should not run against production', () => {
      expect(onProduction).toBeFalse()
    })
  })
})
```

### useprep

prepare scenarios asynchronously in given/when blocks.
modes: 'beforeall' (default, runs once), 'beforeeach' (runs fresh per test).

```ts
given('an overdue invoice', () => {
  const invoice = usePrep(async () => await ... // your logic);
  then('it should invoke a reminder', async () => {
    const result = await nurtureInvoice({ invoice }, context);
    expect(result.sent.reminder).toEqual(true)
  })
})
```

usebeforeall and usebeforeeach are shortcuts for useprep with specific modes.

### usebeforeall

prepare resources once for all tests in suite.

```ts
describe('spaceship refuel system', () => {
  given('a spaceship that needs to refuel', () => {
    const spaceship = useBeforeAll(async () => {
      const ship = await prepareExampleSpaceship();
      await ship.dock();
      return ship;
    });
    when('no changes are made', () => {
      then('it should be docked', async () => expect(spaceship.isDocked).toEqual(true));
      then('it should need fuel', async () => expect(spaceship.fuelLevel).toBeLessThan(spaceship.fuelCapacity));
    });
  });
});
```

### usebeforeeach

prepare fresh resources before each test for isolation.

```ts
describe('spaceship combat system', () => {
  given('a spaceship in battle', () => {
    const spaceship = useBeforeEach(async () => {
      const ship = await prepareExampleSpaceship();
      await ship.resetShields();
      return ship;
    });
    when('no changes are made', () => {
      then('it should have full shields', async () => expect(spaceship.shields).toEqual(100));
    });
  });
});
```

**when to use:**
- usebeforeall: for expensive setups that don't change.
- usebeforeeach: for tests that modify resources.
- useprep: for explicit mode control.