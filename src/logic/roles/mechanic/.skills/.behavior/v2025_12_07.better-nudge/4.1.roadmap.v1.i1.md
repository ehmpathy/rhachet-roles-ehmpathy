# Roadmap: Better Permission Nudge Reporting

## Overview

Execute the blueprint in `3.3.blueprint.v1.i1.md` to transform permission pattern output from raw `:*` notation to compact `[e]`/`[p]` bracket notation with legend.

---

## Checklist

### Step 1: Add `format_pattern` function

- [ ] **1.1** Open `src/logic/roles/mechanic/.skills/claude.hooks/check.pretooluse.permissions.sh`
- [ ] **1.2** Add `format_pattern()` function after `match_pattern()` (around line 122):
  ```bash
  format_pattern() {
    local pattern="$1"
    if [[ "$pattern" == *":*" ]]; then
      local prefix="${pattern%:*}"
      echo "[p]: $prefix"
    else
      echo "[e]: $pattern"
    fi
  }
  ```

**Acceptance Criteria:**
- Function exists and is syntactically valid

**Verification:**
```bash
bash -n src/logic/roles/mechanic/.skills/claude.hooks/check.pretooluse.permissions.sh
# Expected: no output (syntax OK)
```

---

### Step 2: Update SOFTNUDGE output

Depends on: Step 1

- [ ] **2.1** Locate SOFTNUDGE pattern output loop (around line 140-142)
- [ ] **2.2** Add legend before pattern list:
  ```bash
  echo "([e] = exact match, [p] = prefix match)"
  echo ""
  ```
- [ ] **2.3** Change pattern echo to use `format_pattern`:
  ```bash
  echo "  • $(format_pattern "$pattern")"
  ```
- [ ] **2.4** Add legend after pattern list:
  ```bash
  echo ""
  echo "([e] = exact match, [p] = prefix match)"
  ```

**Acceptance Criteria:**
- SOFTNUDGE output shows legend before and after pattern list
- Patterns display as `[p]: <prefix>` or `[e]: <command>`

**Verification:**
```bash
# Create test settings and trigger SOFTNUDGE
cd /tmp && mkdir -p .claude
echo '{"permissions":{"allow":["Bash(npm run test:*)","Bash(cat:*)","Bash(npm run lint)"]}}' > .claude/settings.local.json
echo '{"tool_name":"Bash","tool_input":{"command":"unknown-cmd"}}' | \
  bash src/logic/roles/mechanic/.skills/claude.hooks/check.pretooluse.permissions.sh --mode SOFTNUDGE 2>&1 | \
  grep -E '\[p\]:|\[e\]:|\[e\] = exact'
# Expected: matches for [p]:, [e]:, and legend text
```

---

### Step 3: Update HARDNUDGE output

Depends on: Step 1

- [ ] **3.1** Locate HARDNUDGE pattern output loop (around line 185-187)
- [ ] **3.2** Add legend before pattern list:
  ```bash
  echo "([e] = exact match, [p] = prefix match)"
  echo ""
  ```
- [ ] **3.3** Change pattern echo to use `format_pattern`:
  ```bash
  echo "  • $(format_pattern "$pattern")"
  ```
- [ ] **3.4** Add legend after pattern list:
  ```bash
  echo ""
  echo "([e] = exact match, [p] = prefix match)"
  ```

**Acceptance Criteria:**
- HARDNUDGE output shows legend before and after pattern list
- Patterns display as `[p]: <prefix>` or `[e]: <command>`

**Verification:**
```bash
# Trigger HARDNUDGE (first attempt blocks)
cd /tmp
rm -f .claude/permission.nudges.local.json
echo '{"tool_name":"Bash","tool_input":{"command":"unknown-cmd"}}' | \
  bash src/logic/roles/mechanic/.skills/claude.hooks/check.pretooluse.permissions.sh 2>&1 | \
  grep -E '\[p\]:|\[e\]:|\[e\] = exact'
# Expected: matches for [p]:, [e]:, and legend text
```

---

### Step 4: Update test assertions

Depends on: Steps 2, 3

- [ ] **4.1** Open `src/logic/roles/mechanic/.skills/claude.hooks/check.pretooluse.permissions.test.sh`
- [ ] **4.2** Line 231: Change `"npm run test:"` to `"[p]: npm run test"`
- [ ] **4.3** Line 239: Change `"npm run fix:"` to `"[p]: npm run fix"`

**Acceptance Criteria:**
- Test assertions match new output format

**Verification:**
```bash
bash -n src/logic/roles/mechanic/.skills/claude.hooks/check.pretooluse.permissions.test.sh
# Expected: no output (syntax OK)
```

---

### Step 5: Run full test suite

Depends on: Steps 1, 2, 3, 4

- [ ] **5.1** Execute test script

**Acceptance Criteria:**
- All tests pass
- No regressions

**Verification:**
```bash
bash src/logic/roles/mechanic/.skills/claude.hooks/check.pretooluse.permissions.test.sh
# Expected: "Results: X passed, 0 failed"
```

---

### Step 6: Manual integration test

Depends on: Step 5

- [ ] **6.1** In a real Claude Code session, trigger a blocked command
- [ ] **6.2** Verify output shows `[p]:` and `[e]:` notation with legend

**Acceptance Criteria:**
- Claude Code agent receives the new format
- Agent correctly interprets patterns (e.g., uses `npm run build` when `[p]: npm run build` is available)

**Verification:**
- Visual inspection of hook output in Claude Code session
- Agent behavior matches expected interpretation

---

## Summary

| Step | Description | Depends On |
|------|-------------|------------|
| 1 | Add `format_pattern` function | - |
| 2 | Update SOFTNUDGE output | 1 |
| 3 | Update HARDNUDGE output | 1 |
| 4 | Update test assertions | 2, 3 |
| 5 | Run full test suite | 1, 2, 3, 4 |
| 6 | Manual integration test | 5 |
