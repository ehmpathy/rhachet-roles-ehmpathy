# Research: Claude Code Permission Patterns

## Context

The wish in `0.wish.md` describes a problem where the `:*` wildcard pattern in Claude Code's permission system is causing confusion. When the hook reports `npm run build:*` as an available pattern, Claude Code interprets `:*` too literally, attempting to run commands like `npm run build:ts` instead of `npm run build`.

---

## Key Findings

### 1. How Claude Code Treats Permissions

Claude Code uses **prefix matching** for Bash permission patterns, NOT regex or glob patterns.

> [1] "This tool uses **prefix matches**, not regex or glob patterns"
> — [Claude Code IAM Documentation](https://code.claude.com/docs/en/iam)

> [2] "Bash rules use prefix matching, not regex"
> — [Claude Code Settings Documentation](https://code.claude.com/docs/en/settings)

Permission rules follow the format: `Tool(optional-specifier)`. A rule without a specifier matches any use of that tool.

> [3] "A rule that is just the tool name matches any use of that tool. For example, adding `Bash` to the list of allow rules would allow Claude Code to use the Bash tool without requiring user approval."
> — [Claude Code Settings Documentation](https://code.claude.com/docs/en/settings)

---

### 2. What `:*` Means

The `:*` is a **suffix wildcard** that matches "any continuation" after the prefix.

> [4] "The wildcard `:*` only works at the end of a pattern to match any continuation"
> — [Claude Code IAM Documentation](https://code.claude.com/docs/en/iam)

Examples from documentation:
- `Bash(npm run test:*)` — matches Bash commands **starting with** `npm run test`
- `Bash(git:*)` — matches Bash commands **starting with** `git`

**Critical insight**: The pattern `npm run test:*` matches `npm run test`, `npm run test:unit`, `npm run test:integration`, etc. — anything that **starts with** `npm run test`.

> [5] "With `"Bash(npm:*)"`, Claude Code can run: `npm install`, `npm run dev`, `npm clean`, etc."
> — [ClaudeLog - Allowed Tools Documentation](https://claudelog.com/faqs/what-is-allowed-tools-in-claude-code/)

---

### 3. How to Represent True Wildcards

**True wildcard rules are not supported.** There is no way to match arbitrary patterns in the middle of a command.

> [6] "We don't support true wildcard rules. You can allow all Bash commands by adding `Bash` as an allow rule."
> — Robert Boyce, Anthropic Contributor, [GitHub Issue #1569](https://github.com/anthropics/claude-code/issues/1569)

For MCP tools, the same limitation applies:

> [7] "The correct syntax here is `mcp__atlassian`. Permission rules do not support wildcards."
> — Robert Boyce, Anthropic Contributor, [GitHub Issue #3107](https://github.com/anthropics/claude-code/issues/3107)

**Options for broad permissions:**
1. Use just the tool name: `Bash` allows ALL bash commands
2. Use `--dangerously-skip-permissions` flag (not recommended for production)
3. Use the `--permission-prompt-tool` for custom logic

---

### 4. Known Bugs and Limitations

The `:*` pattern matching has **known bugs** where it fails to match certain argument combinations:

> [8] "The permission pattern `Bash(gh pr view :*)` in `~/.claude/settings.json` fails to match commands that include the `--json` flag with comma-separated values."
> — [GitHub Issue #11150](https://github.com/anthropics/claude-code/issues/11150)

Prefix matching can be bypassed:

> [9] "Patterns like `Bash(curl http://github.com/:*)` can be bypassed in many ways: Options before URL (`curl -X GET http://github.com/...`) won't match, different protocols won't match, redirects and variables won't match, and extra spaces won't match."
> — [Claude Code IAM Documentation](https://code.claude.com/docs/en/iam)

However, Claude Code is aware of shell operators:

> [10] "Claude Code is aware of shell operators (like `&&`) so a prefix match rule like `Bash(safe-cmd:*)` won't give it permission to run the command `safe-cmd && other-cmd`"
> — [Claude Code IAM Documentation](https://code.claude.com/docs/en/iam)

---

## The Problem with Current Hook Reporting

The current hook at `check.pretooluse.permissions.sh` displays patterns like:
```
• npm run build:*
• cat:*
```

This creates confusion because:

1. Claude Code interprets `npm run build:*` as "I must use a command that starts with `npm run build:`" (note the colon)
2. It then tries `npm run build:ts` even when `npm run build` would work
3. Similarly, `cat:*` leads Claude to try `cat: xyz` (with the colon as part of the command)

**The actual meaning is:**
- `npm run build:*` matches ANY command starting with `npm run build` (including `npm run build` itself)
- The `:*` is a **notation in Claude Code's permission syntax**, not a literal character pattern

---

## Recommendations

### Option A: Clarify the Notation in Hook Output

When reporting patterns, explain what they mean:

```
• npm run build:*  (matches: npm run build, npm run build:ts, npm run build:anything)
• cat:*            (matches: cat, cat foo.txt, cat --help)
```

### Option B: Show Equivalent Human-Readable Form

```
• Any command starting with "npm run build"
• Any command starting with "cat"
```

### Option C: Add Explicit Documentation

```
NOTE: The `:*` suffix means "matches any continuation".
      Pattern "foo:*" matches: foo, foobar, foo-anything, foo:whatever

Available patterns:
• npm run build:*
• cat:*
```

### Option D: Use Compact Bracket Notation with Legend (Recommended)

Transform the permission patterns into compact bracket notation with a legend:

**For patterns with `:*` suffix (prefix matching):**
```
• [p]: npm run build
• [p]: cat
• [p]: git
```

**For patterns without `:*` suffix (exact matching):**
```
• [e]: npx rhachet roles boot --repo ehmpathy --role mechanic
• [e]: npm run lint
```

**Why this is better:**
1. **Unambiguous**: Brackets visually separate the matcher type from the command
2. **Token-efficient**: Single character labels `[e]` and `[p]` minimize output size
3. **No confusion**: Agent sees the actual command without wrapping that could be misinterpreted as executable
4. **Distinguishes match types**: Legend makes it clear what each label means
5. **Redundancy**: Legend appears before and after the list for clarity

**Example hook output:**
```
Before requesting user approval, check if you can accomplish this task using one of these pre-approved patterns:

([e] = exact match, [p] = prefix match)

  • [p]: npm run build
  • [p]: cat
  • [e]: npm run lint

([e] = exact match, [p] = prefix match)
```

---

## Citations

1. Claude Code IAM Documentation — https://code.claude.com/docs/en/iam — "This tool uses **prefix matches**, not regex or glob patterns"

2. Claude Code Settings Documentation — https://code.claude.com/docs/en/settings — "Bash rules use prefix matching, not regex"

3. Claude Code Settings Documentation — https://code.claude.com/docs/en/settings — "A rule that is just the tool name matches any use of that tool. For example, adding `Bash` to the list of allow rules would allow Claude Code to use the Bash tool without requiring user approval."

4. Claude Code IAM Documentation — https://code.claude.com/docs/en/iam — "The wildcard `:*` only works at the end of a pattern to match any continuation"

5. ClaudeLog - Allowed Tools Documentation — https://claudelog.com/faqs/what-is-allowed-tools-in-claude-code/ — "With `"Bash(npm:*)"`, Claude Code can run: `npm install`, `npm run dev`, `npm clean`, etc."

6. GitHub Issue #1569, Robert Boyce (Anthropic) — https://github.com/anthropics/claude-code/issues/1569 — "We don't support true wildcard rules. You can allow all Bash commands by adding `Bash` as an allow rule."

7. GitHub Issue #3107, Robert Boyce (Anthropic) — https://github.com/anthropics/claude-code/issues/3107 — "The correct syntax here is `mcp__atlassian`. Permission rules do not support wildcards."

8. GitHub Issue #11150 — https://github.com/anthropics/claude-code/issues/11150 — "The permission pattern `Bash(gh pr view :*)` in `~/.claude/settings.json` fails to match commands that include the `--json` flag with comma-separated values."

9. Claude Code IAM Documentation — https://code.claude.com/docs/en/iam — "Patterns like `Bash(curl http://github.com/:*)` can be bypassed in many ways: Options before URL (`curl -X GET http://github.com/...`) won't match, different protocols won't match, redirects and variables won't match, and extra spaces won't match."

10. Claude Code IAM Documentation — https://code.claude.com/docs/en/iam — "Claude Code is aware of shell operators (like `&&`) so a prefix match rule like `Bash(safe-cmd:*)` won't give it permission to run the command `safe-cmd && other-cmd`"
