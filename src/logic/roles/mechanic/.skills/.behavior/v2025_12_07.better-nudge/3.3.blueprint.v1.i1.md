# Blueprint: Better Permission Nudge Reporting

## Objective

Update `check.pretooluse.permissions.sh` to report permission patterns using clear semantic function names (`hasPrefix`, `isExactly`) instead of the raw `:*` notation that causes Claude Code to misinterpret the patterns.

---

## Current Behavior

The hook extracts patterns like `Bash(npm run build:*)` from settings and displays them as:
```
â€¢ npm run build:*
â€¢ cat:*
```

Claude Code then interprets `:*` literally, attempting commands like `npm run build:ts` or `cat: xyz` instead of recognizing that `npm run build` itself matches the pattern.

---

## Proposed Behavior

Transform patterns using compact bracket notation with a legend:

| Raw Pattern | Display As |
|-------------|------------|
| `npm run build:*` | `[p]: npm run build` |
| `cat:*` | `[p]: cat` |
| `npm run lint` | `[e]: npm run lint` |

The legend `([e] = exact match, [p] = prefix match)` is displayed before and after the pattern list for clarity.

---

## Implementation

### Location

`src/logic/roles/mechanic/.skills/claude.hooks/check.pretooluse.permissions.sh`

### Changes

**1. Add a pattern transformation function**

After the `match_pattern()` function (around line 122), add:

```bash
# Transform raw permission pattern to compact bracket notation
format_pattern() {
  local pattern="$1"

  # Check if pattern ends with :*
  if [[ "$pattern" == *":*" ]]; then
    # Remove :* suffix and format with [p]: label (prefix match)
    local prefix="${pattern%:*}"
    echo "[p]: $prefix"
  else
    # Exact match - format with [e]: label
    echo "[e]: $pattern"
  fi
}
```

**2. Update SOFTNUDGE output (around line 140-142)**

Change:
```bash
for pattern in "${ALLOWED_PATTERNS[@]}"; do
  echo "  â€¢ $pattern"
done
```

To:
```bash
for pattern in "${ALLOWED_PATTERNS[@]}"; do
  echo "  â€¢ $(format_pattern "$pattern")"
done
```

**3. Update HARDNUDGE output (around line 185-187)**

Same change:
```bash
for pattern in "${ALLOWED_PATTERNS[@]}"; do
  echo "  â€¢ $(format_pattern "$pattern")"
done
```

---

## Example Output

### Before
```
ðŸ›‘ BLOCKED: This command is not covered by existing pre-approved permissions.

Before requesting user approval, check if you can accomplish this task using one of these pre-approved patterns:

  â€¢ npm run build:*
  â€¢ cat:*
  â€¢ npx rhachet roles boot --repo ehmpathy --role mechanic

If an existing permission pattern can solve your task, use that instead.
If you've considered the alternatives and still need this specific command, retry it.
```

### After
```
ðŸ›‘ BLOCKED: This command is not covered by existing pre-approved permissions.

Before requesting user approval, check if you can accomplish this task using one of these pre-approved patterns:

([e] = exact match, [p] = prefix match)

  â€¢ [p]: npm run build
  â€¢ [p]: cat
  â€¢ [e]: npx rhachet roles boot --repo ehmpathy --role mechanic

([e] = exact match, [p] = prefix match)

If an existing permission pattern can solve your task, use that instead.
If you've considered the alternatives and still need this specific command, retry it.
```

---

## Testing

1. Configure `.claude/settings.local.json` with mixed patterns:
   ```json
   {
     "permissions": {
       "allow": [
         "Bash(npm run build:*)",
         "Bash(cat:*)",
         "Bash(npm run lint)"
       ]
     }
   }
   ```

2. Trigger the hook with an unmatched command

3. Verify output shows:
   - `[p]: npm run build` for wildcard patterns
   - `[e]: npm run lint` for exact patterns
   - Legend `([e] = exact match, [p] = prefix match)` before and after list

---

## Test Updates

### Location

`src/logic/roles/mechanic/.skills/claude.hooks/check.pretooluse.permissions.test.sh`

### Changes

Update assertions that check for pattern output to use the new format:

**Line 231** - Change:
```bash
assert_output_contains "$output" "npm run test:" "npx prettier shows available patterns"
```
To:
```bash
assert_output_contains "$output" "[p]: npm run test" "npx prettier shows available patterns"
```

**Line 239** - Change:
```bash
assert_output_contains "$output" "npm run fix:" "curl shows npm run fix pattern"
```
To:
```bash
assert_output_contains "$output" "[p]: npm run fix" "curl shows npm run fix pattern"
```

---

## Files Modified

- `src/logic/roles/mechanic/.skills/claude.hooks/check.pretooluse.permissions.sh`
- `src/logic/roles/mechanic/.skills/claude.hooks/check.pretooluse.permissions.test.sh`
